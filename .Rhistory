load(here("data", "mortagg.Rdata"))
rm(list=ls())
# Install pacman if not installed already, and activate it
if (!require("pacman")) install.packages("pacman")
# Install, update and activate libraries
pacman::p_load(
here,
rio,
skimr,
tsibble,
ISOweek,
slider,    # for rolling means
pander,
tidyverse
)
# Create tsa_theme
tsa_theme <- theme_bw() +
theme(
plot.title = element_text(face = "bold",
size = 12),
legend.background = element_rect(fill = "white",
size = 4,
colour = "white"),
legend.justification = c(0, 1),
legend.position = "bottom",
panel.grid.minor = element_blank()
)
rm(list=ls())
# Install pacman if not installed already, and activate it
if (!require("pacman")) install.packages("pacman")
# Install, update and activate libraries
pacman::p_load(
here,
rio,
skimr,
tsibble,
ISOweek,
slider,    # for rolling means
pander,
tidyverse
)
# Create tsa_theme
tsa_theme <- theme_bw() +
theme(
plot.title = element_text(face = "bold",
size = 12),
legend.background = element_rect(fill = "white",
size = 4,
colour = "white"),
legend.justification = c(0, 1),
legend.position = "bottom",
panel.grid.minor = element_blank()
)
load(here("data", "mortagg.Rdata"))
load(here("data", "mortagg2.Rdata"))
# Install pacman if not installed already, and activate it
if (!require("pacman")) install.packages("pacman")
# Install, update and activate libraries
pacman::p_load(
here,
rio,
skimr,
tsibble,
TSA,
patchwork,
gtsummary,
ciTools,
tidyverse
)
# Create tsa_theme from previous exercise
tsa_theme <- theme_bw() +
theme(
plot.title = element_text(face = "bold",
size = 12),
legend.background = element_rect(fill = "white",
size = 4,
colour = "white"),
# legend.justification = c(0, 1),
legend.position = "bottom",
panel.grid.minor = element_blank()
)
aragon <- import(here("data", "aragon.csv"))
# Create ts dataframe with yearweek index
aragon_ts <- aragon %>%
mutate(
year_week = make_yearweek(year = year, week = week),
index = seq.int(from = 1, to = nrow(aragon))
) %>%
as_tsibble(index = index)
# Temperature plot
aragon_ts_tmax_plot <- ggplot(data = aragon_ts) +
geom_point(mapping = aes(x = year_week, y = tmax), colour = "blue", alpha = 0.5) +
scale_y_continuous(limits = c(0, NA)) +
scale_x_yearweek(date_labels = "%Y-%W",
date_breaks = "1 year") +
labs(x = "Week",
y = "Maximum Temperature") +
tsa_theme
# Mortality plot
aragon_ts_cases_plot <- ggplot(data = aragon_ts) +
geom_point(mapping = aes(x = year_week, y = cases), colour = "green", alpha = 0.5) +
scale_y_continuous(limits = c(0, NA)) +
scale_x_yearweek(date_labels = "%Y-%W",
date_breaks = "1 year") +
labs(x = "Week",
y = "Weekly case counts") +
tsa_theme
# Using patchwork to join the two plots
# The "/" determines an above/below display
aragon_ts_two_plot <- (aragon_ts_tmax_plot / aragon_ts_cases_plot)
aragon_ts_two_plot
aragon_ts <- aragon_ts %>%
mutate(sin52 = sin(2 * pi * date / 52),
cos52 = cos(2 * pi * date / 52))
aragmodel1 <- glm(cases ~ index + sin52 + cos52,
family = "poisson",
data = aragon_ts)
ggplot(data = aragon_ts) +
geom_point(mapping = aes(x = year_week, y = cases), alpha = 0.2) +
geom_line(mapping = aes(x = year_week, y = aragmodel1$fitted.values),
colour = "darkorange",
alpha = 0.7,
lwd = 1.5) +
scale_y_continuous(limits = c(0, NA)) +
scale_x_yearweek(date_labels = "%Y-%W",
date_breaks = "1 year") +
labs(x = "Week",
y = "Weekly case counts",
title = "Cases with fitted trend") +
tsa_theme
aragon_ts <- aragon_ts %>%
mutate(winter = (week >= 49 | week <= 8))
# Model with only main effect
aragmodel2 <- glm(cases ~ index + sin52 + cos52 + tmax,
family = "poisson",
data = aragon_ts)
# Model with temperature interaction
aragmodel3 <- glm(cases ~ index + sin52 + cos52 + winter * tmax,
family = "poisson",
data = aragon_ts)
# Easiest, most direct way
AIC(aragmodel2); AIC(aragmodel3)
tbl_m2 <- aragmodel2 %>%
tbl_regression(exponentiate = TRUE,
estimate_fun = ~style_number(.x, digits = 4)) %>%
add_glance_table(include = c(AIC, BIC, deviance))
tbl_m3 <- aragmodel3 %>%
tbl_regression(exponentiate = TRUE,
estimate_fun = ~style_number(.x, digits = 4)) %>%
add_glance_table(include = c(AIC, BIC, deviance))
tbl_m2m3 <-
tbl_merge(
tbls = list(tbl_m2, tbl_m3),
tab_spanner = c("aragmodel2", "aragmodel3")
)
tbl_m2m3
# Model with only main effect
aragmodel2 <- glm(cases ~ index + sin52 + cos52 + winter,
family = "poisson",
data = aragon_ts)
# Model with temperature interaction
aragmodel3 <- glm(cases ~ index + sin52 + cos52 + winter * tmax,
family = "poisson",
data = aragon_ts)
# Easiest, most direct way
AIC(aragmodel2); AIC(aragmodel3)
tbl_m2 <- aragmodel2 %>%
tbl_regression(exponentiate = TRUE,
estimate_fun = ~style_number(.x, digits = 4)) %>%
add_glance_table(include = c(AIC, BIC, deviance))
tbl_m3 <- aragmodel3 %>%
tbl_regression(exponentiate = TRUE,
estimate_fun = ~style_number(.x, digits = 4)) %>%
add_glance_table(include = c(AIC, BIC, deviance))
tbl_m2m3 <-
tbl_merge(
tbls = list(tbl_m2, tbl_m3),
tab_spanner = c("aragmodel2", "aragmodel3")
)
tbl_m2m3
# Model with only main effect
aragmodel2 <- glm(cases ~ index + sin52 + cos52 + tmax,
family = "poisson",
data = aragon_ts)
# Model with temperature interaction
aragmodel3 <- glm(cases ~ index + sin52 + cos52 + winter * tmax,
family = "poisson",
data = aragon_ts)
tbl_m2 <- aragmodel2 %>%
tbl_regression(exponentiate = TRUE,
estimate_fun = ~style_number(.x, digits = 4)) %>%
add_glance_table(include = c(AIC, BIC, deviance))
tbl_m3 <- aragmodel3 %>%
tbl_regression(exponentiate = TRUE,
estimate_fun = ~style_number(.x, digits = 4)) %>%
add_glance_table(include = c(AIC, BIC, deviance))
tbl_m2m3 <-
tbl_merge(
tbls = list(tbl_m2, tbl_m3),
tab_spanner = c("aragmodel2", "aragmodel3")
)
tbl_m2m3
# Easiest, most direct way
AIC(aragmodel2); AIC(aragmodel3)
# Model with only main effect
aragmodel2 <- glm(cases ~ index + sin52 + cos52 + tmax,
family = "poisson",
data = aragon_ts)
# Model with temperature interaction
aragmodel3 <- glm(cases ~ index + sin52 + cos52 + winter * tmax,
family = "poisson",
data = aragon_ts)
# Easiest, most direct way
AIC(aragmodel2); AIC(aragmodel3)
tbl_m2 <- aragmodel2 %>%
tbl_regression(exponentiate = TRUE,
estimate_fun = ~style_number(.x, digits = 4)) %>%
add_glance_table(include = c(AIC, BIC, deviance))
tbl_m3 <- aragmodel3 %>%
tbl_regression(exponentiate = TRUE,
estimate_fun = ~style_number(.x, digits = 4)) %>%
add_glance_table(include = c(AIC, BIC, deviance))
tbl_m2m3 <-
tbl_merge(
tbls = list(tbl_m2, tbl_m3),
tab_spanner = c("aragmodel2", "aragmodel3")
)
tbl_m2m3
# Easiest, most direct way
AIC(aragmodel2); AIC(aragmodel3)
# Create lag variable
aragon_ts <- aragon_ts %>%
mutate(L1.tmax = dplyr::lag(x = tmax, n = 1))
aragmodel4 <- glm(cases ~ index + sin52 + cos52 + winter * tmax + L1.tmax,
family = "poisson",
data = aragon_ts)
tbl_m4 <- aragmodel4 %>%
tbl_regression(exponentiate = TRUE,
estimate_fun = ~style_number(.x, digits = 4)) %>%
add_glance_table(include = c(AIC, BIC, deviance))
tbl_m3m4 <-
tbl_merge(
tbls = list(tbl_m3, tbl_m4),
tab_spanner = c("aragmodel3", "aragmodel4")
)
tbl_m3m4
## winter subset
aragon_ts.winter <-
aragon_ts %>%
filter(winter == TRUE)
## not winter subset
aragon_ts.notwinter <-
aragon_ts %>%
filter(winter == FALSE)
summary(aragmodel4)

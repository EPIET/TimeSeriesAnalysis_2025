cos26 = cos(2 * pi * Date / 26)) %>%
as_tsibble(index = date_index)
# Model with trend and seasonality
sine2cos2trendmodel <- glm(cases ~ sin52 + cos52 + sin26 + cos26 + Date,
family = "poisson",
data = mortz)
# Create tsa_theme from previous exercise
tsa_theme <- theme_bw() +
theme(
plot.title = element_text(face = "bold",
size = 12),
legend.background = element_rect(fill = "white",
size = 4,
colour = "white"),
# legend.justification = c(0, 1),
legend.position = "bottom",
panel.grid.minor = element_blank()
)
View(mortagg)
View(mortagg)
# Practical 10
rota <- import(here("_temporal conversion files/rotavirus.dta"))
pacman::p_load(tidyverse, rio, here)
# Practical 10
rota <- import(here("_temporal conversion files/rotavirus.dta"))
View(rota)
## convert to long format
rota_lg <-
pivot_longer(
data = rota,
cols = -c(year, week),
names_to = "cases_cat",
values_to = "n"
)
View(rota_lg)
write_csv2(rota, here("data", "rotavirus.csv"))
rota <- import(here("data", "rotavirus.csv"))
## recode
rota_lg <-
rota_lg %>%
mutate(cases_cat = case_when(
cases_cat == "case1" ~ "Cases <1 year",
cases_cat == "case2" ~ "Cases 1 to 4 years",
cases_cat == "case3" ~ "Cases 5 to 14 years",
cases_cat == "case4" ~ "Cases 15 to 64 years",
cases_cat == "case5" ~ "Cases 65+ years",
cases_cat == "cases" ~ "Total cases",
TRUE ~ NA_character_
))
str(rota_lg)
rota_lg <-
rota_lg %>%
mutate(date_index = make_yearweek(year = year, week = week)) %>%
as_tsibble(index = date_index, key = cases_cat)
# Install pacman if not installed already, and activate it
if (!require("pacman")) install.packages("pacman")
# Install, update and activate libraries
pacman::p_load(
here,
rio,
skimr,
tsibble,
TSA,
tidyverse
)
rota_lg <-
rota_lg %>%
mutate(date_index = make_yearweek(year = year, week = week)) %>%
as_tsibble(index = date_index, key = cases_cat)
ggplot(data = rota_lg) +
geom_point(mapping = aes(x = date_index, y = n), alpha = 0.3) +
facet_wrap(facets = vars(cases_cat), scales = "free_y") +
scale_y_continuous(limits = c(0, NA)) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
labs(
x = "Year", y = "Weekly case counts",
title = "Rotavirus cases\n(note differing y scales)"
) +
tsa_theme
# Function to tidy Poisson regression output
# The glmtidy function formats R glm regression output more simply
glmtidy <- function(x, caption = ''){
pander::pander(broom::tidy(x,
exponentiate = TRUE,
conf.int = TRUE),
caption = caption)
}
# Function to tidy Poisson regression statistics
# The glmstats function tabulates key model-associated statistics
glmstats <- function(x){
pander::pander(broom::glance(x))
}
# Create tsa_theme from previous exercise
tsa_theme <- theme_bw() +
theme(
plot.title = element_text(face = "bold",
size = 12),
legend.background = element_rect(fill = "white",
size = 4,
colour = "white"),
# legend.justification = c(0, 1),
legend.position = "bottom",
panel.grid.minor = element_blank()
)
rota_lg <-
rota_lg %>%
mutate(date_index = make_yearweek(year = year, week = week)) %>%
as_tsibble(index = date_index, key = cases_cat)
ggplot(data = rota_lg) +
geom_point(mapping = aes(x = date_index, y = n), alpha = 0.3) +
facet_wrap(facets = vars(cases_cat), scales = "free_y") +
scale_y_continuous(limits = c(0, NA)) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
labs(
x = "Year", y = "Weekly case counts",
title = "Rotavirus cases\n(note differing y scales)"
) +
tsa_theme
rotaz <-
rota_lg %>%
mutate(
vaccine = case_when(
year >= 2014 ~ 1,
year <= 2012 ~ 0,
year == 2013 & week >= 27 ~ 1,
year == 2013 & week < 27 ~ 0,
TRUE ~ NA_real_
),
Date = rep(
x = seq.int(from = 1, to = length(unique(.data$date_index)), by = 1),
times = length(unique(.data$cases_cat))
),
sin52 = sin(2 * pi * Date / 52),
cos52 = cos(2 * pi * Date / 52)
)
## subset to total cases
rotaz <-
rotaz %>%
filter(cases_cat == "Total cases")
rotamodel1 <- glm(n ~ Date,
data = rotaz %>% filter(vaccine == 0),
family = "poisson"
)
# Model results
glmtidy(rotamodel1, "Rotavirus model 1")
# Check the goodness of fit statistics.
glmstats(rotamodel1)
rotamodel2 <- glm(n ~ Date,
data = rotaz %>% filter(vaccine == 1),
family = "poisson"
)
# Model results
glmtidy(rotamodel2, "Rotavirus model 2")
# Check the goodness of fit statistics.
glmstats(rotamodel2)
memisc::mtable(
"Rotavirus model 1" = rotamodel1,
"Rotavirus model 2" = rotamodel2,
getSummary = getSummary_expcoef,
summary.stats = c("AIC", "BIC", "N")
)
# Install, update and activate libraries
pacman::p_load(
here,
rio,
skimr,
tsibble,
TSA,
memisc,
tidyverse
)
memisc::mtable(
"Rotavirus model 1" = rotamodel1,
"Rotavirus model 2" = rotamodel2,
getSummary = getSummary_expcoef,
summary.stats = c("AIC", "BIC", "N")
)
memisc::mtable(
"Rotavirus model 1" = rotamodel1,
"Rotavirus model 2" = rotamodel2,
getSummary = getSummary_expcoef,
summary.stats = c("AIC", "BIC", "N")
)
toLatex(
memisc::mtable(
"Rotavirus model 1" = rotamodel1,
"Rotavirus model 2" = rotamodel2,
getSummary = getSummary_expcoef,
summary.stats = c("AIC", "BIC", "N")
),
caption = "Rotavirus models 1 and 2: estimate (SE)"
)
rotamodel3 <- glm(n ~ Date + sin52 + cos52 + vaccine,
data = rotaz,
family = "poisson"
)
# Model results
glmtidy(rotamodel3, "Rotavirus model 3")
# Check the goodness of fit statistics.
glmstats(rotamodel3)
rotaz <-
bind_cols(rotaz, fitted_m3 = fitted(rotamodel3))
ggplot(data = rotaz) +
geom_point(mapping = aes(x = date_index, y = n), alpha = 0.3) +
geom_line(mapping = aes(x = date_index, y = fitted_m3), alpha = 0.7, colour = "green") +
scale_y_continuous(limits = c(0, NA)) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
labs(
x = "Year", y = "Weekly case counts",
title = "Rotavirus cases: model 3"
) +
tsa_theme
rotamodel4 <- glm(n ~ Date * vaccine + sin52 + cos52,
data = rotaz,
family = "poisson"
)
# Model results
glmtidy(rotamodel4, "Rotavirus model 4")
# Check the goodness of fit statistics.
glmstats(rotamodel4)
rotamodel5 <- glm(n ~ vaccine * (sin52 + cos52 + Date),
data = rotaz,
family = "poisson"
)
# Model results
glmtidy(rotamodel5, "Rotavirus model 5")
# Check the goodness of fit statistics.
glmstats(rotamodel5)
rotaz <-
bind_cols(rotaz, fitted_m5 = fitted(rotamodel5))
ggplot(data = rotaz) +
geom_point(mapping = aes(x = date_index, y = n), alpha = 0.3) +
geom_line(mapping = aes(x = date_index, y = fitted_m5), alpha = 0.7, colour = "green") +
scale_y_continuous(limits = c(0, NA)) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
labs(
x = "Year", y = "Weekly case counts",
title = "Rotavirus cases: model 5"
) +
tsa_theme
car::linearHypothesis(
rotamodel5,
c("vaccine:sin52", "vaccine:cos52")
)
ls()
library(msm)
install.packages("msm")
library(msm)
?deltamethod
# Install pacman if not installed already, and activate it
if (!require("pacman")) install.packages("pacman")
# Install, update and activate libraries
pacman::p_load(
here,
rio,
skimr,
tsibble,
TSA,
tidyverse,
ciTools
)
mortagg <- import(here("data", "mortagg.csv"))
# Prepare ts data
mortz <-
mortagg %>%
mutate(year_week = make_yearweek(year = year, week = week),
index = seq.int(from = 1, to = nrow(mortagg)),
sin52 = sin(2 * pi * week / 52),
cos52 = cos(2 * pi * week / 52),
sin26 = sin(2 * pi * week / 26),
cos26 = cos(2 * pi * week / 26)) %>%
as_tsibble(index = index)
mortz$Index <- 1:nrow(mortagg)
mort_sine2cos2trendmodel <- glm(cases ~ index + sin52 + cos52 + sin26 + cos26,
family = "poisson",
data = mortz)
# Create tsa_theme from previous exercise
tsa_theme <- theme_bw() +
theme(
plot.title = element_text(face = "bold",
size = 12),
legend.background = element_rect(fill = "white",
size = 4,
colour = "white"),
# legend.justification = c(0, 1),
legend.position = "bottom",
panel.grid.minor = element_blank()
)
summary(mortz)
summary(mort_sine2cos2trendmodel)
mortz
summary(mortz)
# Load raw data
mortagg <- import(here("data", "mortagg.csv"))
summary(mortagg)
mortz <-
mortagg %>%
mutate(year_week = make_yearweek(year = year, week = week),
index = seq.int(from = 1, to = nrow(mortagg)),
sin52 = sin(2 * pi * week / 52),
cos52 = cos(2 * pi * week / 52),
sin26 = sin(2 * pi * week / 26),
cos26 = cos(2 * pi * week / 26)) %>%
as_tsibble(index = index)
mortz
View(mortz)
# Model with trend and seasonality
mort_sine2cos2trendmodel <- glm(cases ~ index + sin52 + cos52 + sin26 + cos26,
family = "poisson",
data = mortz)
summary(mort_sine2cos2trendmodel)
plot(mortz$cases)
print(summary(mortz))
tail(mortz)
pred.df <-
tibble(
year=2010,
week  = 1:52,
#index = 521:(521+52-1), # add 52 weeks
year_week = make_yearweek(year = year, week = week),
sin52 = sin(2 * pi * week / 52),
cos52 = cos(2 * pi * week / 52),
sin26 = sin(2 * pi * week / 26),
cos26 = cos(2 * pi * week / 26),
pob = 46951532) %>%                # Spanish pop in 2010 (1st Jan)
as_tsibble(index = index)
pred.df <-
tibble(
year=2010,
week  = 1:52,
index = 521:(521+52-1), # add 52 weeks
year_week = make_yearweek(year = year, week = week),
sin52 = sin(2 * pi * week / 52),
cos52 = cos(2 * pi * week / 52),
sin26 = sin(2 * pi * week / 26),
cos26 = cos(2 * pi * week / 26),
pob = 46951532) %>%                # Spanish pop in 2010 (1st Jan)
as_tsibble(index = index)
view(pred.df)
set.seed(12589)
pred.mort <- ciTools::add_ci(pred.df,
mort_sine2cos2trendmodel,
names=c("lPI", "uPI"),
yhatName="pred_cases",
response=TRUE,
type="boot",
nSims=1000)
head(pred.mort, 5)
ggplot(data = pred.mort) +
geom_line(
mapping = aes(x = year_week, y = predf_cases),
colour = "red",
alpha = 0.7
) +
geom_ribbon(
mapping = aes(x = year_week, ymin = lPI, ymax = uPI),
fill = "red",
alpha = 0.1
) +
#scale_y_continuous(limits = c(0, NA)) +
scale_x_yearweek(date_labels = "%W", date_breaks = "4 weeks") +
labs(x = "Year Week", y = "Predicted weekly cases") +
tsa_theme
geom_line(
mapping = aes(x = year_week, y = pred_cases),
colour = "red",
alpha = 0.7
) +
geom_ribbon(
mapping = aes(x = year_week, ymin = lPI, ymax = uPI),
fill = "red",
alpha = 0.1
) +
#scale_y_continuous(limits = c(0, NA)) +
scale_x_yearweek(date_labels = "%W", date_breaks = "4 weeks") +
labs(x = "Year Week", y = "Predicted weekly cases") +
tsa_theme
ggplot(data = pred.mort) +
geom_line(
mapping = aes(x = year_week, y = pred_cases),
colour = "red",
alpha = 0.7
) +
geom_ribbon(
mapping = aes(x = year_week, ymin = lPI, ymax = uPI),
fill = "red",
alpha = 0.1
) +
#scale_y_continuous(limits = c(0, NA)) +
#scale_x_yearweek(date_labels = "%W", date_breaks = "4 weeks") +
labs(x = "Year Week", y = "Predicted weekly cases") +
tsa_theme
mortz <- mortz %>%
mutate(fit_cases = mort_sine2cos2trendmodel$fit)
mortz <-
mortz %>%
mutate(
difference = cases - fit_cases,
cusum_excess = cumsum(difference)
)
mortz
ggplot(data = mortz) +
geom_line(
mapping = aes(x = year_week, y = cusum_excess),
colour = "orange",
alpha = 0.7,
lwd = 2
) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
labs(x = "Year", y = "Cumulative excess cases") +
tsa_theme
ggplot(data = pred.mort) +
geom_line(
mapping = aes(x = year_week, y = pred_cases),
colour = "red",
alpha = 0.7
) +
geom_ribbon(
mapping = aes(x = year_week, ymin = lPI, ymax = uPI),
fill = "red",
alpha = 0.1
) +
#scale_y_continuous(limits = c(0, NA)) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "4 weeks") +
#scale_x_yearweek(date_labels = "%W", date_breaks = "4 weeks") +
labs(x = "Year Week", y = "Predicted weekly cases") +
tsa_theme
ggplot(data = pred.mort) +
geom_line(
mapping = aes(x = year_week, y = pred_cases),
colour = "red",
alpha = 0.7
) +
geom_ribbon(
mapping = aes(x = year_week, ymin = lPI, ymax = uPI),
fill = "red",
alpha = 0.1
) +
#scale_y_continuous(limits = c(0, NA)) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "4 weeks") +
#scale_x_yearweek(date_labels = "%W", date_breaks = "4 weeks") +
labs(x = "Year Week", y = "Predicted weekly cases") +
theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
tsa_theme
ggplot(data = pred.mort) +
geom_line(
mapping = aes(x = year_week, y = pred_cases),
colour = "red",
alpha = 0.7
) +
geom_ribbon(
mapping = aes(x = year_week, ymin = lPI, ymax = uPI),
fill = "red",
alpha = 0.1
) +
#scale_y_continuous(limits = c(0, NA)) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "4 weeks") +
#scale_x_yearweek(date_labels = "%W", date_breaks = "4 weeks") +
labs(x = "Year Week", y = "Predicted weekly cases") +
theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
tsa_theme
ggplot(data = pred.mort) +
geom_line(
mapping = aes(x = year_week, y = pred_cases),
colour = "red",
alpha = 0.7
) +
geom_ribbon(
mapping = aes(x = year_week, ymin = lPI, ymax = uPI),
fill = "red",
alpha = 0.1
) +
#scale_y_continuous(limits = c(0, NA)) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "4 weeks") +
#scale_x_yearweek(date_labels = "%W", date_breaks = "4 weeks") +
labs(x = "Year Week", y = "Predicted weekly cases") +
theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
tsa_theme
ggplot(data = pred.mort) +
geom_line(
mapping = aes(x = year_week, y = pred_cases),
colour = "red",
alpha = 0.7
) +
geom_ribbon(
mapping = aes(x = year_week, ymin = lPI, ymax = uPI),
fill = "red",
alpha = 0.1
) +
#scale_y_continuous(limits = c(0, NA)) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "4 weeks") +
#scale_x_yearweek(date_labels = "%W", date_breaks = "4 weeks") +
labs(x = "Year Week", y = "Predicted weekly cases") +
tsa_theme +
theme(axis.text.x = element_text(angle = 45, hjust = 1))
ggplot(data = pred.mort) +
geom_line(
mapping = aes(x = year_week, y = pred_cases),
colour = "red",
alpha = 0.7
) +
geom_ribbon(
mapping = aes(x = year_week, ymin = lPI, ymax = uPI),
fill = "red",
alpha = 0.1
) +
#scale_y_continuous(limits = c(0, NA)) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "4 weeks") +
#scale_x_yearweek(date_labels = "%W", date_breaks = "4 weeks") +
labs(x = "Year Week", y = "Predicted weekly cases") +
tsa_theme +
theme(axis.text.x = element_text(angle = 30, hjust = 1))

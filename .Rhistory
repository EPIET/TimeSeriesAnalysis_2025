scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
labs(x = "Date", y = "Number of Deaths", title = "Mortality") +
tsa_theme
## Adjusting y-axis scale
ggplot(data = mortz) +
geom_line(mapping = aes(x = date_index, y = cases)) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Date", y = "Number of Deaths", title = "Mortality") +
tsa_theme()
## Adjusting y-axis scale
ggplot(data = mortz) +
geom_line(mapping = aes(x = date_index, y = cases)) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Date", y = "Number of Deaths", title = "Mortality") +
tsa_theme
# Practical 4
mort <- import(here("_temporal conversion files/mortality.dta"))    # original data
View(mort)
mortagg <-
mort %>%
group_by(year, week) %>%
summarise(
cases = sum(cases, na.rm = T),
cases_m = sum(cases_m, na.rm = T),
cases_f = sum(cases_f, na.rm = T)
)
View(mortagg)
write_csv2(mortagg, here("data", "mortagg.csv"))
View(mortagg)
mortz <-
mortagg %>%
mutate(date_index = make_yearweek(year = year, week = week)) %>%
as_tsibble(index = date_index)
View(mortz)
ggplot(data = mortz) +
geom_line(mapping = aes(x = date_index, y = cases)) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
labs(x = "Date", y = "Number of Deaths", title = "Mortality") +
tsa_theme
## Adjusting y-axis scale
ggplot(data = mortz) +
geom_line(mapping = aes(x = date_index, y = cases)) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Date", y = "Number of Deaths", title = "Mortality") +
tsa_theme
ggplot(data = mortagg) +
geom_line(mapping = aes(x = date_index, y = cases_m)) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Date", y = "Number of Deaths", title = "Mortality - Men") +
tsa_theme
ggplot(data = mortz) +
geom_line(mapping = aes(x = date_index, y = cases_m)) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Date", y = "Number of Deaths", title = "Mortality - Men") +
tsa_theme
ggplot(data = mortz) +
geom_line(mapping = aes(x = date_index, y = cases_f)) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Date", y = "Number of Deaths", title = "Mortality - Women") +
tsa_theme
# Install, update and activate libraries
pacman::p_load(
here,
rio,
skimr,
tsibble,
ISOweek,
slider,    # for rolling means
tidyverse
)
mortzma <-
mortz %>%
mutate(
MA5a = slide_index_dbl(
.x = cases,
.i = date_index,
.f = mean,
na.rm = TRUE,
.before = 2,
.after = 2,
.complete = TRUE
),
MA5b = slide_index_dbl(
.x = cases,
.i = date_index,
.f = mean,
na.rm = TRUE,
.before = 4,
.complete = TRUE
),
MA5c = slide_index_dbl(
.x = cases,
.i = date_index,
.f = function(x) mean(x[-6], na.rm = TRUE),
.before = 5,
.complete = TRUE
)
)
head(mortzma, 10)
## wide format dataset ---
ggplot(data = mortzma, mapping = aes(x = date_index)) +
geom_line(mapping = aes(y = cases), colour = "black") +
geom_line(mapping = aes(y = MA5a), colour = "red") +
geom_line(mapping = aes(y = MA5b), colour = "blue") +
geom_line(mapping = aes(y = MA5c), colour = "green") +
scale_x_yearweek(date_labels = "%Y-%W",
date_breaks = "1 year") +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Date",
y = "Number of Deaths",
title = "Moving averages") +
tsa_theme
View(mortz)
## Adjusting y-axis scale
ggplot(data = mortz) +
geom_line(mapping = aes(x = date_index, y = cases)) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
scale_y_continuous(limits = c(2000, NA)) +
labs(x = "Date", y = "Number of Deaths", title = "Mortality") +
tsa_theme
## Men
ggplot(data = mortz) +
geom_line(mapping = aes(x = date_index, y = cases_m)) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Date", y = "Number of Deaths", title = "Mortality - Men") +
tsa_theme
## Women
ggplot(data = mortz) +
geom_line(mapping = aes(x = date_index, y = cases_f)) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Date", y = "Number of Deaths", title = "Mortality - Women") +
tsa_theme
## Adjusting y-axis scale
ggplot(data = mortz) +
geom_line(mapping = aes(x = date_index, y = cases)) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
#scale_y_continuous(limits = c(2000, NA)) +
labs(x = "Date", y = "Number of Deaths", title = "Mortality") +
tsa_theme
## Adjusting y-axis scale
ggplot(data = mortz) +
geom_line(mapping = aes(x = date_index, y = cases)) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
scale_y_continuous(limits = c(2000, NA)) +
labs(x = "Date", y = "Number of Deaths", title = "Mortality") +
tsa_theme
## wide format dataset ---
ggplot(data = mortzma, mapping = aes(x = date_index)) +
geom_line(mapping = aes(y = cases), colour = "black") +
geom_line(mapping = aes(y = MA5a), colour = "red") +
geom_line(mapping = aes(y = MA5b), colour = "blue") +
geom_line(mapping = aes(y = MA5c), colour = "green") +
scale_x_yearweek(date_labels = "%Y-%W",
date_breaks = "1 year") +
scale_y_continuous(limits = c(2000, NA)) +
labs(x = "Date",
y = "Number of Deaths",
title = "Moving averages") +
tsa_theme
## wide format dataset ---
ggplot(data = mortzma, mapping = aes(x = date_index)) +
geom_line(mapping = aes(y = cases), colour = "black") +
geom_line(mapping = aes(y = MA5a), colour = "red") +
geom_line(mapping = aes(y = MA5b), colour = "blue") +
geom_line(mapping = aes(y = MA5c), colour = "green") +
scale_x_yearweek(date_labels = "%Y-%W",
date_breaks = "1 year") +
#scale_y_continuous(limits = c(2000, NA)) +
labs(x = "Date",
y = "Number of Deaths",
title = "Moving averages") +
tsa_theme
## long format dataset ---
mortzma_long <-
mortzma %>%
select(-year, -week) %>%
pivot_longer(cols = -date_index, names_to = "measure", values_to = "count")
View(mortzma_long)
### named vector to set colours for each variable
MA5x_colours <-
c(
"cases" = "black",
"MA5a" = "red",
"MA5b" = "blue",
"MA5c" = "green"
)
ggplot(data = mortzma_long, mapping = aes(x = date_index)) +
geom_line(mapping = aes(y = count, colour = measure)) +
scale_colour_manual(values = MA5x_colours) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
scale_y_continuous(limits = c(0, NA)) +
labs(
x = "Date", y = "Number of Deaths", title = "Moving averages",
colour = "Variable"
) +
tsa_theme
ggplot(data = mortzma_long, mapping = aes(x = date_index)) +
geom_line(mapping = aes(y = count, colour = measure)) +
scale_colour_manual(values = MA5x_colours) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
scale_y_continuous(limits = c(0, NA)) +
labs(
x = "Date", y = "Number of Deaths", title = "Moving averages",
colour = "Variable"
) +
tsa_theme
ggplot(data = mortzma_long, mapping = aes(x = date_index)) +
geom_line(mapping = aes(y = count, colour = measure)) +
scale_colour_manual(values = MA5x_colours)
## wide format dataset ---
ggplot(data = mortzma, mapping = aes(x = date_index)) +
geom_line(mapping = aes(y = cases), colour = "black") +
geom_line(mapping = aes(y = MA5a), colour = "red") +
geom_line(mapping = aes(y = MA5b), colour = "blue") +
geom_line(mapping = aes(y = MA5c), colour = "green") +
scale_x_yearweek(date_labels = "%Y-%W",
date_breaks = "1 year") +
#scale_y_continuous(limits = c(2000, NA)) +
labs(x = "Date",
y = "Number of Deaths",
title = "Moving averages") +
tsa_theme
## wide format dataset ---
ggplot(data = mortzma, mapping = aes(x = date_index)) +
geom_line(mapping = aes(y = cases), colour = "black") +
geom_line(mapping = aes(y = MA5a), colour = "red") +
geom_line(mapping = aes(y = MA5b), colour = "blue") +
geom_line(mapping = aes(y = MA5c), colour = "green") +
scale_x_yearweek(date_labels = "%Y-%W",
date_breaks = "1 year") +
#scale_y_continuous(limits = c(2000, NA)) +
labs(x = "Date",
y = "Number of Deaths",
title = "Moving averages") +
tsa_theme
ggplot(data = mortz, mapping = aes(x = date_index, y = cases)) +
geom_point(alpha = 0.5) +
#geom_smooth() +
stat_smooth(method = "loess", se = FALSE) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Date", y = "Number of Deaths", title = "Loess smoothing") +
tsa_theme
ggplot(data = mortz, mapping = aes(x = date_index, y = cases)) +
geom_point(alpha = 0.5) +
geom_smooth() +
#stat_smooth(method = "loess", se = FALSE) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Date", y = "Number of Deaths", title = "Loess smoothing") +
tsa_theme
ggplot(data = mortz, mapping = aes(x = date_index, y = cases)) +
geom_point(alpha = 0.5) +
geom_smooth(se = TRUE) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
#scale_y_continuous(limits = c(0, NA)) +
labs(x = "Date", y = "Number of Deaths", title = "Loess smoothing") +
tsa_theme
ggplot(data = mortz, mapping = aes(x = date_index, y = cases)) +
geom_point(alpha = 0.5) +
geom_smooth(se = TRUE) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Date", y = "Number of Deaths", title = "Loess smoothing") +
tsa_theme
ggplot(data = mortz, mapping = aes(x = date_index, y = cases)) +
geom_point(alpha = 0.5) +
stat_smooth(method = "loess", se = FALSE, span = 0.1) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Date", y = "Number of Deaths", title = "Loess smoothing (span = 0.1)") +
tsa_theme()
ggplot(data = mortz, mapping = aes(x = date_index, y = cases)) +
geom_point(alpha = 0.5) +
geom_smooth(se = TRUE) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Date", y = "Number of Deaths", title = "Loess smoothing (span = 0.1)") +
tsa_theme
mortzma2 <-
mortz %>%
mutate(
MA25 = slide_index_dbl(
.x = cases,
.i = date_index,
.f = mean,
na.rm = TRUE,
.before = 24,
.complete = TRUE
),
MA51 = slide_index_dbl(
.x = cases,
.i = date_index,
.f = mean,
na.rm = TRUE,
.before = 50,
.complete = TRUE
),
MA103 = slide_index_dbl(
.x = cases,
.i = date_index,
.f = mean,
na.rm = TRUE,
.before = 102,
.complete = TRUE
)
)
## Visually inspect data
slice(mortzma2, 20:30)
slice(mortzma2, 45:55)
slice(mortzma2, 95:105)
slice(mortzma2, 95:105)
slice(mortzma2, 45:55)
View(mortzma2)
slice(mortzma2, 95:105)
slice(mortzma2, 95:105)
## wide format dataset ---
ggplot(mortzma2, mapping = aes(x = date_index)) +
geom_line(mapping = aes(y = cases), colour = "black") +
geom_line(mapping = aes(y = MA25), colour = "red") +
geom_line(mapping = aes(y = MA51), colour = "blue") +
geom_line(mapping = aes(y = MA103), colour = "green") +
scale_x_yearweek(date_labels = "%Y-%W",
date_breaks = "1 year") +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Date",
y = "Number of Deaths",
title = "Moving averages") +
tsa_theme()
## wide format dataset ---
ggplot(mortzma2, mapping = aes(x = date_index)) +
geom_line(mapping = aes(y = cases), colour = "black") +
geom_line(mapping = aes(y = MA25), colour = "red") +
geom_line(mapping = aes(y = MA51), colour = "blue") +
geom_line(mapping = aes(y = MA103), colour = "green") +
scale_x_yearweek(date_labels = "%Y-%W",
date_breaks = "1 year") +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Date",
y = "Number of Deaths",
title = "Moving averages") +
tsa_theme
mortz <-
mortz %>%
mutate(Date = seq.int(from = 1, to = nrow(.)))
linregmodel <- lm(
formula = cases ~ Date,
data = mortz
)
View(mortz)
mortz <-
mortz %>%
ungroup() %>%
mutate(Date = seq.int(from = 1, to = nrow(.)))
linregmodel <- lm(
formula = cases ~ Date,
data = mortz
)
names(linregmodel)
summary(linregmodel)
fitted(linregmodel)
ggplot(data = mortz, mapping = aes(x = Date)) +
geom_point(mapping = aes(y = cases), alpha = 0.5) +
geom_line(mapping = aes(y = fitted(linregmodel)), colour = "green") +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Time point", y = "Number of Deaths", title = "Mortality with fitted trend") +
tsa_theme()
ggplot(data = mortz, mapping = aes(x = Date)) +
geom_point(mapping = aes(y = cases), alpha = 0.5) +
geom_line(mapping = aes(y = fitted(linregmodel)), colour = "green") +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Time point", y = "Number of Deaths", title = "Mortality with fitted trend") +
tsa_theme
linregmodel <- glm(
formula = cases ~ Date,
family = "poisson",
data = mortz
)
names(linregmodel)
summary(linregmodel)
fitted(linregmodel)
ggplot(data = mortz, mapping = aes(x = Date)) +
geom_point(mapping = aes(y = cases), alpha = 0.5) +
geom_line(mapping = aes(y = fitted(linregmodel)), colour = "green") +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Time point", y = "Number of Deaths", title = "Mortality with fitted trend") +
tsa_theme
# Function to tidy glm regression output
glmtidy <- function(x, caption = "") {
pander::pander(
broom::tidy(x,
exponentiate = TRUE,
conf.int = TRUE
),
caption = caption
)
}
# Function to tidy glm regression statistics
glmstats <- function(x) {
pander::pander(broom::glance(x))
}
mortz <-
mortz %>%
mutate(pop = rep(c(
39953520, 40688520, 41423520, 42196231, 42859172,
43662613, 44360521, 45236004, 45983169, 46367550
),
each = 52
))
mortpoismodel <- glm(cases ~ offset(log(pop)) + Date,
data = mortz,
family = "poisson"
)
glmtidy(mortpoismodel)
ggplot(data = mortz, mapping = aes(x = Date)) +
geom_point(mapping = aes(y = cases), alpha = 0.5) +
geom_line(mapping = aes(y = fitted(mortpoismodel)), colour = "blue") +
scale_y_continuous(limits = c(0, NA)) +
labs(
x = "Time point", y = "Number of Deaths",
title = "Mortality with fitted trend (Poisson)"
) +
tsa_theme
dis1 <- import(here("data", "tsa_practice.xlsx"), which = "dis1")
View(dis1)
dis1 <-
dis1 %>%
mutate(date = seq.int(from = 1, to = nrow(.)))
salmo <- dis1
salmo <-
salmo %>%
mutate(lcases = log(cases))
salmoz2 <-
salmo %>%
mutate(date_index = make_yearweek(year = year, week = week)) %>%
as_tsibble(index = date_index)
ggplot(data = salmoz2, mapping = aes(x = date_index)) +
geom_line(mapping = aes(y = lcases)) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Year", y = "Cases (natural log scale)", title = "Log Salmonella data") +
tsa_theme
logmodel <- lm(lcases ~ date, data = salmoz2)
summary(logmodel)
fitted_pois_df <-
enframe(fitted(logmodel), name = "date", value = "ltrend") %>%
mutate(date = as.integer(date))
salmoz2 <-
salmoz2 %>%
left_join(
x = .,
y = fitted_pois_df,
by = "date"
) %>%
mutate(ltrend = imputeTS::na_interpolation(x = ltrend, option = "linear"))
ggplot(data = salmoz2, mapping = aes(x = date)) +
geom_line(mapping = aes(y = lcases)) +
geom_line(mapping = aes(y = ltrend), colour = "green") +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
scale_y_continuous(limits = c(0, NA)) +
labs(
x = "Time point",
y = "Log Salmonella cases",
title = "Log Salmonella data with fitted trend"
) +
tsa_theme
salmoz2 <-
salmoz2 %>%
mutate(trend = exp(ltrend))
ggplot(data = salmoz2, mapping = aes(x = date)) +
geom_line(mapping = aes(y = cases)) +
geom_line(mapping = aes(y = trend), colour = "green") +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
scale_y_continuous(limits = c(0, NA)) +
labs(
x = "Time point",
y = "Salmonella cases",
title = "Salmonella data with fitted trend"
) +
tsa_theme
salmopoismodel <- glm(cases ~ date, data = salmoz2, family = "poisson")
summary(salmopoismodel)
fitted_pois2_df <-
enframe(fitted(salmopoismodel), name = "date", value = "trend2") %>%
mutate(date = as.integer(date))
salmoz2 <-
salmoz2 %>%
left_join(
x = .,
y = fitted_pois2_df,
by = "date"
) %>%
mutate(trend2 = imputeTS::na_interpolation(x = trend2, option = "linear"))
ggplot(data = salmoz2, mapping = aes(x = date)) +
geom_line(mapping = aes(y = cases)) +
geom_line(mapping = aes(y = trend2), colour = "green") +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
scale_y_continuous(limits = c(0, NA)) +
labs(
x = "Time point",
y = "Salmonella cases",
title = "Salmonella data with fitted trend"
) +
tsa_theme

size = 4,
colour = "white"),
# legend.justification = c(0, 1),
legend.position = "bottom",
panel.grid.minor = element_blank()
)
# Read data
load(here("data", "mortagg2_case_4.RData"))
# format the data to a time series object using ts().
mortz.ts  <- ts(mortz$cases, frequency=52, start=c(2010,1))
plot(decompose(mortz.ts))
mort_trend <- glm(cases ~ index, family = "poisson", data = mortz)
summary(mort_trend)
# incidence rate ratio per week:
IRR_week <- exp(coef(mort_trend))
ggplot(data = mortz, aes(x = index)) +
geom_point(aes(y = cases), alpha = 0.4) +
geom_line(
mapping = aes(y = fitted(mort_trend)),
colour = "green",
lwd=1.5
) +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Index",
y = "Number of deaths",
title = "Regression model: trend") +
tsa_theme
IRR_week
mort_period <- TSA::periodogram(mortz$cases)
# Read data
load(here("data", "mortagg2_case_4.RData"))
load(here("data", "mortagg2.Rdata"))
mortz <-
mortagg %>%
mutate(date_index = make_yearweek(year = year, week = week)) %>%
as_tsibble(index = date_index)
mortz$Date <- seq.int(from = 1,
to = nrow(mortz))
plot(decompose(mortz))
tsibble::interval(mortz)
# Read data
load(here("data", "mortagg2_case_4.RData"))
View(mortz)
View(mortzma)
View(mortzma2)
View(mortagg)
View(mortz)
# Prepare ts data
load(here("data", "mortagg2_case_6.Rdata"))
View(mortagg)
mortagg <- import(here("data", "mortagg.csv"))
mortz <-
mortagg %>%
mutate(year_week = make_yearweek(year = year, week = week),
index = seq.int(from = 1, to = nrow(mortagg)),
sin52 = sin(2 * pi * week / 52),
cos52 = cos(2 * pi * week / 52),
sin26 = sin(2 * pi * week / 26),
cos26 = cos(2 * pi * week / 26)) %>%
as_tsibble(index = index)
mortagg <- import(here("data", "mortagg.csv"))
mortz <-
mortagg %>%
mutate(year_week = make_yearweek(year = year, week = week),
index = seq.int(from = 1, to = nrow(mortagg)),
sin52 = sin(2 * pi * week / 52),
cos52 = cos(2 * pi * week / 52),
sin26 = sin(2 * pi * week / 26),
cos26 = cos(2 * pi * week / 26)) %>%
as_tsibble(index = index)
# Model with trend and seasonality
mort_sine2cos2trendmodel <- glm(cases ~ index + sin52 + cos52 + sin26 + cos26,
family = "poisson",
data = mortz)
ggplot(data = mortz) +
geom_line(
mapping = aes(x = year_week, y = cases),
colour = "black",
alpha = 1.2
) +
geom_line(
mapping = aes(x = year_week, y = mort_sine2cos2trendmodel$fitted),
colour = "red",
alpha = 1.2
) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "8 weeks") +
labs(x = "Year Week", y = "Weekly cases") +
tsa_theme +
theme(axis.text.x = element_text(angle = 30, hjust = 1))
rm(list=ls())
# Install pacman if not installed already, and activate it
if (!require("pacman")) install.packages("pacman")
# Install, update and activate libraries
pacman::p_load(
here,
rio,
skimr,
tsibble,
TSA,
tidyverse,
ciTools
)
# Create tsa_theme from previous exercise to be used in ggplot.
tsa_theme <- theme_bw() +
theme(
plot.title = element_text(face = "bold",
size = 12),
legend.background = element_rect(fill = "white",
size = 4,
colour = "white"),
# legend.justification = c(0, 1),
legend.position = "bottom",
panel.grid.minor = element_blank()
)
# Prepare ts data
load(here("data", "mortagg2_case_6.Rdata"))
mortagg <- import(here("data", "mortagg.csv"))
mortz <-
mortagg %>%
mutate(year_week = make_yearweek(year = year, week = week),
index = seq.int(from = 1, to = nrow(mortagg)),
sin52 = sin(2 * pi * week / 52),
cos52 = cos(2 * pi * week / 52),
sin26 = sin(2 * pi * week / 26),
cos26 = cos(2 * pi * week / 26)) %>%
as_tsibble(index = index)
# Model with trend and seasonality
mort_sine2cos2trendmodel <- glm(cases ~ index + sin52 + cos52 + sin26 + cos26,
family = "poisson",
data = mortz)
# Prepare ts data
#load(here("data", "mortagg2_case_6.Rdata"))
mortagg <- import(here("data", "mortagg.csv"))
mortz <-
mortagg %>%
mutate(year_week = make_yearweek(year = year, week = week),
index = seq.int(from = 1, to = nrow(mortagg)),
sin52 = sin(2 * pi * week / 52),
cos52 = cos(2 * pi * week / 52),
sin26 = sin(2 * pi * week / 26),
cos26 = cos(2 * pi * week / 26)) %>%
as_tsibble(index = index)
# Model with trend and seasonality
mort_sine2cos2trendmodel <- glm(cases ~ index + sin52 + cos52 + sin26 + cos26,
family = "poisson",
data = mortz)
ggplot(data = mortz) +
geom_line(
mapping = aes(x = year_week, y = cases),
colour = "black",
alpha = 1.2
) +
geom_line(
mapping = aes(x = year_week, y = mort_sine2cos2trendmodel$fitted),
colour = "red",
alpha = 1.2
) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "8 weeks") +
labs(x = "Year Week", y = "Weekly cases") +
tsa_theme +
theme(axis.text.x = element_text(angle = 30, hjust = 1))
# Create tsa_theme from previous exercise to be used in ggplot.
tsa_theme <- theme_bw() +
theme(
plot.title = element_text(face = "bold",
size = 12),
legend.background = element_rect(fill = "white",
size = 4,
colour = "white"),
# legend.justification = c(0, 1),
legend.position = "bottom",
panel.grid.minor = element_blank()
)
ggplot(data = mortz) +
geom_line(
mapping = aes(x = year_week, y = cases),
colour = "black",
alpha = 1.2
) +
geom_line(
mapping = aes(x = year_week, y = mort_sine2cos2trendmodel$fitted),
colour = "red",
alpha = 1.2
) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "8 weeks") +
labs(x = "Year Week", y = "Weekly cases") +
tsa_theme +
theme(axis.text.x = element_text(angle = 30, hjust = 1))
load(here("data", "mortagg2_case_6.Rdata"))
View(mortagg)
export(mortagg, here("data", "mortagg2.csv"))
View(mortagg)
# Prepare ts data
#load(here("data", "mortagg2_case_6.Rdata"))
mortagg <- import(here("data", "mortagg2.csv"))
View(mortagg)
mortz <-
mortagg %>%
mutate(year_week = make_yearweek(year = year, week = week),
index = seq.int(from = 1, to = nrow(mortagg)),
sin52 = sin(2 * pi * week / 52),
cos52 = cos(2 * pi * week / 52),
sin26 = sin(2 * pi * week / 26),
cos26 = cos(2 * pi * week / 26)) %>%
as_tsibble(index = index)
# Model with trend and seasonality
mort_sine2cos2trendmodel <- glm(cases ~ index + sin52 + cos52 + sin26 + cos26,
family = "poisson",
data = mortz)
ggplot(data = mortz) +
geom_line(
mapping = aes(x = year_week, y = cases),
colour = "black",
alpha = 1.2
) +
geom_line(
mapping = aes(x = year_week, y = mort_sine2cos2trendmodel$fitted),
colour = "red",
alpha = 1.2
) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "8 weeks") +
labs(x = "Year Week", y = "Weekly cases") +
tsa_theme +
theme(axis.text.x = element_text(angle = 30, hjust = 1))
# Create tsa_theme from previous exercise to be used in ggplot.
tsa_theme <- theme_bw() +
theme(
plot.title = element_text(face = "bold",
size = 12),
legend.background = element_rect(fill = "white",
size = 4,
colour = "white"),
# legend.justification = c(0, 1),
legend.position = "bottom",
panel.grid.minor = element_blank()
)
ggplot(data = mortz) +
geom_line(
mapping = aes(x = year_week, y = cases),
colour = "black",
alpha = 1.2
) +
geom_line(
mapping = aes(x = year_week, y = mort_sine2cos2trendmodel$fitted),
colour = "red",
alpha = 1.2
) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "8 weeks") +
labs(x = "Year Week", y = "Weekly cases") +
tsa_theme +
theme(axis.text.x = element_text(angle = 30, hjust = 1))
pred.df <-
tibble(
year=2020,
week  = 1:53,
index = 521:(521+53-1), # add 53 weeks
year_week = make_yearweek(year = year, week = week),
sin52 = sin(2 * pi * week / 52),
cos52 = cos(2 * pi * week / 52),
sin26 = sin(2 * pi * week / 26),
cos26 = cos(2 * pi * week / 26),
pop = 47318050) %>%                # Spanish pop in 2020 (1st Jan)
as_tsibble(index = index)
view(pred.df)
set.seed(12589)
pred.mort <- ciTools::add_ci(pred.df,
mort_sine2cos2trendmodel,
names=c("lPI", "uPI"),
yhatName="pred_cases",
response=TRUE,
type="boot",
nSims=1000)
head(pred.mort, 5)
ggplot(data = pred.mort) +
geom_line(
mapping = aes(x = year_week, y = pred_cases),
colour = "red",
alpha = 0.7
) +
geom_ribbon(
mapping = aes(x = year_week, ymin = lPI, ymax = uPI),
fill = "red",
alpha = 0.1
) +
scale_y_continuous(limits = c(0, NA)) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "4 weeks") +
labs(x = "Year Week", y = "Predicted weekly fatalities") +
tsa_theme +
theme(axis.text.x = element_text(angle = 30, hjust = 1))
View(pred.mort)
pred.mort %>%
summarise(
pred_cases_2020 = sum(pred_cases),
pred_cases_2020_lPI = sum(lPI),
pred_cases_2020_uPI = sum(uPI)
)
mortz <- mortz %>%
mutate(fit_cases = mort_sine2cos2trendmodel$fit)
View(mortz)
mortz <- mortz %>%
mutate(fit_cases = mort_sine2cos2trendmodel$fit,
difference = cases - fit_cases,
cumsum_excess = cumsum(difference),
diff_zero = cases - mean(fit_cases),
cumsum_zero = cumsum(diff_zero))
ggplot(data = mortz) +
geom_line(
mapping = aes(x = year_week, y = diff_zero),
colour = "green",
alpha = 0.7,
lwd = 2
) +
geom_line(
mapping = aes(x = year_week, y = cumsum_zero),
colour = "orange",
alpha = 0.7,
lwd = 2
) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
labs(x = "Year", y = "Cumulative excess cases") +
tsa_theme
# Prepare ts data
#load(here("data", "mortagg2_case_6.Rdata"))
mortagg <- import(here("data", "mortagg2.RDS"))
load(here("data", "mortagg2_case_6.Rdata"))
View(mortagg)
View(mort2020)
export(mort2020, here("data", "mortagg2020.csv"))
here()
rm(list=ls())
# Install pacman if not installed already, and activate it
if (!require("pacman")) install.packages("pacman")
# Install, update and activate libraries
pacman::p_load(
here,
rio,
skimr,
tsibble,
TSA,
tidyverse,
ciTools
)
# Create tsa_theme from previous exercise to be used in ggplot.
tsa_theme <- theme_bw() +
theme(
plot.title = element_text(face = "bold",
size = 12),
legend.background = element_rect(fill = "white",
size = 4,
colour = "white"),
# legend.justification = c(0, 1),
legend.position = "bottom",
panel.grid.minor = element_blank()
)
# Prepare ts data
#load(here("data", "mortagg2_case_6.Rdata"))
mortagg <- import(here("data", "mortagg2.csv"))
mortz <-
mortagg %>%
mutate(year_week = make_yearweek(year = year, week = week),
index = seq.int(from = 1, to = nrow(mortagg)),
sin52 = sin(2 * pi * week / 52),
cos52 = cos(2 * pi * week / 52),
sin26 = sin(2 * pi * week / 26),
cos26 = cos(2 * pi * week / 26)) %>%
as_tsibble(index = index)
# Model with trend and seasonality
mort_sine2cos2trendmodel <- glm(cases ~ index + sin52 + cos52 + sin26 + cos26,
family = "poisson",
data = mortz)
ggplot(data = mortz) +
geom_line(
mapping = aes(x = year_week, y = cases),
colour = "black",
alpha = 1.2
) +
geom_line(
mapping = aes(x = year_week, y = mort_sine2cos2trendmodel$fitted),
colour = "red",
alpha = 1.2
) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "8 weeks") +
labs(x = "Year Week", y = "Weekly cases") +
tsa_theme +
theme(axis.text.x = element_text(angle = 30, hjust = 1))
pred.df <-
tibble(
year=2020,
week  = 1:53,
index = 521:(521+53-1), # add 53 weeks
year_week = make_yearweek(year = year, week = week),
sin52 = sin(2 * pi * week / 52),
cos52 = cos(2 * pi * week / 52),
sin26 = sin(2 * pi * week / 26),
cos26 = cos(2 * pi * week / 26),
pop = 47318050) %>%                # Spanish pop in 2020 (1st Jan)
as_tsibble(index = index)
view(pred.df)
# apply mort_sine2cos2trendmodel to new data and predict cases with C.I. using bootstrapping.
# bootstrapping is a statistical method where you draw random samples from your data,
# and analyze each of this samples.
# https://en.wikipedia.org/wiki/Bootstrapping_(statistics)
set.seed(12589)
pred.mort <- ciTools::add_ci(pred.df,
mort_sine2cos2trendmodel,
names=c("lPI", "uPI"),
yhatName="pred_cases",
response=TRUE,
type="boot",
nSims=1000)
head(pred.mort, 5)
ggplot(data = pred.mort) +
geom_line(
mapping = aes(x = year_week, y = pred_cases),
colour = "red",
alpha = 0.7
) +
geom_ribbon(
mapping = aes(x = year_week, ymin = lPI, ymax = uPI),
fill = "red",
alpha = 0.1
) +
scale_y_continuous(limits = c(0, NA)) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "4 weeks") +
labs(x = "Year Week", y = "Predicted weekly fatalities") +
tsa_theme +
theme(axis.text.x = element_text(angle = 30, hjust = 1))
# Total predicted cases in 2020, with lPI and uPI
pred.mort %>%
summarise(
pred_cases_2020 = sum(pred_cases),
pred_cases_2020_lPI = sum(lPI),
pred_cases_2020_uPI = sum(uPI)
)
mortz <- mortz %>%
mutate(fit_cases = mort_sine2cos2trendmodel$fit,  # get predicted cases
# calculate differences
difference = cases - fit_cases,
cumsum_excess = cumsum(difference),
diff_zero = cases - mean(fit_cases),
cumsum_zero = cumsum(diff_zero))
ggplot(data = mortz) +
geom_line(
mapping = aes(x = year_week, y = diff_zero),
colour = "green",
alpha = 0.7,
lwd = 2
) +
geom_line(
mapping = aes(x = year_week, y = cumsum_zero),
colour = "orange",
alpha = 0.7,
lwd = 2
) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
labs(x = "Year", y = "Cumulative excess cases") +
tsa_theme
# load mortality data for 2020
mort2020 <- import(here("data", "mortagg2020.csv"))
View(mort2020)
# order mort2020 from week 1 to week 53, same as in pred.mort
mort2020 <- mort2020 %>% arrange(week)
View(mort2020)
# add actual deaths from 2020 in pred.mort
pred.mort <- pred.mort %>%
mutate(cases = mort2020$cases)
ggplot(data = pred.mort) +
geom_line(
mapping = aes(x = year_week, y = pred_cases),
colour = "red",
alpha = 0.7,
lwd = 1.2
) +
geom_ribbon(
mapping = aes(x = year_week, ymin = lPI, ymax = uPI),
fill = "red",
alpha = 0.1
) +
geom_line(
mapping = aes(x = year_week, y = cases),
colour = "black",
alpha = 0.7,
lwd = 1.2
) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "4 weeks") +
labs(x = "Year Week", y = "Predicted weekly cases") +
tsa_theme +
theme(axis.text.x = element_text(angle = 30, hjust = 1))
pred.mort <- pred.mort %>%
mutate(
difference_mean = cases - pred_cases,
cusum_excess_mean = cumsum(difference_mean),
difference_uPI = cases - uPI,
cusum_excess_uPI = cumsum(difference_uPI)
)
ggplot(data = pred.mort) +
geom_line(
mapping = aes(x = year_week, y = cusum_excess_mean),
colour = "orange",
alpha = 0.7,
lwd = 2
) +
geom_line(
mapping = aes(x = year_week, y = cusum_excess_uPI),
colour = "blue",
alpha = 0.7,
lwd = 2
) +
#scale_y_continuous(limits = c(-100, NA)) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "4 weeks") +
labs(x = "Year", y = "Cumulative excess cases") +
tsa_theme

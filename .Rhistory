## wide format dataset ---
ggplot(data = mortzma, mapping = aes(x = date_index)) +
geom_line(mapping = aes(y = cases), colour = "black") +
geom_line(mapping = aes(y = MA5a), colour = "red") +
geom_line(mapping = aes(y = MA5b), colour = "blue") +
geom_line(mapping = aes(y = MA5c), colour = "green") +
scale_x_yearweek(date_labels = "%Y-%W",
date_breaks = "1 year") +
#scale_y_continuous(limits = c(2000, NA)) +
labs(x = "Date",
y = "Number of Deaths",
title = "Moving averages") +
tsa_theme
ggplot(data = mortz, mapping = aes(x = date_index, y = cases)) +
geom_point(alpha = 0.5) +
#geom_smooth() +
stat_smooth(method = "loess", se = FALSE) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Date", y = "Number of Deaths", title = "Loess smoothing") +
tsa_theme
ggplot(data = mortz, mapping = aes(x = date_index, y = cases)) +
geom_point(alpha = 0.5) +
geom_smooth() +
#stat_smooth(method = "loess", se = FALSE) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Date", y = "Number of Deaths", title = "Loess smoothing") +
tsa_theme
ggplot(data = mortz, mapping = aes(x = date_index, y = cases)) +
geom_point(alpha = 0.5) +
geom_smooth(se = TRUE) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
#scale_y_continuous(limits = c(0, NA)) +
labs(x = "Date", y = "Number of Deaths", title = "Loess smoothing") +
tsa_theme
ggplot(data = mortz, mapping = aes(x = date_index, y = cases)) +
geom_point(alpha = 0.5) +
geom_smooth(se = TRUE) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Date", y = "Number of Deaths", title = "Loess smoothing") +
tsa_theme
ggplot(data = mortz, mapping = aes(x = date_index, y = cases)) +
geom_point(alpha = 0.5) +
stat_smooth(method = "loess", se = FALSE, span = 0.1) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Date", y = "Number of Deaths", title = "Loess smoothing (span = 0.1)") +
tsa_theme()
ggplot(data = mortz, mapping = aes(x = date_index, y = cases)) +
geom_point(alpha = 0.5) +
geom_smooth(se = TRUE) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Date", y = "Number of Deaths", title = "Loess smoothing (span = 0.1)") +
tsa_theme
mortzma2 <-
mortz %>%
mutate(
MA25 = slide_index_dbl(
.x = cases,
.i = date_index,
.f = mean,
na.rm = TRUE,
.before = 24,
.complete = TRUE
),
MA51 = slide_index_dbl(
.x = cases,
.i = date_index,
.f = mean,
na.rm = TRUE,
.before = 50,
.complete = TRUE
),
MA103 = slide_index_dbl(
.x = cases,
.i = date_index,
.f = mean,
na.rm = TRUE,
.before = 102,
.complete = TRUE
)
)
## Visually inspect data
slice(mortzma2, 20:30)
slice(mortzma2, 45:55)
slice(mortzma2, 95:105)
slice(mortzma2, 95:105)
slice(mortzma2, 45:55)
View(mortzma2)
slice(mortzma2, 95:105)
slice(mortzma2, 95:105)
## wide format dataset ---
ggplot(mortzma2, mapping = aes(x = date_index)) +
geom_line(mapping = aes(y = cases), colour = "black") +
geom_line(mapping = aes(y = MA25), colour = "red") +
geom_line(mapping = aes(y = MA51), colour = "blue") +
geom_line(mapping = aes(y = MA103), colour = "green") +
scale_x_yearweek(date_labels = "%Y-%W",
date_breaks = "1 year") +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Date",
y = "Number of Deaths",
title = "Moving averages") +
tsa_theme()
## wide format dataset ---
ggplot(mortzma2, mapping = aes(x = date_index)) +
geom_line(mapping = aes(y = cases), colour = "black") +
geom_line(mapping = aes(y = MA25), colour = "red") +
geom_line(mapping = aes(y = MA51), colour = "blue") +
geom_line(mapping = aes(y = MA103), colour = "green") +
scale_x_yearweek(date_labels = "%Y-%W",
date_breaks = "1 year") +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Date",
y = "Number of Deaths",
title = "Moving averages") +
tsa_theme
mortz <-
mortz %>%
mutate(Date = seq.int(from = 1, to = nrow(.)))
linregmodel <- lm(
formula = cases ~ Date,
data = mortz
)
View(mortz)
mortz <-
mortz %>%
ungroup() %>%
mutate(Date = seq.int(from = 1, to = nrow(.)))
linregmodel <- lm(
formula = cases ~ Date,
data = mortz
)
names(linregmodel)
summary(linregmodel)
fitted(linregmodel)
ggplot(data = mortz, mapping = aes(x = Date)) +
geom_point(mapping = aes(y = cases), alpha = 0.5) +
geom_line(mapping = aes(y = fitted(linregmodel)), colour = "green") +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Time point", y = "Number of Deaths", title = "Mortality with fitted trend") +
tsa_theme()
ggplot(data = mortz, mapping = aes(x = Date)) +
geom_point(mapping = aes(y = cases), alpha = 0.5) +
geom_line(mapping = aes(y = fitted(linregmodel)), colour = "green") +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Time point", y = "Number of Deaths", title = "Mortality with fitted trend") +
tsa_theme
linregmodel <- glm(
formula = cases ~ Date,
family = "poisson",
data = mortz
)
names(linregmodel)
summary(linregmodel)
fitted(linregmodel)
ggplot(data = mortz, mapping = aes(x = Date)) +
geom_point(mapping = aes(y = cases), alpha = 0.5) +
geom_line(mapping = aes(y = fitted(linregmodel)), colour = "green") +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Time point", y = "Number of Deaths", title = "Mortality with fitted trend") +
tsa_theme
# Function to tidy glm regression output
glmtidy <- function(x, caption = "") {
pander::pander(
broom::tidy(x,
exponentiate = TRUE,
conf.int = TRUE
),
caption = caption
)
}
# Function to tidy glm regression statistics
glmstats <- function(x) {
pander::pander(broom::glance(x))
}
mortz <-
mortz %>%
mutate(pop = rep(c(
39953520, 40688520, 41423520, 42196231, 42859172,
43662613, 44360521, 45236004, 45983169, 46367550
),
each = 52
))
mortpoismodel <- glm(cases ~ offset(log(pop)) + Date,
data = mortz,
family = "poisson"
)
glmtidy(mortpoismodel)
ggplot(data = mortz, mapping = aes(x = Date)) +
geom_point(mapping = aes(y = cases), alpha = 0.5) +
geom_line(mapping = aes(y = fitted(mortpoismodel)), colour = "blue") +
scale_y_continuous(limits = c(0, NA)) +
labs(
x = "Time point", y = "Number of Deaths",
title = "Mortality with fitted trend (Poisson)"
) +
tsa_theme
dis1 <- import(here("data", "tsa_practice.xlsx"), which = "dis1")
View(dis1)
dis1 <-
dis1 %>%
mutate(date = seq.int(from = 1, to = nrow(.)))
salmo <- dis1
salmo <-
salmo %>%
mutate(lcases = log(cases))
salmoz2 <-
salmo %>%
mutate(date_index = make_yearweek(year = year, week = week)) %>%
as_tsibble(index = date_index)
ggplot(data = salmoz2, mapping = aes(x = date_index)) +
geom_line(mapping = aes(y = lcases)) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Year", y = "Cases (natural log scale)", title = "Log Salmonella data") +
tsa_theme
logmodel <- lm(lcases ~ date, data = salmoz2)
summary(logmodel)
fitted_pois_df <-
enframe(fitted(logmodel), name = "date", value = "ltrend") %>%
mutate(date = as.integer(date))
salmoz2 <-
salmoz2 %>%
left_join(
x = .,
y = fitted_pois_df,
by = "date"
) %>%
mutate(ltrend = imputeTS::na_interpolation(x = ltrend, option = "linear"))
ggplot(data = salmoz2, mapping = aes(x = date)) +
geom_line(mapping = aes(y = lcases)) +
geom_line(mapping = aes(y = ltrend), colour = "green") +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
scale_y_continuous(limits = c(0, NA)) +
labs(
x = "Time point",
y = "Log Salmonella cases",
title = "Log Salmonella data with fitted trend"
) +
tsa_theme
salmoz2 <-
salmoz2 %>%
mutate(trend = exp(ltrend))
ggplot(data = salmoz2, mapping = aes(x = date)) +
geom_line(mapping = aes(y = cases)) +
geom_line(mapping = aes(y = trend), colour = "green") +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
scale_y_continuous(limits = c(0, NA)) +
labs(
x = "Time point",
y = "Salmonella cases",
title = "Salmonella data with fitted trend"
) +
tsa_theme
salmopoismodel <- glm(cases ~ date, data = salmoz2, family = "poisson")
summary(salmopoismodel)
fitted_pois2_df <-
enframe(fitted(salmopoismodel), name = "date", value = "trend2") %>%
mutate(date = as.integer(date))
salmoz2 <-
salmoz2 %>%
left_join(
x = .,
y = fitted_pois2_df,
by = "date"
) %>%
mutate(trend2 = imputeTS::na_interpolation(x = trend2, option = "linear"))
ggplot(data = salmoz2, mapping = aes(x = date)) +
geom_line(mapping = aes(y = cases)) +
geom_line(mapping = aes(y = trend2), colour = "green") +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
scale_y_continuous(limits = c(0, NA)) +
labs(
x = "Time point",
y = "Salmonella cases",
title = "Salmonella data with fitted trend"
) +
tsa_theme
# Practical 5
mort_agg <- import(here("_temporal conversion files/mortagg.dta"))    # original data
pacman::p_load(tidyverse, rio, here)
# Practical 5
mort_agg <- import(here("_temporal conversion files/mortagg.dta"))    # original data
# Practical 5
mort_agg <- import(here("data/mortagg.dta"))    # original data
# Practical 5
mort_agg <- import(here("data/mortality_agg.dta"))    # original data
View(mort_agg)
# Practical 4
mort <- import(here("_temporal conversion files/mortality.dta"))    # original data
mortagg <-
mort %>%
group_by(year, week) %>%
summarise(
cases = sum(cases, na.rm = T),
cases_m = sum(cases_m, na.rm = T),
cases_f = sum(cases_f, na.rm = T)
)
View(mortagg)
# Install pacman if not installed already, and activate it
if (!require("pacman")) install.packages("pacman")
# Install, update and activate libraries
pacman::p_load(
here,
rio,
skimr,
tsibble,
ISOweek,
slider,    # for rolling means
tidyverse
)
mortagg <- import(here("data", "mortagg.csv"))
mortz <-
mortagg %>%
mutate(date_index = make_yearweek(year = year, week = week)) %>%
as_tsibble(index = date_index)
mortz$Date <- seq.int(from = 1,
to = nrow(mortz))
mortper <- periodogram(mortz$cases)
?periodogram
??periodogram
# Install, update and activate libraries
pacman::p_load(
here,
rio,
skimr,
tsibble,
ISOweek,
TSA,
tidyverse
)
mortper <- periodogram(mortz$cases)
mortper <- periodogram(mortz$cases)
str(mortper)
mortper_recip <-
tibble(
freq = mortper$freq[order(-mortper$spec)],
spec = mortper$spec[order(-mortper$spec)]
) %>%
mutate(reciprocal_freq = 1 / freq)
mortper_recip
tibble(
freq = mortper$freq,
spec = mortper$spec
)
mortper_recip
mortper_recip <-
tibble(
freq = mortper$freq[order(-mortper$spec)],
spec = mortper$spec[order(-mortper$spec)]
) %>%
mutate(reciprocal_freq = 1 / freq)
mortper_recip2 <-
tibble(
freq = mortper$freq,
spec = mortper$spec
) %>%
mutate(reciprocal_freq = 1 / freq)
View(mortper_recip)
View(mortper_recip2)
mortper_recip2 <-
tibble(
freq = mortper$freq,
spec = mortper$spec
) %>%
arrange(spec) %>%
mutate(reciprocal_freq = 1 / freq)
mortper_recip2 <-
tibble(
freq = mortper$freq,
spec = mortper$spec
) %>%
arrange(desc(spec)) %>%
mutate(reciprocal_freq = 1 / freq)
mortper_df <-
tibble(
freq = mortper$freq,
spec = mortper$spec
)
ggplot(data = mortper_df) +
geom_line(mapping = aes(x = 1 / freq, y = log(spec))) +
scale_x_continuous(limits = c(0, 160)) +
labs(x = "Period", y = "Log(density)") +
tsa_theme()
# Create tsa_theme from previous exercise
tsa_theme <- theme_bw() +
theme(
plot.title = element_text(face = "bold",
size = 12),
legend.background = element_rect(fill = "white",
size = 4,
colour = "white"),
# legend.justification = c(0, 1),
legend.position = "bottom",
panel.grid.minor = element_blank()
)
ggplot(data = mortper_df) +
geom_line(mapping = aes(x = 1 / freq, y = log(spec))) +
scale_x_continuous(limits = c(0, 160)) +
labs(x = "Period", y = "Log(density)") +
tsa_theme
View(mortper)
mortper_recip <-
tibble(
freq = mortper$freq,
spec = mortper$spec
) %>%
arrange(desc(spec)) %>%
mutate(reciprocal_freq = 1 / freq)
View(mortper_recip)
ggplot(data = mortper_recip, aes(x = reciprocal_freq, y = log(spec))) +
geom_line() +
scale_x_continuous(limits = c(0, 160)) +
labs(x = "Period", y = "Log(density)") +
tsa_theme
View(mortz)
mortz <- mortz %>%
mutate(sin52 = sin(2 * pi * Date / 52))
sinemodel <- glm(cases ~ sin52, family = "poisson", data = mortz)
summary(sinemodel)
ggplot(data = mortz) +
geom_point(mapping = aes(x = Date, y = cases), alpha = 0.4) +
geom_line(
mapping = aes(x = Date, y = unname(fitted(sinemodel))),
colour = "green"
) +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Index", y = "Mortality", title = "Regression model: one sine term") +
tsa_theme
ggplot(data = mortz) +
geom_point(mapping = aes(x = Date, y = cases), alpha = 0.4) +
geom_line(
mapping = aes(x = Date, y = fitted(sinemodel)),
colour = "green"
) +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Index", y = "Mortality", title = "Regression model: one sine term") +
tsa_theme
fitted(sinemodel)
ggplot(data = mortz) +
geom_point(mapping = aes(x = Date, y = cases), alpha = 0.4) +
geom_line(
mapping = aes(x = Date, y = fitted(sinemodel)),
colour = "green"
) +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Index", y = "Mortality", title = "Regression model: one sine term") +
tsa_theme
mortz <- mortz %>%
mutate(cos52 = cos(2 * pi * Date / 52))
mortz <- mortz %>%
mutate(cos52 = cos(2 * pi * Date / 52))
sinecosmodel <- glm(cases ~ sin52 + cos52, family = "poisson", data = mortz)
summary(sinecosmodel)
ggplot(data = mortz, aes(x = Date, y = cases)) +
geom_point(alpha = 0.4) +
geom_line(
mapping = aes(y = fitted(sinemodel)),
colour = "green"
) +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Index", y = "Mortality", title = "Regression model: one sine term") +
tsa_theme
ggplot(data = mortz, aes(x = Date)) +
geom_point(aes(y = cases), alpha = 0.4) +
geom_line(
mapping = aes(y = fitted(sinecosmodel)),
colour = "green"
) +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Index",
y = "Mortality",
title = "Regression model: sine, cosine terms") +
tsa_theme
sinecostrendmodel <- glm(cases ~ sin52 + cos52 + Date, family = "poisson", data = mortz)
summary(sinecostrendmodel)
ggplot(data = mortz, aes(x = Date)) +
geom_point(aes(y = cases), alpha = 0.4) +
geom_line(
mapping = aes(y = fitted(sinecostrendmodel)),
colour = "green"
) +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Index",
y = "Mortality",
title = "Regression model: trend, sine, cosine terms") +
tsa_theme
mortz <-
mortz %>%
mutate(
sin26 = sin(2 * pi * Date / 26),
cos26 = cos(2 * pi * Date / 26)
)
sine2cos2trendmodel <- glm(cases ~ sin52 + cos52 + sin26 + cos26 + Date,
family = "poisson",
data = mortz)
summary(sine2cos2trendmodel)
ggplot(data = mortz, aes(x = Date)) +
geom_point(aes(y = cases), alpha = 0.4) +
geom_line(
mapping = aes(y = fitted(sine2cos2trendmodel)),
colour = "green"
) +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Index",
y = "Mortality",
title = "Regression model with trend plus 2 sine and cosine terms") +
tsa_theme

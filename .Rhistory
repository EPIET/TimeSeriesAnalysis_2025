fill = "red",
alpha = 0.1
) +
#scale_y_continuous(limits = c(0, NA)) +
scale_x_yearweek(date_labels = "%W", date_breaks = "4 weeks") +
labs(x = "Year Week", y = "Predicted weekly cases") +
tsa_theme
ggplot(data = pred.mort) +
geom_line(
mapping = aes(x = year_week, y = pred_cases),
colour = "red",
alpha = 0.7
) +
geom_ribbon(
mapping = aes(x = year_week, ymin = lPI, ymax = uPI),
fill = "red",
alpha = 0.1
) +
#scale_y_continuous(limits = c(0, NA)) +
#scale_x_yearweek(date_labels = "%W", date_breaks = "4 weeks") +
labs(x = "Year Week", y = "Predicted weekly cases") +
tsa_theme
mortz <- mortz %>%
mutate(fit_cases = mort_sine2cos2trendmodel$fit)
mortz <-
mortz %>%
mutate(
difference = cases - fit_cases,
cusum_excess = cumsum(difference)
)
mortz
ggplot(data = mortz) +
geom_line(
mapping = aes(x = year_week, y = cusum_excess),
colour = "orange",
alpha = 0.7,
lwd = 2
) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
labs(x = "Year", y = "Cumulative excess cases") +
tsa_theme
ggplot(data = pred.mort) +
geom_line(
mapping = aes(x = year_week, y = pred_cases),
colour = "red",
alpha = 0.7
) +
geom_ribbon(
mapping = aes(x = year_week, ymin = lPI, ymax = uPI),
fill = "red",
alpha = 0.1
) +
#scale_y_continuous(limits = c(0, NA)) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "4 weeks") +
#scale_x_yearweek(date_labels = "%W", date_breaks = "4 weeks") +
labs(x = "Year Week", y = "Predicted weekly cases") +
tsa_theme
ggplot(data = pred.mort) +
geom_line(
mapping = aes(x = year_week, y = pred_cases),
colour = "red",
alpha = 0.7
) +
geom_ribbon(
mapping = aes(x = year_week, ymin = lPI, ymax = uPI),
fill = "red",
alpha = 0.1
) +
#scale_y_continuous(limits = c(0, NA)) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "4 weeks") +
#scale_x_yearweek(date_labels = "%W", date_breaks = "4 weeks") +
labs(x = "Year Week", y = "Predicted weekly cases") +
theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
tsa_theme
ggplot(data = pred.mort) +
geom_line(
mapping = aes(x = year_week, y = pred_cases),
colour = "red",
alpha = 0.7
) +
geom_ribbon(
mapping = aes(x = year_week, ymin = lPI, ymax = uPI),
fill = "red",
alpha = 0.1
) +
#scale_y_continuous(limits = c(0, NA)) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "4 weeks") +
#scale_x_yearweek(date_labels = "%W", date_breaks = "4 weeks") +
labs(x = "Year Week", y = "Predicted weekly cases") +
theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
tsa_theme
ggplot(data = pred.mort) +
geom_line(
mapping = aes(x = year_week, y = pred_cases),
colour = "red",
alpha = 0.7
) +
geom_ribbon(
mapping = aes(x = year_week, ymin = lPI, ymax = uPI),
fill = "red",
alpha = 0.1
) +
#scale_y_continuous(limits = c(0, NA)) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "4 weeks") +
#scale_x_yearweek(date_labels = "%W", date_breaks = "4 weeks") +
labs(x = "Year Week", y = "Predicted weekly cases") +
theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
tsa_theme
ggplot(data = pred.mort) +
geom_line(
mapping = aes(x = year_week, y = pred_cases),
colour = "red",
alpha = 0.7
) +
geom_ribbon(
mapping = aes(x = year_week, ymin = lPI, ymax = uPI),
fill = "red",
alpha = 0.1
) +
#scale_y_continuous(limits = c(0, NA)) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "4 weeks") +
#scale_x_yearweek(date_labels = "%W", date_breaks = "4 weeks") +
labs(x = "Year Week", y = "Predicted weekly cases") +
tsa_theme +
theme(axis.text.x = element_text(angle = 45, hjust = 1))
ggplot(data = pred.mort) +
geom_line(
mapping = aes(x = year_week, y = pred_cases),
colour = "red",
alpha = 0.7
) +
geom_ribbon(
mapping = aes(x = year_week, ymin = lPI, ymax = uPI),
fill = "red",
alpha = 0.1
) +
#scale_y_continuous(limits = c(0, NA)) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "4 weeks") +
#scale_x_yearweek(date_labels = "%W", date_breaks = "4 weeks") +
labs(x = "Year Week", y = "Predicted weekly cases") +
tsa_theme +
theme(axis.text.x = element_text(angle = 30, hjust = 1))
# Load raw data
mortagg <- import(here("data", "mortagg.csv"))
# Install pacman if not installed already, and activate it
if (!require("pacman")) install.packages("pacman")
# Install, update and activate libraries
pacman::p_load(
here,
rio,
skimr,
tsibble,
TSA,
tidyverse,
ciTools
)
# Load raw data
mortagg <- import(here("data", "mortagg.csv"))
View(mortagg)
# Prepare ts data
mortz <-
mortagg %>%
mutate(year_week = make_yearweek(year = year, week = week),
index = seq.int(from = 1, to = nrow(mortagg)),
sin52 = sin(2 * pi * week / 52),
cos52 = cos(2 * pi * week / 52),
sin26 = sin(2 * pi * week / 26),
cos26 = cos(2 * pi * week / 26)) %>%
as_tsibble(index = index)
View(mortz)
print(summary(mortz))
summary(mortz)
# Model with trend and seasonality
mort_sine2cos2trendmodel <- glm(cases ~ index + sin52 + cos52 + sin26 + cos26,
family = "poisson",
data = mortz)
summary(mort_sine2cos2trendmodel)
# Create tsa_theme from previous exercise
tsa_theme <- theme_bw() +
theme(
plot.title = element_text(face = "bold",
size = 12),
legend.background = element_rect(fill = "white",
size = 4,
colour = "white"),
# legend.justification = c(0, 1),
legend.position = "bottom",
panel.grid.minor = element_blank()
)
summary(mortz)
pred.df <-
tibble(
year=2010,
week  = 1:52,
index = 521:(521+52-1), # add 52 weeks
year_week = make_yearweek(year = year, week = week),
sin52 = sin(2 * pi * week / 52),
cos52 = cos(2 * pi * week / 52),
sin26 = sin(2 * pi * week / 26),
cos26 = cos(2 * pi * week / 26),
pob = 46951532) %>%                # Spanish pop in 2010 (1st Jan)
as_tsibble(index = index)
view(pred.df)
# apply mort_sine2cos2trendmodel to new data and predict cases with C.I. using bootstrapping.
set.seed(12589)
pred.mort <- ciTools::add_ci(pred.df,
mort_sine2cos2trendmodel,
names=c("lPI", "uPI"),
yhatName="pred_cases",
response=TRUE,
type="boot",
nSims=1000)
head(pred.mort, 5)
ggplot(data = pred.mort) +
geom_line(
mapping = aes(x = year_week, y = pred_cases),
colour = "red",
alpha = 0.7
) +
geom_ribbon(
mapping = aes(x = year_week, ymin = lPI, ymax = uPI),
fill = "red",
alpha = 0.1
) +
#scale_y_continuous(limits = c(0, NA)) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "4 weeks") +
#scale_x_yearweek(date_labels = "%W", date_breaks = "4 weeks") +
labs(x = "Year Week", y = "Predicted weekly cases") +
tsa_theme +
theme(axis.text.x = element_text(angle = 30, hjust = 1))
mortz <- mortz %>%
mutate(fit_cases = mort_sine2cos2trendmodel$fit)
mortz <-
mortz %>%
mutate(
difference = cases - fit_cases,
cusum_excess = cumsum(difference)
)
mortz
ggplot(data = mortz) +
geom_line(
mapping = aes(x = year_week, y = cusum_excess),
colour = "orange",
alpha = 0.7,
lwd = 2
) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
labs(x = "Year", y = "Cumulative excess cases") +
tsa_theme
res.std <- rstandard(sine2cos2trendmodel)
pacman::p_load(tidyverse, rio, here)
# Practical 9
aragon <- import(here("_temporal conversion files/aragon.dta"))
View(aragon)
write_csv2(aragon, here("data", "aragon.csv"))
aragon <- import(here("data", "aragon.csv"))
View(aragon)
aragonz <-
aragon %>%
mutate(date_index = make_yearweek(year = year, week = week)) %>%
as_tsibble(index = date_index)
# Install pacman if not installed already, and activate it
if (!require("pacman")) install.packages("pacman")
# Install, update and activate libraries
pacman::p_load(
here,
rio,
skimr,
tsibble,
TSA,
tidyverse,
ciTools
)
# Install, update and activate libraries
pacman::p_load(
here,
rio,
skimr,
tsibble,
TSA,
patchwork,
ciTools,
tidyverse
)
View(aragon)
aragonz <-
aragon %>%
mutate(year_week = make_yearweek(year = year, week = week),
index = seq.int(from = 1, to = nrow(aragon))) %>%
as_tsibble(index = index)
# Create tsa_theme from previous exercise
tsa_theme <- theme_bw() +
theme(
plot.title = element_text(face = "bold",
size = 12),
legend.background = element_rect(fill = "white",
size = 4,
colour = "white"),
# legend.justification = c(0, 1),
legend.position = "bottom",
panel.grid.minor = element_blank()
)
aragonz_tmax_plot <-
ggplot(data = aragonz) +
geom_point(mapping = aes(x = year_week, y = tmax), colour = "blue", alpha = 0.5) +
scale_y_continuous(limits = c(0, NA)) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
labs(x = "Week", y = "Maximum Temperature") +
tsa_theme()
aragonz_tmax_plot <-
ggplot(data = aragonz) +
geom_point(mapping = aes(x = year_week, y = tmax), colour = "blue", alpha = 0.5) +
scale_y_continuous(limits = c(0, NA)) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
labs(x = "Week", y = "Maximum Temperature") +
tsa_theme
aragonz_cases_plot <-
ggplot(data = aragonz) +
geom_point(mapping = aes(x = year_week, y = cases), colour = "green", alpha = 0.5) +
scale_y_continuous(limits = c(0, NA)) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
labs(x = "Week", y = "Weekly case counts") +
tsa_theme
aragonz_two_plot <-
(aragonz_tmax_plot / aragonz_cases_plot)
aragonz_two_plot
aragonz_tmax_plot
View(aragon)
aragon <- import(here("data", "aragon.csv"))
View(aragon)
# Practical 9
aragon <- import(here("_temporal conversion files/aragon.dta"))
View(aragon)
# Practical 9
aragon <- haven::read_dta(here("_temporal conversion files/aragon.dta"))
View(aragon)
# Practical 9
aragon <- import(here("_temporal conversion files/aragon.dta"))
aragon <- import(here("data", "aragon.csv"))
View(aragon)
View(aragon)
aragon <- aragon %>%
mutate(tmax = as.numeric(tmax))
aragon <- import(here("data", "aragon.csv"))
# Practical 9
aragon <- import(here("_temporal conversion files/aragon.dta"))
View(aragon)
any(is.na(aragon$tmax))
aragon$tmax <- as.numeric(aragon$tmax)
write_csv2(aragon, here("data", "aragon.csv"))
write_csv(aragon, here("data", "aragon.csv"))
aragon <- import(here("data", "aragon.csv"))
View(aragon)
aragonz_tmax_plot <-
ggplot(data = aragonz) +
geom_point(mapping = aes(x = year_week, y = tmax), colour = "blue", alpha = 0.5) +
scale_y_continuous(limits = c(0, NA)) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
labs(x = "Week", y = "Maximum Temperature") +
tsa_theme
aragonz <-
aragon %>%
mutate(year_week = make_yearweek(year = year, week = week),
index = seq.int(from = 1, to = nrow(aragon))) %>%
as_tsibble(index = index)
aragonz_tmax_plot <-
ggplot(data = aragonz) +
geom_point(mapping = aes(x = year_week, y = tmax), colour = "blue", alpha = 0.5) +
scale_y_continuous(limits = c(0, NA)) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
labs(x = "Week", y = "Maximum Temperature") +
tsa_theme
# Create tsa_theme from previous exercise
tsa_theme <- theme_bw() +
theme(
plot.title = element_text(face = "bold",
size = 12),
legend.background = element_rect(fill = "white",
size = 4,
colour = "white"),
# legend.justification = c(0, 1),
legend.position = "bottom",
panel.grid.minor = element_blank()
)
aragonz <-
aragon %>%
mutate(year_week = make_yearweek(year = year, week = week),
index = seq.int(from = 1, to = nrow(aragon))) %>%
as_tsibble(index = index)
aragonz_tmax_plot <-
ggplot(data = aragonz) +
geom_point(mapping = aes(x = year_week, y = tmax), colour = "blue", alpha = 0.5) +
scale_y_continuous(limits = c(0, NA)) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
labs(x = "Week", y = "Maximum Temperature") +
tsa_theme
aragonz_cases_plot <-
ggplot(data = aragonz) +
geom_point(mapping = aes(x = year_week, y = cases), colour = "green", alpha = 0.5) +
scale_y_continuous(limits = c(0, NA)) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
labs(x = "Week", y = "Weekly case counts") +
tsa_theme
aragonz_two_plot <-
(aragonz_tmax_plot / aragonz_cases_plot)
aragonz_two_plot
aragonz <-
aragonz %>%
mutate(sin52 = sin(2 * pi * date / 52),
cos52 = cos(2 * pi * date / 52))
aragmodel1 <- glm(cases ~ index + sin52 + cos52,
family = "poisson",
data = aragonz)
broom::tidy(aragmodel1)
summary(aragmodel1)
ggplot(data = aragonz) +
geom_point(mapping = aes(x = date_index, y = cases), alpha = 0.2) +
geom_line(mapping = aes(x = date_index, y = aragmodel1$fitted.values),
colour = "darkorange",
alpha = 0.7,
lwd = 1.5) +
scale_y_continuous(limits = c(0, NA)) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
labs(x = "Week", y = "Weekly case counts", title = "Cases with fitted trend") +
tsa_theme()
ggplot(data = aragonz) +
geom_point(mapping = aes(x = date_index, y = cases), alpha = 0.2) +
geom_line(mapping = aes(x = date_index, y = aragmodel1$fitted.values),
colour = "darkorange",
alpha = 0.7,
lwd = 1.5) +
scale_y_continuous(limits = c(0, NA)) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
labs(x = "Week", y = "Weekly case counts", title = "Cases with fitted trend") +
tsa_theme
ggplot(data = aragonz) +
geom_point(mapping = aes(x = year_week, y = cases), alpha = 0.2) +
geom_line(mapping = aes(x = year_week, y = aragmodel1$fitted.values),
colour = "darkorange",
alpha = 0.7,
lwd = 1.5) +
scale_y_continuous(limits = c(0, NA)) +
scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "1 year") +
labs(x = "Week", y = "Weekly case counts", title = "Cases with fitted trend") +
tsa_theme
aragonz <- aragonz %>%
mutate(winter = (week >= 49 | week <= 8))
aragmodel2 <- glm(cases ~ index + sin52 + cos52 + winter,
family = "poisson",
data = aragonz)
summary(aragmodel2)
aragmodel3 <- glm(cases ~ index + sin52 + cos52 + winter * tmax,
family = "poisson",
data = aragonz)
summary(aragmodel3)
summary(aragmodel2)
summary(aragmodel3)
AIC(aragmodel1)
AIC(c(aragmodel1, aragmodel2, aragmodel3))
AIC(aragmodel3)
# memisc::mtable(
#     'Model 2' = aragmodel2,
#     'Model 3' = aragmodel3,
#     summary.stats = c('R-squared', 'adj. R-squared', 'AIC', 'BIC', 'N')
#   )
AIC(aragmodel2)
AIC(aragmodel3)
# memisc::mtable(
#     'Model 2' = aragmodel2,
#     'Model 3' = aragmodel3,
#     summary.stats = c('R-squared', 'adj. R-squared', 'AIC', 'BIC', 'N')
#   )
AIC(aragmodel2); AIC(aragmodel3)
# memisc::mtable(
#     'Model 2' = aragmodel2,
#     'Model 3' = aragmodel3,
#     summary.stats = c('R-squared', 'adj. R-squared', 'AIC', 'BIC', 'N')
#   )
AIC(aragmodel2); AIC(aragmodel3)
aragonz <- aragonz %>%
mutate(L1.tmax = dplyr::lag(x = tmax, n = 1))
aragmodel4 <- glm(cases ~ index + sin52 + cos52 + winter * tmax + L1.tmax,
family = "poisson",
data = aragonz)
summary(aragmodel4)
## winter subset
aragonz.winter <-
aragonz %>%
filter(winter == TRUE)
## not winter subset
aragonz.notwinter <-
aragonz %>%
filter(winter == FALSE)
aragmodel5 <- glm(cases ~ index + sin52 + cos52 + winter * tmax + L1.tmax,
family = "poisson",
data = aragonz.winter)
# includes 2 weeks' temperatures
summary(aragmodel5)
aragmodel5 <- glm(cases ~ index + sin52 + cos52 + L1.tmax,
family = "poisson",
data = aragonz.winter)
aragmodel5 <- glm(cases ~ index + sin52 + cos52 + L1.tmax,
family = "poisson",
data = aragonz.winter)
# includes 2 weeks' temperatures
summary(aragmodel5)
aragmodel6 <- glm(cases ~ index + sin52 + cos52 + L1.tmax,
family = "poisson",
data = aragonz.notwinter)
# includes only last week's temperature
summary(aragmodel6)
AIC(aragmodel5); AIC(aragmodel6)

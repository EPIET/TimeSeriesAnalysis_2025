skimr,
tsibble,
ISOweek,
TSA,
tidyverse
)
mortper <- periodogram(mortz$cases)
mortper <- periodogram(mortz$cases)
str(mortper)
mortper_recip <-
tibble(
freq = mortper$freq[order(-mortper$spec)],
spec = mortper$spec[order(-mortper$spec)]
) %>%
mutate(reciprocal_freq = 1 / freq)
mortper_recip
tibble(
freq = mortper$freq,
spec = mortper$spec
)
mortper_recip
mortper_recip <-
tibble(
freq = mortper$freq[order(-mortper$spec)],
spec = mortper$spec[order(-mortper$spec)]
) %>%
mutate(reciprocal_freq = 1 / freq)
mortper_recip2 <-
tibble(
freq = mortper$freq,
spec = mortper$spec
) %>%
mutate(reciprocal_freq = 1 / freq)
View(mortper_recip)
View(mortper_recip2)
mortper_recip2 <-
tibble(
freq = mortper$freq,
spec = mortper$spec
) %>%
arrange(spec) %>%
mutate(reciprocal_freq = 1 / freq)
mortper_recip2 <-
tibble(
freq = mortper$freq,
spec = mortper$spec
) %>%
arrange(desc(spec)) %>%
mutate(reciprocal_freq = 1 / freq)
mortper_df <-
tibble(
freq = mortper$freq,
spec = mortper$spec
)
ggplot(data = mortper_df) +
geom_line(mapping = aes(x = 1 / freq, y = log(spec))) +
scale_x_continuous(limits = c(0, 160)) +
labs(x = "Period", y = "Log(density)") +
tsa_theme()
# Create tsa_theme from previous exercise
tsa_theme <- theme_bw() +
theme(
plot.title = element_text(face = "bold",
size = 12),
legend.background = element_rect(fill = "white",
size = 4,
colour = "white"),
# legend.justification = c(0, 1),
legend.position = "bottom",
panel.grid.minor = element_blank()
)
ggplot(data = mortper_df) +
geom_line(mapping = aes(x = 1 / freq, y = log(spec))) +
scale_x_continuous(limits = c(0, 160)) +
labs(x = "Period", y = "Log(density)") +
tsa_theme
View(mortper)
mortper_recip <-
tibble(
freq = mortper$freq,
spec = mortper$spec
) %>%
arrange(desc(spec)) %>%
mutate(reciprocal_freq = 1 / freq)
View(mortper_recip)
ggplot(data = mortper_recip, aes(x = reciprocal_freq, y = log(spec))) +
geom_line() +
scale_x_continuous(limits = c(0, 160)) +
labs(x = "Period", y = "Log(density)") +
tsa_theme
View(mortz)
mortz <- mortz %>%
mutate(sin52 = sin(2 * pi * Date / 52))
sinemodel <- glm(cases ~ sin52, family = "poisson", data = mortz)
summary(sinemodel)
ggplot(data = mortz) +
geom_point(mapping = aes(x = Date, y = cases), alpha = 0.4) +
geom_line(
mapping = aes(x = Date, y = unname(fitted(sinemodel))),
colour = "green"
) +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Index", y = "Mortality", title = "Regression model: one sine term") +
tsa_theme
ggplot(data = mortz) +
geom_point(mapping = aes(x = Date, y = cases), alpha = 0.4) +
geom_line(
mapping = aes(x = Date, y = fitted(sinemodel)),
colour = "green"
) +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Index", y = "Mortality", title = "Regression model: one sine term") +
tsa_theme
fitted(sinemodel)
ggplot(data = mortz) +
geom_point(mapping = aes(x = Date, y = cases), alpha = 0.4) +
geom_line(
mapping = aes(x = Date, y = fitted(sinemodel)),
colour = "green"
) +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Index", y = "Mortality", title = "Regression model: one sine term") +
tsa_theme
mortz <- mortz %>%
mutate(cos52 = cos(2 * pi * Date / 52))
mortz <- mortz %>%
mutate(cos52 = cos(2 * pi * Date / 52))
sinecosmodel <- glm(cases ~ sin52 + cos52, family = "poisson", data = mortz)
summary(sinecosmodel)
ggplot(data = mortz, aes(x = Date, y = cases)) +
geom_point(alpha = 0.4) +
geom_line(
mapping = aes(y = fitted(sinemodel)),
colour = "green"
) +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Index", y = "Mortality", title = "Regression model: one sine term") +
tsa_theme
ggplot(data = mortz, aes(x = Date)) +
geom_point(aes(y = cases), alpha = 0.4) +
geom_line(
mapping = aes(y = fitted(sinecosmodel)),
colour = "green"
) +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Index",
y = "Mortality",
title = "Regression model: sine, cosine terms") +
tsa_theme
sinecostrendmodel <- glm(cases ~ sin52 + cos52 + Date, family = "poisson", data = mortz)
summary(sinecostrendmodel)
ggplot(data = mortz, aes(x = Date)) +
geom_point(aes(y = cases), alpha = 0.4) +
geom_line(
mapping = aes(y = fitted(sinecostrendmodel)),
colour = "green"
) +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Index",
y = "Mortality",
title = "Regression model: trend, sine, cosine terms") +
tsa_theme
mortz <-
mortz %>%
mutate(
sin26 = sin(2 * pi * Date / 26),
cos26 = cos(2 * pi * Date / 26)
)
sine2cos2trendmodel <- glm(cases ~ sin52 + cos52 + sin26 + cos26 + Date,
family = "poisson",
data = mortz)
summary(sine2cos2trendmodel)
ggplot(data = mortz, aes(x = Date)) +
geom_point(aes(y = cases), alpha = 0.4) +
geom_line(
mapping = aes(y = fitted(sine2cos2trendmodel)),
colour = "green"
) +
scale_y_continuous(limits = c(0, NA)) +
labs(x = "Index",
y = "Mortality",
title = "Regression model with trend plus 2 sine and cosine terms") +
tsa_theme
# Install pacman if not installed already, and activate it
if (!require("pacman")) install.packages("pacman")
# Install, update and activate libraries
pacman::p_load(
here,
rio,
skimr,
tsibble,
TSA,
tidyverse
)
mortagg <- import(here("data", "mortagg.csv"))
mortz <-
mortagg %>%
mutate(date_index = make_yearweek(year = year, week = week)) %>%
as_tsibble(index = date_index)
mortz$Date <- seq.int(from = 1,
to = nrow(mortz))
# Create tsa_theme from previous exercise
tsa_theme <- theme_bw() +
theme(
plot.title = element_text(face = "bold",
size = 12),
legend.background = element_rect(fill = "white",
size = 4,
colour = "white"),
# legend.justification = c(0, 1),
legend.position = "bottom",
panel.grid.minor = element_blank()
)
View(mortz)
sine2cos2trendmodel <- glm(cases ~ sin52 + cos52 + sin26 + cos26 + Date,
family = "poisson",                           data = mortz)
View(mortz)
mortagg <- import(here("data", "mortagg.csv"))
mortz <-
mortagg %>%
mutate(date_index = make_yearweek(year = year, week = week),
Date = seq.int(from = 1, to = nrow(mortagg)),
sin52 = sin(2 * pi * Date / 52),
cos52 = cos(2 * pi * Date / 52),
sin26 = sin(2 * pi * Date / 26),
cos26 = cos(2 * pi * Date / 26)) %>%
as_tsibble(index = date_index)
View(mortz)
# Model with trend and seasonality
sine2cos2trendmodel <- glm(cases ~ sin52 + cos52 + sin26 + cos26 + Date,
family = "poisson",
data = mortz)
pred.df <-
tibble(
Date = 521:572,
sin52 = sin(2 * pi * Date / 52),
cos52 = cos(2 * pi * Date / 52),
sin26 = sin(2 * pi * Date / 26),
cos26 = cos(2 * pi * Date / 26)
)
View(pred.df)
pred.zoo <-
pred.df %>%
mutate(date_index = make_yearweek(year = 2010L, week = Date - 520L)) %>%
as_tsibble(index = date_index)
pred.zoo
pred.df <-
tibble(
Date = 521:572,
sin52 = sin(2 * pi * Date / 52),
cos52 = cos(2 * pi * Date / 52),
sin26 = sin(2 * pi * Date / 26),
cos26 = cos(2 * pi * Date / 26)
)
pred.zoo <-
pred.df %>%
mutate(date_index = make_yearweek(year = 2010L, week = Date - 520L)) %>%
as_tsibble(index = date_index)
pred.zoo
view(pred.zoo)
prediction <- predict(sine2cos2trendmodel,
pred.zoo,
interval = "pred"
)
pred.zoo <- bind_cols(
pred.zoo,
prediction
)
View(pred.zoo)
prediction <- predict(sine2cos2trendmodel,
pred.zoo,
interval = "pred"
)
prediction <- predict.glm(sine2cos2trendmodel,
pred.zoo,
type = "response")
prediction <- predict(sine2cos2trendmodel,
pred.zoo,
interval = "pred"
)
prediction <- predict.glm(sine2cos2trendmodel,
pred.zoo,
type = "response")
View(mortz)
prediction <- predict.glm(sine2cos2trendmodel,
pred.zoo,
type = "response", se.fit = T)
View(prediction)
pred_df <-
predict(sine2cos2trendmodel,
pred.zoo,                   type = "link", se.fit = TRUE) %>%
as_tibble() %>%
mutate(
fit = fit,
lwr = fit - 1.96 * se.fit,
upr = fit + 1.96 * se.fit,
mu = exp(fit),
mu_lwr = exp(lwr),
mu_upr = exp(upr)
)pred_df <- predict(modelo, type = "link", se.fit = TRUE) %>%
pred_df <-
predict(sine2cos2trendmodel,
pred.zoo,                   type = "link", se.fit = TRUE) %>%
as_tibble() %>%
mutate(
fit = fit,
lwr = fit - 1.96 * se.fit,
upr = fit + 1.96 * se.fit,
mu = exp(fit),
mu_lwr = exp(lwr),
mu_upr = exp(upr)
)pred_df <- predict(modelo, type = "link", se.fit = TRUE) %>%
pred_df <-
predict(sine2cos2trendmodel,
pred.zoo,
type = "link", se.fit = TRUE) %>%
as_tibble()
View(pred_df)
pred.zoo <-
predict(sine2cos2trendmodel,
pred.zoo,
type = "link", se.fit = TRUE) %>%
as_tibble() %>%
mutate(
fit = fit,
lwr = fit - 1.96 * se.fit,
upr = fit + 1.96 * se.fit
)
View(pred.zoo)
View(pred.zoo)
pred.df <-
tibble(
Date = 521:572,
sin52 = sin(2 * pi * Date / 52),
cos52 = cos(2 * pi * Date / 52),
sin26 = sin(2 * pi * Date / 26),
cos26 = cos(2 * pi * Date / 26)
)
pred.zoo <-
pred.df %>%
mutate(date_index = make_yearweek(year = 2010L, week = Date - 520L)) %>%
as_tsibble(index = date_index)
view(pred.zoo)
prediction <- predict(sine2cos2trendmodel,
pred.zoo,
type = "link", se.fit = TRUE)
pred.zoo <- pred.zoo %>%
mutate(
mu_hat = exp(prediction$fit),
lwr = exp(prediction$fit - 1.96 * prediction$se.fit),
upr = exp(prediction$fit + 1.96 * prediction$se.fit)
)
View(prediction)
View(pred.zoo)
pred.df <-
tibble(
Date = 521:572,
sin52 = sin(2 * pi * Date / 52),
cos52 = cos(2 * pi * Date / 52),
sin26 = sin(2 * pi * Date / 26),
cos26 = cos(2 * pi * Date / 26)
)
pred.zoo <-
pred.df %>%
mutate(date_index = make_yearweek(year = 2010L, week = Date - 520L)) %>%
as_tsibble(index = date_index)
pred.zoo <- pred.zoo %>%
mutate(
fit = exp(prediction$fit),
lwr = exp(prediction$fit - 1.96 * prediction$se.fit),
upr = exp(prediction$fit + 1.96 * prediction$se.fit)
)
View(pred.zoo)
head(pred.zoo, 5)
ggplot(data = pred.zoo) +
geom_line(
mapping = aes(x = date_index, y = fit),
colour = "red",
alpha = 0.7
) +
geom_ribbon(
mapping = aes(x = date_index, ymin = lwr, ymax = upr),
fill = "red",
alpha = 0.1
) +
scale_y_continuous(limits = c(0, NA)) +
scale_x_yearweek(date_labels = "%W", date_breaks = "4 weeks") +
labs(x = "Week", y = "Expected weekly cases") +
tsa_theme
ggplot(data = pred.zoo) +
geom_line(
mapping = aes(x = date_index, y = fit),
colour = "red",
alpha = 0.7
) +
geom_ribbon(
mapping = aes(x = date_index, ymin = lwr, ymax = upr),
fill = "red",
alpha = 0.1
) +
#scale_y_continuous(limits = c(0, NA)) +
scale_x_yearweek(date_labels = "%W", date_breaks = "4 weeks") +
labs(x = "Week", y = "Expected weekly cases") +
tsa_theme
ggplot(data = pred.zoo) +
geom_line(
mapping = aes(x = date_index, y = fit),
colour = "red",
alpha = 0.7
) +
geom_ribbon(
mapping = aes(x = date_index, ymin = lwr, ymax = upr),
fill = "red",
alpha = 0.1
) +
scale_y_continuous(limits = c(0, NA)) +
scale_x_yearweek(date_labels = "%W", date_breaks = "4 weeks") +
labs(x = "Week", y = "Expected weekly cases") +
tsa_theme
ggplot(data = pred.zoo) +
geom_line(
mapping = aes(x = date_index, y = fit),
colour = "red",
alpha = 0.7
) +
geom_ribbon(
mapping = aes(x = date_index, ymin = lwr, ymax = upr),
fill = "red",
alpha = 0.1
) +
#scale_y_continuous(limits = c(0, NA)) +
scale_x_yearweek(date_labels = "%W", date_breaks = "4 weeks") +
labs(x = "Week", y = "Expected weekly cases") +
tsa_theme
View(mortagg)
# Practical 4
mort <- import(here("_temporal conversion files/mortality.dta"))    # original data
mortagg <-
mort %>%
group_by(year, week) %>%
summarise(
cases = sum(cases, na.rm = T),
cases_m = sum(cases_m, na.rm = T),
cases_f = sum(cases_f, na.rm = T)
)
mortagg <-
mort %>%
group_by(year, week) %>%
summarise(
cases = sum(cases, na.rm = T),
cases_m = sum(cases_m, na.rm = T),
cases_f = sum(cases_f, na.rm = T)
) %>%
mutate(pop = rep(c(39953520, 40688520, 41423520, 42196231, 42859172,
43662613,  44360521, 45236004, 45983169, 46367550),
each = 52))
mortagg <-
mort %>%
group_by(year, week) %>%
summarise(
cases = sum(cases, na.rm = T),
cases_m = sum(cases_m, na.rm = T),
cases_f = sum(cases_f, na.rm = T)
) %>%
mutate(pop = rep(c(39953520, 40688520, 41423520, 42196231, 42859172,
43662613,  44360521, 45236004, 45983169, 46367550),
each = 10))
View(mortagg)
mortagg <-
mort %>%
group_by(year, week) %>%
summarise(
cases = sum(cases, na.rm = T),
cases_m = sum(cases_m, na.rm = T),
cases_f = sum(cases_f, na.rm = T)
) %>%
ungroup() %>%
mutate(pop = rep(c(39953520, 40688520, 41423520, 42196231, 42859172,
43662613,  44360521, 45236004, 45983169, 46367550),
each = 52))
View(mortagg)
write_csv2(mortagg, here("data", "mortagg.csv"))
# Load raw data
mortagg <- import(here("data", "mortagg.csv"))
# Prepare ts data
mortz <-
mortagg %>%
mutate(date_index = make_yearweek(year = year, week = week),
Date = seq.int(from = 1, to = nrow(mortagg)),
sin52 = sin(2 * pi * Date / 52),
cos52 = cos(2 * pi * Date / 52),
sin26 = sin(2 * pi * Date / 26),
cos26 = cos(2 * pi * Date / 26)) %>%
as_tsibble(index = date_index)
# Model with trend and seasonality
sine2cos2trendmodel <- glm(cases ~ sin52 + cos52 + sin26 + cos26 + Date,
family = "poisson",
data = mortz)
# Create tsa_theme from previous exercise
tsa_theme <- theme_bw() +
theme(
plot.title = element_text(face = "bold",
size = 12),
legend.background = element_rect(fill = "white",
size = 4,
colour = "white"),
# legend.justification = c(0, 1),
legend.position = "bottom",
panel.grid.minor = element_blank()
)
View(mortagg)
View(mortagg)

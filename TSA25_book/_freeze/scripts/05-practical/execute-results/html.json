{
  "hash": "3c2931745f27f92cc7cef8fdbd171290",
  "result": {
    "engine": "knitr",
    "markdown": "# Practical Session 5: Periodicity {.unnumbered}\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Install pacman if not installed already, and activate it\nif (!require(\"pacman\")) install.packages(\"pacman\")\n\n# Install, update and activate libraries\npacman::p_load(\n  here, \n  rio, \n  skimr,\n  tsibble,\n  TSA,\n  tidyverse\n)\n```\n:::\n\n\n## Expected learning outcomes {#learn-5 .unnumbered}\n\nBy the end of this session, participants should be able to:\n\n-   assess the existence of periodicity in surveillance data\n\n-   fit and interpret models containing a trend and one or several sine and cosine curves on surveillance data to model both trend and periodicity\n\n## Task 5.1 {#task-5-1 .unnumbered}\n\nUsing `mortagg.csv`, visually assess the existence of any periodicity in the total number of deaths (cyclical patterns). What do you think the period is, if any? Discuss your results with your peers.\n\n## Task 5.2 {#task-5-2 .unnumbered}\n\nUsing `mortagg.csv`, check statistically for the existence of periodicity. Then, fit a model on the data for the relevant period(s). How many different periods are you including in your model? Test statistically if the inclusion of more than one period contributes to the fit of the model. Discuss your results. When is mortality highest? When is it lowest? What do you think might be the reason and how would you test for that statistically?\n\n## Task 5.4 (Optional) {#task-5-4 .unnumbered}\n\nAssess the existence of periodicity in the `dis1` dataset.\n\n## Help for Task 5.1 {#solution-5-1 .unnumbered}\n\nRequired source code.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmortagg <- import(here(\"data\", \"mortagg.csv\"))\n\nmortz <-\n    mortagg %>%\n    mutate(date_index = make_yearweek(year = year, week = week)) %>%\n    as_tsibble(index = date_index)\n\nmortz$Date <- seq.int(from = 1,\n                      to = nrow(mortz))\n\n# Create tsa_theme from previous exercise\ntsa_theme <- theme_bw() + \n        theme(\n            plot.title = element_text(face = \"bold\", \n                                      size = 12),\n            legend.background = element_rect(fill = \"white\", \n                                             size = 4, \n                                             colour = \"white\"),\n            # legend.justification = c(0, 1),\n            legend.position = \"bottom\",\n            panel.grid.minor = element_blank()\n        )\n```\n:::\n\n\nR has a number of functions which produce a *periodogram* - we will use the `periodogram` function from the `TSA` package.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmortper <- TSA::periodogram(mortz$cases)\n```\n\n::: {.cell-output-display}\n![](05-practical_files/figure-html/task-5-1-periodogram-1.png){width=100%}\n:::\n\n```{.r .cell-code}\nstr(mortper)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nList of 16\n $ freq     : num [1:270] 0.00185 0.0037 0.00556 0.00741 0.00926 ...\n $ spec     : num [1:270] 5175674 4831036 218428 1858872 307221 ...\n $ coh      : NULL\n $ phase    : NULL\n $ kernel   : NULL\n $ df       : num 1.93\n $ bandwidth: num 0.000535\n $ n.used   : int 540\n $ orig.n   : int 520\n $ series   : chr \"x\"\n $ snames   : NULL\n $ method   : chr \"Raw Periodogram\"\n $ taper    : num 0\n $ pad      : num 0\n $ detrend  : logi FALSE\n $ demean   : logi TRUE\n - attr(*, \"class\")= chr \"spec\"\n```\n\n\n:::\n:::\n\n\nThe `periodogram` function plots the estimated periodogram for a given time series and also returns various useful outputs as a list which we can use for other analyses.\n\nThis type of plot is interpreted by identifying peaks. Convert the frequencies at which peaks occur to periods by taking the reciprocal.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmortper_recip <-\n    tibble(\n        freq = mortper$freq,\n        spec = mortper$spec\n    ) %>%\n    arrange(desc(spec)) %>% \n    mutate(reciprocal_freq = 1 / freq)\n\nview(mortper_recip)\n```\n:::\n\n\nThe above lines of code extract two variables (`freq` and `spec`) from the `mortper` object and place them in a `tibble` data.frame. Simultaneously, both columns values are order by descending order of the spectral variable.\n\nIt allows to find the frequencies with the highest peaks in the periodogram and converts those frequencies to periods (which are numbers of weeks for this data). The reciprocal values are calculated and stored on the `reciprocal_freq` variable\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = mortper_recip, aes(x = reciprocal_freq, y = log(spec))) +\n    geom_line() +\n    scale_x_continuous(limits = c(0, 160)) +\n    labs(x = \"Period\", \n         y = \"Log(density)\") +\n    tsa_theme\n```\n\n::: {.cell-output-display}\n![](05-practical_files/figure-html/task-5-1-periodogram-epergram-tidy-1.png){width=100%}\n:::\n:::\n\n\nIs there any periodicity? If so, what is the period?\n\n## Help for Task 5.2 {#solution-5-2 .unnumbered}\n\nAs the periodogram shows periodicity close to 52 weeks, we will use a *sine curve* of a 52-week period. Note that periodicity with a *period of* *one year is also referred to as seasonality*.\n\nFit a poisson regression of `cases` with a sine predictor term:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmortz <- mortz %>%\n  mutate(sin52 = sin(2 * pi * Date / 52))\n\n\nsinemodel <- glm(cases ~ sin52, family = \"poisson\", data = mortz)\nsummary(sinemodel)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nglm(formula = cases ~ sin52, family = \"poisson\", data = mortz)\n\nCoefficients:\n             Estimate Std. Error  z value Pr(>|z|)    \n(Intercept) 8.4448444  0.0006434 13125.31   <2e-16 ***\nsin52       0.0690217  0.0009096    75.88   <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for poisson family taken to be 1)\n\n    Null deviance: 32912  on 519  degrees of freedom\nResidual deviance: 27149  on 518  degrees of freedom\nAIC: 32497\n\nNumber of Fisher Scoring iterations: 4\n```\n\n\n:::\n:::\n\n\nPlot the fitted values against the original data and comment.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = mortz, aes(x = Date)) +\n    geom_point(aes(y = cases), alpha = 0.4) +\n    geom_line(\n        mapping = aes(y = fitted(sinemodel)),\n        colour = \"green\"\n    ) +\n    scale_y_continuous(limits = c(0, NA)) +\n    labs(x = \"Index\", \n         y = \"Mortality\", \n         title = \"Regression model: one sine term\") +\n    tsa_theme\n```\n\n::: {.cell-output-display}\n![](05-practical_files/figure-html/task-5-2-sin52-plot-tidy-1.png){width=100%}\n:::\n:::\n\n\n*Addition of the cosine* - In order to have an appropriate phase in your model (you don't have to worry about identifying it; this will happen automatically), you need to use *both* a sine and a cosine curve with the same period. The sum of these two curves gives the periodicity for the specified period and the phase best describing our data.\n\nYou can fit a linear model for the cases, using sine and cosine as explanatory variables. Plot the fitted values against the data and comment:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmortz <- mortz %>%\n  mutate(cos52 = cos(2 * pi * Date / 52))\n\nsinecosmodel <- glm(cases ~ sin52 + cos52, family = \"poisson\", data = mortz)\nsummary(sinecosmodel)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nglm(formula = cases ~ sin52 + cos52, family = \"poisson\", data = mortz)\n\nCoefficients:\n             Estimate Std. Error  z value Pr(>|z|)    \n(Intercept) 8.4420640  0.0006452 13084.63   <2e-16 ***\nsin52       0.0691176  0.0009103    75.93   <2e-16 ***\ncos52       0.1054644  0.0009110   115.77   <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for poisson family taken to be 1)\n\n    Null deviance: 32912  on 519  degrees of freedom\nResidual deviance: 13719  on 517  degrees of freedom\nAIC: 19069\n\nNumber of Fisher Scoring iterations: 3\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = mortz, aes(x = Date)) +\n    geom_point(aes(y = cases), alpha = 0.4) +\n    geom_line(\n        mapping = aes(y = fitted(sinecosmodel)),\n        colour = \"green\"\n    ) +\n    scale_y_continuous(limits = c(0, NA)) +\n    labs(x = \"Index\", \n         y = \"Mortality\", \n         title = \"Regression model: sine, cosine terms\") +\n    tsa_theme\n```\n\n::: {.cell-output-display}\n![](05-practical_files/figure-html/task-5-2-sin52-cos52-plot-tidy-1.png){width=100%}\n:::\n:::\n\n\nHow does the fit look graphically?\n\nNow adjust not only for periodicity, but also for trend:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsinecostrendmodel <- glm(cases ~ sin52 + cos52 + Date, family = \"poisson\", data = mortz)\nsummary(sinecostrendmodel)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nglm(formula = cases ~ sin52 + cos52 + Date, family = \"poisson\", \n    data = mortz)\n\nCoefficients:\n             Estimate Std. Error z value Pr(>|z|)    \n(Intercept) 8.397e+00  1.306e-03 6430.72   <2e-16 ***\nsin52       7.204e-02  9.132e-04   78.88   <2e-16 ***\ncos52       1.053e-01  9.110e-04  115.63   <2e-16 ***\nDate        1.716e-04  4.294e-06   39.97   <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for poisson family taken to be 1)\n\n    Null deviance: 32912  on 519  degrees of freedom\nResidual deviance: 12121  on 516  degrees of freedom\nAIC: 17473\n\nNumber of Fisher Scoring iterations: 3\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = mortz, aes(x = Date)) +\n    geom_point(aes(y = cases), alpha = 0.4) +\n    geom_line(\n        mapping = aes(y = fitted(sinecostrendmodel)),\n        colour = \"green\"\n    ) +\n    scale_y_continuous(limits = c(0, NA)) +\n    labs(x = \"Index\", \n         y = \"Mortality\", \n         title = \"Regression model: trend, sine, cosine terms\") +\n    tsa_theme\n```\n\n::: {.cell-output-display}\n![](05-practical_files/figure-html/task-5-2-sin52-cos52-trend-plot-tidy-1.png){width=100%}\n:::\n:::\n\n\n*A model with a trend plus 2 sine and 2 cosine curves* - To fit the model better, we could try to add more sine/cosine curves, of a period corresponding to the second strongest peak in the model (26 weeks). This will allow for cycles (periods) of not only 52, but also 26 weeks, should we think there might be half-yearly cycles which are relevant. In this case, for instance, there may be elevated mortality in winter, but also in summer during heatwaves.\n\nGenerate sine and cosine terms with a period of 26 weeks and name them `sin26` and `cos26`. Add these two new terms to the previous model.\n\nPlot the results, compare with the previous model and comment on it.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmortz <-\n    mortz %>%\n    mutate(\n        sin26 = sin(2 * pi * Date / 26),\n        cos26 = cos(2 * pi * Date / 26)\n    )\n\nsine2cos2trendmodel <- glm(cases ~ sin52 + cos52 + sin26 + cos26 + Date,\n                           family = \"poisson\", \n                           data = mortz)\nsummary(sine2cos2trendmodel)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nglm(formula = cases ~ sin52 + cos52 + sin26 + cos26 + Date, family = \"poisson\", \n    data = mortz)\n\nCoefficients:\n             Estimate Std. Error z value Pr(>|z|)    \n(Intercept) 8.395e+00  1.307e-03 6422.75   <2e-16 ***\nsin52       7.216e-02  9.253e-04   77.98   <2e-16 ***\ncos52       1.020e-01  9.026e-04  113.01   <2e-16 ***\nsin26       3.000e-02  9.116e-04   32.91   <2e-16 ***\ncos26       4.493e-02  9.110e-04   49.32   <2e-16 ***\nDate        1.765e-04  4.298e-06   41.07   <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for poisson family taken to be 1)\n\n    Null deviance: 32911.6  on 519  degrees of freedom\nResidual deviance:  8605.4  on 514  degrees of freedom\nAIC: 13962\n\nNumber of Fisher Scoring iterations: 3\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = mortz, aes(x = Date)) +\n    geom_point(aes(y = cases), alpha = 0.4) +\n    geom_line(\n        mapping = aes(y = fitted(sine2cos2trendmodel)),\n        colour = \"green\"\n    ) +\n    scale_y_continuous(limits = c(0, NA)) +\n    labs(x = \"Index\", \n         y = \"Mortality\", \n         title = \"Regression model with trend plus 2 sine and cosine terms\") +\n    tsa_theme\n```\n\n::: {.cell-output-display}\n![](05-practical_files/figure-html/task-5-2-sin26-cos26-trend-plot-tidy-1.png){width=100%}\n:::\n:::\n\n\nIs the addition of variables `sin26` and `cos26` a statistically significant contribution to your model?\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndrop1(sine2cos2trendmodel, test = \"F\") %>% broom::tidy()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 Ã— 6\n  term      df deviance    AIC statistic    p.value\n  <chr>  <dbl>    <dbl>  <dbl>     <dbl>      <dbl>\n1 <none>    NA    8605. 13962.      NA   NA        \n2 sin52      1   14698. 20052.     364.   9.69e- 62\n3 cos52      1   21427. 26781.     766.   6.87e-104\n4 sin26      1    9688. 15043.      64.7  6.10e- 15\n5 cos26      1   11039. 16393.     145.   1.20e- 29\n6 Date       1   10293. 15647.     101.   8.90e- 22\n```\n\n\n:::\n:::\n\n\nThe `drop1` function here shows whether any variables can be dropped from the linear regression model. A significant $p$ value suggests that a variable is important and should not be dropped.\n",
    "supporting": [
      "05-practical_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}
{
  "hash": "8b712a5a5a36aaf38c0e9d764fe2e9d4",
  "result": {
    "engine": "knitr",
    "markdown": "# Practical Session 5: Periodicity {.unnumbered}\n\n## Periodicity {#title-5 .unnumbered}\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Install pacman if not installed already, and activate it\nrm(list=ls())\n\nif (!require(\"pacman\")) install.packages(\"pacman\")\n\n# Install, update and activate libraries\npacman::p_load(\n  here, \n  rio, \n  skimr,\n  tsibble,\n  TSA,\n  tidyverse,\n  season,\n  lmtest\n)\n\n# Create tsa_theme from previous exercise to be used in ggplot.\ntsa_theme <- theme_bw() + \n        theme(\n            plot.title = element_text(face = \"bold\", \n                                      size = 12),\n            legend.background = element_rect(fill = \"white\", \n                                             size = 4, \n                                             colour = \"white\"),\n            # legend.justification = c(0, 1),\n            legend.position = \"bottom\",\n            panel.grid.minor = element_blank()\n        )\n```\n:::\n\n\n## Expected learning outcomes {#learn-5 .unnumbered}\n\nBy the end of this session, participants should be able to:\n\n-   assess the existence of periodicity in surveillance data\n\n-   fit and interpret models containing a trend and one or several sine and cosine curves on surveillance data to model both trend and periodicity\n\n## Task 5.1 {#task-5-1 .unnumbered}\n\nUsing `mortagg2_case_4.RData` (created in Practical 4), visually assess the existence of any periodicity in the total number of deaths (cyclical patterns). What do you think the period is, if any? Discuss your results with your peers.\n\n## Task 5.2 {#task-5-2 .unnumbered}\n\nUsing `mortagg`, check statistically for the existence of trend and periodicity. Then, fit a model on the data with a trend and then the relevant period(s).\n\nHow many different periods are you including in your model? Test statistically if the inclusion of more than one period contributes to the fit of the model. Discuss your results.\n\nDuring the year, when is mortality highest? When is it lowest? What do you think might be the reason and how would you test for that statistically?\n\n## Task 5.4 (Optional) {#task-5-4 .unnumbered}\n\nAssess the existence of periodicity in the `dis1` dataset.\n\n## Help for Task 5.1 {#solution-5-1 .unnumbered}\n\nRequired source code.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Read data\nload(here(\"data\", \"mortagg2_case_4.RData\"))\n```\n:::\n\n\nStep 1)\n\nExplore the time series. The function decompose() decomposes the time series by applying loess to the series; loess is a smoothing method (https://en.wikipedia.org/wiki/Local_regression).\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# format the data to a time series object using ts().\nmortz.ts  <- ts(mortz$cases, frequency=52, start=c(2010,1))\n\nplot(decompose(mortz.ts))\n```\n\n::: {.cell-output-display}\n![](05-practical_files/figure-html/task-5-1-explore-1.png){width=100%}\n:::\n:::\n\n\nDiscuss the panels obtained. What features seem to be relevant?\n\nStep 2)\n\nThis step has already been done in case study 4. Run the code in order to have at hand the results and be able to compare later with other models.\n\nWe start by inspecting if there is a trend in the data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmort_trend <- glm(cases ~ index, family = \"poisson\", data = mortz)\n\nsummary(mort_trend)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nglm(formula = cases ~ index, family = \"poisson\", data = mortz)\n\nCoefficients:\n             Estimate Std. Error z value Pr(>|z|)    \n(Intercept) 8.910e+00  1.007e-03 8850.25   <2e-16 ***\nindex       1.895e-04  3.302e-06   57.39   <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for poisson family taken to be 1)\n\n    Null deviance: 62509  on 520  degrees of freedom\nResidual deviance: 59215  on 519  degrees of freedom\nAIC: 64841\n\nNumber of Fisher Scoring iterations: 4\n```\n\n\n:::\n\n```{.r .cell-code}\n# incidence rate ratio per week:\nIRR_week <- exp(coef(mort_trend))\nIRR_week\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n(Intercept)       index \n7408.911392    1.000189 \n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = mortz, aes(x = date_index)) +\n    geom_point(aes(y = cases), alpha = 0.4) +\n    geom_line(\n        mapping = aes(y = fitted(mort_trend)),\n        colour = \"green\",\n        lwd=1.5\n    ) +\n  scale_x_yearweek(date_labels = \"%Y-%W\", \n                   date_breaks = \"1 year\") +\n    scale_y_continuous(limits = c(0, NA)) +\n    labs(x = \"Index\", \n         y = \"Number of deaths\", \n         title = \"Regression model: trend\") +\n    tsa_theme\n```\n\n::: {.cell-output-display}\n![](05-practical_files/figure-html/task-5-2-sin52-cos52-plot-tidy-1.png){width=100%}\n:::\n:::\n\n\nInterpret the weekly incidence rate ratio (IRR).\n\nStep 3)\n\nAs there seems to be some periodicity in the first exploration, we proceed to inspect if there is a seasonality component in the time series. Seasonality, periodicity both refer to reoccurring patterns in the data.\n\nR has a number of functions which produce a *periodogram* - we will use the `periodogram` function from the `TSA` package.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmort_period <- TSA::periodogram(mortz$cases)\n```\n\n::: {.cell-output-display}\n![](05-practical_files/figure-html/task-5-1-periodogram-1.png){width=100%}\n:::\n:::\n\n\nThe `periodogram` function plots the estimated periodogram for a given time series and also returns various useful outputs as a list which we can use for other analyses.\n\nThis type of plot is interpreted by identifying peaks. Convert the frequencies at which peaks occur to periods by taking the reciprocal.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmort_period_recip <-\n    tibble(\n        freq = mort_period$freq,\n        spec = mort_period$spec\n    ) %>%\n    arrange(desc(spec)) %>% \n    mutate(reciprocal_freq = 1 / freq)  # here in weeks\n\nview(mort_period_recip)\n```\n:::\n\n\nThe above lines of code extract two variables (`freq` and `spec`) from the `mort_period_recip` object and place them in a `tibble` data.frame. Both columns are ordered in descending order of the spectral variable. At the top of the table we find the strongest spectral signal, as well as at what periodicity does it appear (see reciprocal frequency). Observe that the reciprocal frequency is in the same units as the data, in this case is in\\\nweeks.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# breaks every 13, equivalent to every 3 months approximately.\n\nggplot(data = mort_period_recip, aes(x = reciprocal_freq, y = 2*spec)) +\n    geom_line() +\n    scale_x_continuous(limits = c(0, 160), breaks=seq(0, 160, 13)) +\n    labs(x = \"Period (weeks)\", \n         y = \"Spectral density\") +\n    tsa_theme\n```\n\n::: {.cell-output-display}\n![](05-practical_files/figure-html/task-5-1-periodogram-plot-tidy-1.png){width=100%}\n:::\n:::\n\n\nWhat is the main periodicity in the mortality data? (use the plot and the table of mort_period_recip).\n\nIs there another periodicity that is worth checking out?\n\n## Help for Task 5.2 {#solution-5-2 .unnumbered}\n\nAs the periodogram shows periodicity close to 52 weeks, we will use a *sine curve* of a 52-week period. Note that periodicity with a *period of* *one year is also referred to as seasonality*.\n\nFit a poisson regression of `cases` with only sine and cosine predictor terms. In order to have an appropriate phase in your model (you do not have to worry about identifying it; this will happen automatically), you need to use *both* a sine and a cosine curve with the same period. The sum of these two curves gives the periodicity for the specified period and the phase best describing our data.\n\nThe function cosinor fits a model with sinus and cosinus. You need to specify the unit of time as well as the number of cycles per year. Here the data is weekly, and we assume that there is one cycle per year since we assume a 52-week period.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# cosinor() only works with data.frames, not tibble.\nmortz.df <- as.data.frame(mortz)\n\nmort_sincos <-  cosinor(cases ~ 1, date = \"week\", \n                            data = mortz.df, type = \"weekly\", cycles=1,\n                            family = poisson())\n\nsummary(mort_sincos)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n              Length Class  Mode     \ncall           13    -none- call     \nglm            30    glm    list     \nfitted.plus   521    -none- numeric  \nfitted.values 521    -none- numeric  \nresiduals     521    -none- numeric  \ndate            1    -none- character\n```\n\n\n:::\n\n```{.r .cell-code}\nsummary(mort_sincos$glm)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nglm(formula = f, family = family, data = data, offset = offset)\n\nCoefficients:\n             Estimate Std. Error  z value Pr(>|z|)    \n(Intercept) 8.9557059  0.0004987 17956.87   <2e-16 ***\ncosw        0.1208466  0.0007047   171.50   <2e-16 ***\nsinw        0.0668199  0.0007027    95.08   <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for poisson family taken to be 1)\n\n    Null deviance: 62509  on 520  degrees of freedom\nResidual deviance: 23972  on 518  degrees of freedom\nAIC: 29600\n\nNumber of Fisher Scoring iterations: 3\n```\n\n\n:::\n\n```{.r .cell-code}\n# Sinus and cosinus curves\nggplot(data=mort_sincos$glm$data, aes(x=week, y=sinw)) +\n    geom_line() +\n    geom_line(aes(x=week, y=cosw)) +\n    scale_x_continuous(limits = c(1, 53)) +\n    labs(x = \"Period (weeks)\", \n         y = \"sincos\") +\n    tsa_theme\n```\n\n::: {.cell-output-display}\n![](05-practical_files/figure-html/task-5-2-sin52-cos52-1.png){width=100%}\n:::\n\n```{.r .cell-code}\nggplot(data = mortz, aes(x = date_index)) +\n    geom_point(aes(y = cases), alpha = 0.4) +\n    geom_line(\n        mapping = aes(y = fitted(mort_sincos)),\n        colour = \"green\",\n        lwd=1.5\n    ) +\n    scale_y_continuous(limits = c(0, NA)) +\n  scale_x_yearweek(date_labels = \"%Y-%W\", \n                   date_breaks = \"1 year\") +\n    labs(x = \"Index\", \n         y = \"Number of deaths\", \n         title = \"Regression model: sin, cos terms\") +\n    tsa_theme\n```\n\n::: {.cell-output-display}\n![](05-practical_files/figure-html/task-5-2-sin52-cos52-2.png){width=100%}\n:::\n\n```{.r .cell-code}\n# Plot residuals\nplot(mort_sincos$res)\n```\n\n::: {.cell-output-display}\n![](05-practical_files/figure-html/task-5-2-sin52-cos52-3.png){width=100%}\n:::\n:::\n\n\nWhen you inspect the residuals of the model with only sinus and cosinus terms, what do you observe?\n\nIn the next model include a trend and the seasonality. We will calculate the sinus and cosinus by hand.\n\nAdd a line with the fitted values of the model with only sine and cosine terms.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# calculate the sine and cosine terms.\n\nmortz <- mortz %>%\n  mutate(cos52 = cos(2 * pi * index / 52),\n         sin52 = sin(2 * pi * index / 52))\n\nmort_trendsincos <- glm(cases ~ index + sin52 + cos52, family = \"poisson\", data = mortz)\n\nsummary(mort_trendsincos)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nglm(formula = cases ~ index + sin52 + cos52, family = \"poisson\", \n    data = mortz)\n\nCoefficients:\n             Estimate Std. Error z value Pr(>|z|)    \n(Intercept) 8.898e+00  1.012e-03 8792.82   <2e-16 ***\nindex       2.184e-04  3.311e-06   65.97   <2e-16 ***\nsin52       9.137e-02  7.066e-04  129.29   <2e-16 ***\ncos52       1.061e-01  7.033e-04  150.88   <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for poisson family taken to be 1)\n\n    Null deviance: 62509  on 520  degrees of freedom\nResidual deviance: 19668  on 517  degrees of freedom\nAIC: 25298\n\nNumber of Fisher Scoring iterations: 3\n```\n\n\n:::\n\n```{.r .cell-code}\nggplot(data = mortz, aes(x = date_index)) +\n    geom_point(aes(y = cases), alpha = 0.4) +\n    geom_line(\n        mapping = aes(y = fitted(mort_trendsincos)),\n        colour = \"green\",\n        lwd=1.5\n    ) +\n    scale_y_continuous(limits = c(0, NA)) +\n  scale_x_yearweek(date_labels = \"%Y-%W\", \n                   date_breaks = \"1 year\") +\n    labs(x = \"Index\", \n         y = \"Number of deaths\", \n         title = \"Regression model: trend, sin, cos terms\") +\n    tsa_theme\n```\n\n::: {.cell-output-display}\n![](05-practical_files/figure-html/task-5-2-trend-sin52-cos52-1.png){width=100%}\n:::\n\n```{.r .cell-code}\n# Plot residuals\nplot(mort_trendsincos$residual)\n```\n\n::: {.cell-output-display}\n![](05-practical_files/figure-html/task-5-2-trend-sin52-cos52-2.png){width=100%}\n:::\n:::\n\n\nHow does the fit look visually? Which models seems to fit better?\n\nWhat do you observe in the plot of residuals?\n\nTo fit the model better, we could try to add more sine/cosine curves, of a period corresponding to the second strongest peak in the model (26 weeks). This will allow for cycles (periods) of not only 52, but also 26 weeks, should we think there might be half-yearly cycles which are relevant. In this case, for instance, there may be elevated mortality in winter, but also in summer during heatwaves.\n\nGenerate sine and cosine terms with a period of 26 weeks and name them `sin26` and `cos26`. Add these two new terms to the previous model.\n\nPlot the results, compare with the previous model and comment on it.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmortz <-\n    mortz %>%\n    mutate(\n        sin26 = sin(2 * pi * index / 26),\n        cos26 = cos(2 * pi * index / 26)\n    )\n\nmort_trendsin2cos2 <- glm(cases ~ index + sin52 + cos52 + sin26 + cos26,\n                           family = \"poisson\", \n                           data = mortz)\n                           \nsummary(mort_trendsin2cos2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nglm(formula = cases ~ index + sin52 + cos52 + sin26 + cos26, \n    family = \"poisson\", data = mortz)\n\nCoefficients:\n             Estimate Std. Error z value Pr(>|z|)    \n(Intercept) 8.895e+00  1.013e-03 8779.51   <2e-16 ***\nindex       2.265e-04  3.313e-06   68.35   <2e-16 ***\nsin52       9.034e-02  7.142e-04  126.48   <2e-16 ***\ncos52       1.021e-01  6.994e-04  145.94   <2e-16 ***\nsin26       5.075e-02  7.054e-04   71.94   <2e-16 ***\ncos26       3.298e-02  7.034e-04   46.88   <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for poisson family taken to be 1)\n\n    Null deviance: 62509  on 520  degrees of freedom\nResidual deviance: 12288  on 515  degrees of freedom\nAIC: 17922\n\nNumber of Fisher Scoring iterations: 3\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = mortz, aes(x = date_index)) +\n    geom_point(aes(y = cases), alpha = 0.4) +\n    geom_line(\n        mapping = aes(y = fitted(mort_trendsin2cos2)),\n        colour = \"green\",\n        lwd=1.5\n    ) +\n    scale_y_continuous(limits = c(0, NA)) +\n  scale_x_yearweek(date_labels = \"%Y-%W\", \n                   date_breaks = \"1 year\") +\n    labs(x = \"Index\", \n         y = \"Number of deaths\", \n         title = \"Regression model: trend, sin52, cos52, sin26, cos26 terms\") +\n    tsa_theme\n```\n\n::: {.cell-output-display}\n![](05-practical_files/figure-html/task-5-2-sin26-cos26-trend-plot-tidy-1.png){width=100%}\n:::\n\n```{.r .cell-code}\n# Plot residuals\nplot(mort_trendsin2cos2$res)\n```\n\n::: {.cell-output-display}\n![](05-practical_files/figure-html/task-5-2-sin26-cos26-trend-plot-tidy-2.png){width=100%}\n:::\n:::\n\n\nIs the addition of variables `sin26` and `cos26` a statistically significant contribution to your model?\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# likelihood ratio test: compares two nested models\n\n# test sin26 and cos26\nlrtest(mort_trendsincos, mort_trendsin2cos2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nLikelihood ratio test\n\nModel 1: cases ~ index + sin52 + cos52\nModel 2: cases ~ index + sin52 + cos52 + sin26 + cos26\n  #Df   LogLik Df Chisq Pr(>Chisq)    \n1   4 -12644.9                        \n2   6  -8954.9  2  7380  < 2.2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n:::\n\n\nThe likelihood ratio test compares two nested models, that is, models with the same variables and data, where one model has additional variables. Here,\\\nthe only difference between mort_trendsincos and mort_trendsin2cos2 are the sine and cosine at 26 weeks. If the test results in a significant p-value, then the additional variables improve the model significantly, and there is a better fit with the additional variables.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsave(list = ls(pattern = 'mort'), file = here(\"data\", \"mortagg2_case_5.RData\"))\n\n#load(here(\"data\",\"mortagg2_case_5.RData\"))\n```\n:::\n\n",
    "supporting": [
      "05-practical_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}
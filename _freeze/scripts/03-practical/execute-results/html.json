{
  "hash": "840f928fadb410cac5b806fa55c8460f",
  "result": {
    "engine": "knitr",
    "markdown": "# Practical Session 3: Managing date formats and plotting {.unnumbered}\n\n## Session inject {#learning-3 .unnumbered}\n\nYou have been provided with one MS Excel file (`tsa_practice.xlsx`) containing 2 sheets, one for each of two different diseases (**dis1**, **dis2**); and one csv file (`tsa_pumala.csv`) about Puumala virus infections in Finland.\n\n### Expected Learning Outcomes\n\nBy the end of the session, participants should be able to:\n\n-   Manage surveillance datasets with different date formats\n\n-   Create specific time series objects using `tsibble`\n\n-   Plot surveillance data against time\n\n### Source code\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Install pacman if not installed already, and activate it\nif (!require(\"pacman\")) install.packages(\"pacman\")\n\n# Install, update and activate libraries\npacman::p_load(\n  here, \n  rio, \n  skimr,\n  tsibble,\n  ISOweek,\n  tidyverse\n)\n```\n:::\n\n\n## 3.1 - Visualization exercise\n\n-   **Objective**: to assess visually the reported number of cases of dis1 by ISO (epidemiological) week or calendar month for all the data provided. What diseases do you think dis1 is, judging from the cases' distribution in time?\n\n### Import and explore data\n\nBegin with importing your data to R from these Excel/CSV files and examine them using the well-known `str`, `summary` and `skim` functions\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndis1 <- import(here(\"data\", \"tsa_practice.xlsx\"), which = \"dis1\")\n```\n:::\n\n\n\n\nSince we will work with time series data, we could use some time to explore the most relevant variable: **date** (in this case, the `year` variable). `dis1` is a dataset containing weekly counts of a certain disease between 1981 and 1989. A typical year has 52 weeks, thus we can count the number of times each year appear in the data using `table`, `tabyl` or `count` function, your go-to tools for categorical variables\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntable(dis1$year)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n1981 1982 1983 1984 1985 1986 1987 1988 1989 \n  52   52   52   52   52   52   52   52   15 \n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\njanitor::tabyl(dis1$year)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n dis1$year  n    percent\n      1981 52 0.12064965\n      1982 52 0.12064965\n      1983 52 0.12064965\n      1984 52 0.12064965\n      1985 52 0.12064965\n      1986 52 0.12064965\n      1987 52 0.12064965\n      1988 52 0.12064965\n      1989 15 0.03480278\n```\n\n\n:::\n:::\n\n\nEach one provides different outputs and possesses unique capabilities. In general, `tabyl` should be your preferred basic function, thanks to its tidy integration and format output. It also enables some customization and data manipulation.\n\n### Time series data format\n\nR has a collection of packages for handling time series data. Some of these packages are part of the `tidyverse` family of packages. Particularly, it includes the `tsibble` package, which intends to create a data infrastructure for easier manipulation and handling of temporal data, and adapts the [principles of tidy data](https://tidyr.tidyverse.org/articles/tidy-data.html)).\n\nAccording to the help description, a `tsibble` object is defined by\n\n-   An `index`, as a variable with inherent ordering from past to present. Mandatory for a ts object\n\n-   A `key`, as a set of variables that define observational units over time, i.e. region, state, age group, etc.. Optional for a ts object\n\n-   Uniquely identified observations by an index and a key (if defined).\n\nTo convert the original `dis1` dataset to a `tsibble` object, we use the `as_tsibble()` function and specify the `index`, i.e. the variable specifying the time unit of interest (`year` and `week` variables in our case). We are not using `key` variables for now. Variables that are not used for index or key purposes, such as the `cases` variables, are considered as measured variables.\n\nTo define the index, we can make use of the `tsibble` built-in functions such as `make_yearweek` (or yearmonth, yearquarter, etc., see documentation)\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndis1_ts <- dis1 %>%\n  mutate(date_index = make_yearweek(year = year, week = week)) %>%\n  as_tsibble(index = date_index)\n\nhead(dis1_ts, 5)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tsibble: 5 x 4 [1W]\n   year  week cases date_index\n  <dbl> <dbl> <dbl>     <week>\n1  1981     1     1   1981 W01\n2  1981     2     3   1981 W02\n3  1981     3    NA   1981 W03\n4  1981     4     4   1981 W04\n5  1981     5     3   1981 W05\n```\n\n\n:::\n:::\n\n\nYou can see how the number of dis1 cases is distributed in time using the `ggplot` package.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = dis1_ts) +\n    geom_line(mapping = aes(x = date_index, y = cases)) +\n    scale_x_yearweek(date_labels = \"%Y\") +\n    labs(x = \"Date\", y = \"Number of Cases\", title = \"Disease 1 data\") +\n    theme_bw() + \n        theme(\n            plot.title = element_text(face = \"bold\", \n                                      size = 12),\n            legend.background = element_rect(fill = \"white\", \n                                             size = 4, \n                                             colour = \"white\"),\n            # legend.justification = c(0, 1),\n            legend.position = \"bottom\",\n            panel.grid.minor = element_blank()\n        )\n```\n\n::: {.cell-output-display}\n![](03-practical_files/figure-html/task-3-1-plot-tsibble-week-tidy-1.png){width=100%}\n:::\n:::\n\n\n**One tip**: if you design ggplot themes through more complex `theme()` customizations, you can save it in an object and later use it in your plots. This way, you only need to write the code once which helps keeping the consistency across your entire plots\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# We can save theme modifications into a single object and then use it in new plots\ntsa_theme <- theme_bw() + \n        theme(\n            plot.title = element_text(face = \"bold\", \n                                      size = 12),\n            legend.background = element_rect(fill = \"white\", \n                                             size = 4, \n                                             colour = \"white\"),\n            # legend.justification = c(0, 1),\n            legend.position = \"bottom\",\n            panel.grid.minor = element_blank()\n        )\n```\n:::\n\n\nNote from the plot that there are missing values in the data.\n\nIf data points are collected at regular time interval, we can correct missing data by providing a default value or interpolating missing values from other data. The `tsibble` package has the `fill_gaps` function, which fills missing values with a pre-specified default value. It is quite common to replaces `NA`s with its previous observation for each time point in a time series analysis, which is easily done using the `fill` function from `tidyr` package.\n\nA quick overview of implicit missing values with `tsibble` is available on `vignette(\"implicit-na\")`.\n\n::: callout-note\nFor time series data visualization, there are specific packages and functions you can use. As the focus of this training is on understanding principles of time series analysis rather than visualisation of time series, we will mainly use the `ggplot` functions for the remaining exercises (also so you get to practise more complex plots)\n:::\n\n### Pumala data\n\nLet's now work with the Pumala data\n\n\n\nHere you have one variable for the year, one variable for the month and one variable with the complete date in days, but in a text (`chr` class) format.\n\nWith the complete date, you can generate ISO weeks, but first you need the date variable to be converted from text to something R recognises as a date. The `lubridate` package has a number of convenient functions for converting text strings to dates.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndis3 <- dis3 %>%\n  mutate(my_date = dmy(date_str))\n\nstr(dis3$my_date)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n Date[1:3844], format: \"1995-01-02\" \"1995-01-02\" \"1995-01-03\" \"1995-01-03\" \"1995-01-04\" ...\n```\n\n\n:::\n:::\n\n\nAs a complementary note, check the help for `strftime` to learn about different date formats in R (`?strftime`).\n\nTo convert to ISO week, we can use the `ISOweek` function from the `ISOweek` package, which creates a new variable representing the ISO week. We could then also create a new variable representing the first Monday of each ISO week. Although the popular `lubridate` package has an `isoweek` function (there is also a similar function in the `surveillance` package), we use the `ISOweek` package here as it has the `ISOweek2date` function. If epidemiological weeks are required, use the `EpiWeek` package.\n\n\n\nThe `paste` command concatenates text.\n\nHere we are adding `\"-01\"` onto the end of the ISO week variable (which is formatted something like `\"1995-W01\"`), to indicate that we want the first day of that week, and then supplying that to the `ISOweek2date` function, which converts that to a date.\n\nHave a look at the new variables that have been created. `date_isowk` is the ISO week variable, in string format, and `isodate` is the Monday of each ISO week. Note that the years 1998 and 2004 each have an ISO week 53.\n\nYou have several observations in the same week since you have data from different days and one value corresponds to one case. Use the `count` function to aggregate the data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndis3_v2 <- dis3 %>%\n    count(date_isowk)\n\nhead(dis3_v2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  date_isowk  n\n1   1995-W01 13\n2   1995-W02 15\n3   1995-W03  6\n4   1995-W04  5\n5   1995-W05 11\n6   1995-W06 10\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndis3_ts <- dis3_v2 %>%\n    mutate(date_index = yearweek(x = date_isowk, week_start = 1L)) %>%\n    as_tsibble(index = date_index)\n\n\nggplot(data = dis3_ts) +\n    geom_line(mapping = aes(x = date_index, y = n)) +\n    scale_x_yearweek(date_labels = \"%Y\") +\n    labs(x = \"Date\", \n         y = \"Number of Cases\", \n         title = \"Disease 1 data\") +\n    tsa_theme\n```\n\n::: {.cell-output-display}\n![](03-practical_files/figure-html/task-3-1-dis3-isoweek-plot-tidy-1.png){width=100%}\n:::\n:::\n\n\nAggregating cases by month is another possibility.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndis3_agg <- dis3 %>%\n    count(year, month)\n\ndis3_ts_v2 <- dis3_agg %>%\n    mutate(date_index = make_yearmonth(year = year, month = month)) %>%\n    as_tsibble(index = date_index)\n\nggplot(data = dis3_ts_v2) +\n    geom_line(mapping = aes(x = date_index, y = n)) +\n    scale_x_yearweek(date_labels = \"%Y\") +\n    labs(x = \"Date\", \n         y = \"Number of Cases\", \n         title = \"Disease 1 data\") +\n    tsa_theme\n```\n\n::: {.cell-output-display}\n![](03-practical_files/figure-html/task-3-1-dis3-month-plot-tidy-1.png){width=100%}\n:::\n:::\n\n\n## 3.2 Optional task {#solution-3-1-1 .unnumbered}\n\nImport your data to R from the dis2 excel file.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndis2 <- import(here(\"data\", \"tsa_practice.xlsx\"), which = \"dis2\")\nView(dis2)\n```\n:::\n\n\nInspect the data.\n\n\n\nYou have separate columns containing the counts. To plot this data, you need to first reshape your dataset by converting it from the current wide format to a long format.\n\nThe function `pivot_longer` can perform such transformation.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndis2l <- dis2 %>%\n  pivot_longer(\n      cols = -year, \n      names_to = \"month\", \n      values_to = \"case\"\n  ) %>%\n  mutate(month = as_factor(month)) %>%  # as_factor sets levels in the order they appear\n  arrange(year, month)\n\nstr(dis2l)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\ntibble [528 × 3] (S3: tbl_df/tbl/data.frame)\n $ year : num [1:528] 1928 1928 1928 1928 1928 ...\n $ month: Factor w/ 12 levels \"Jan\",\"Feb\",\"Mar\",..: 1 2 3 4 5 6 7 8 9 10 ...\n $ case : num [1:528] 609 1516 4952 7466 11155 ...\n```\n\n\n:::\n\n```{.r .cell-code}\nhead(dis2l)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 3\n   year month  case\n  <dbl> <fct> <dbl>\n1  1928 Jan     609\n2  1928 Feb    1516\n3  1928 Mar    4952\n4  1928 Apr    7466\n5  1928 May   11155\n6  1928 Jun    7002\n```\n\n\n:::\n\n```{.r .cell-code}\ndis2l_agg <- dis2l %>%\n    mutate(date_index = make_yearmonth(year = year, month = month)) %>%\n    as_tsibble(index = date_index)\n\nhead(dis2l_agg)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tsibble: 6 x 4 [1M]\n   year month  case date_index\n  <dbl> <fct> <dbl>      <mth>\n1  1928 Jan     609  1928 ene.\n2  1928 Feb    1516  1928 feb.\n3  1928 Mar    4952  1928 mar.\n4  1928 Apr    7466  1928 abr.\n5  1928 May   11155  1928 may.\n6  1928 Jun    7002  1928 jun.\n```\n\n\n:::\n\n```{.r .cell-code}\nggplot(data = dis2l_agg) +\n    geom_line(mapping = aes(x = date_index, y = case)) +\n    scale_x_yearweek(date_labels = \"%Y\") +\n    labs(x = \"Date\", \n         y = \"Number of Cases\", \n         title = \"Disease 3 data\") +\n    tsa_theme\n```\n\n::: {.cell-output-display}\n![](03-practical_files/figure-html/task-3-1-opt-dis2-pivot-longer-tidy-1.png){width=100%}\n:::\n:::\n\n\n**dis1** corresponds to salmonellosis cases, **dis2** to measles cases in New York.\n",
    "supporting": [
      "03-practical_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}
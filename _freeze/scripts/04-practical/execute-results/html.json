{
  "hash": "ff472fa09e300a5e2f4b889fcde9ebb4",
  "result": {
    "engine": "knitr",
    "markdown": "# Practical Session 4: Smoothing and Trends {.unnumbered}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrm(list=ls())\n# Install pacman if not installed already, and activate it\nif (!require(\"pacman\")) install.packages(\"pacman\")\n\n# Install, update and activate libraries\npacman::p_load(\n  here, \n  rio, \n  skimr,\n  tsibble,\n  ISOweek,\n  slider,    # for rolling means\n  pander,\n  tidyverse,\n  gtsummary\n)\n\n\n# Create tsa_theme\ntsa_theme <- theme_bw() + \n        theme(\n            plot.title = element_text(face = \"bold\", \n                                      size = 12),\n            legend.background = element_rect(fill = \"white\", \n                                             size = 4, \n                                             colour = \"white\"),\n            legend.justification = c(0, 1),\n            legend.position = \"bottom\",\n            panel.grid.minor = element_blank()\n        )\n```\n:::\n\n\n## Mortality Surveillance data in Spain {#title-4-1 .unnumbered}\n\nThe number of deaths in a country can be used as a surveillance indicator. An example of such an application is EuroMOMO, which monitors number of fatalities in European countries on a weekly basis (https://www.euromomo.eu/). The weekly time series on the number of deathls are routinely used to follow seasonal infections, for example influenza and covid 19 during the winter, but also heatwaves in the summer.\n\nIn case studies 4 to 7, we will analyse the number of deaths retrieved from the Spanish national statistical institute (INE) (https://ine.es/). Each case study will build up from the analysis conducted in the previous case study. The data contains the number of fatalities per week for the entire country, from 2010 to 2019, and includes variables on year, week, total number of deaths (`cases`), and total population; the same data is also included for men and women.\n\n## Expected learning outcomes {#learn-4 .unnumbered}\n\nBy the end of the session, participants should be able to:\n\n-   Describe, test and fit a trend in surveillance data (simple smoothing and regression);\n\n-   Assess and interpret the significance of trend in surveillance data.\n\nSave any changes to a new dataset named \\``mortagg`.\n\n## Task 4.1 {#task-4-1 .unnumbered}\n\nAssess visually how the total registered number of deaths has been behaving in the years with available data.\n\nDiscuss your results with your peers.\n\n### Moving average and direct statistical modelling of trends {#task-4-1-1a .unnumbered}\n\nMoving averages are simple methods to visualise the general trend of a series after removing some of the random day-to-day variation by smoothing the data. This allows you to browse your data for periodicity and observe the general trend. In other words, smoothing the data may remove “noise” from your time series and can facilitate visual interpretation.\n\nMoving averages model a time series by calculating the numerical mean of the values adjacent to it. It is calculated for each observation, moving along the time axis: e.g. at each time $t$ and for a window of 5 time units, one way of calculating the moving average is by using the observations at $t-2$, $t-1$, $t$, $t+1$ and $t+2$.\n\n## Help for Task 4.1 {#solution-4-1 .unnumbered .unnumbered}\n\nLoad the `mortagg.Rdata` dataset.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nload(here(\"data\", \"mortagg2.Rdata\"))\n```\n:::\n\n\nInspect the data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstr(mortagg)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n'data.frame':\t521 obs. of  8 variables:\n $ cases_m: num  4207 4409 4229 4252 4196 ...\n $ cases_f: num  4019 4264 4122 3837 3976 ...\n $ cases  : num  8226 8673 8351 8089 8172 ...\n $ year   : num  2010 2010 2010 2010 2010 2010 2010 2010 2010 2010 ...\n $ week   : num  1 2 3 4 5 6 7 8 9 10 ...\n $ pop    : num  46486621 46486621 46486621 46486621 46486621 ...\n $ pop_f  : num  23504349 23504349 23504349 23504349 23504349 ...\n $ pop_m  : num  2.3e+07 2.3e+07 2.3e+07 2.3e+07 2.3e+07 ...\n```\n\n\n:::\n\n```{.r .cell-code}\nsummary(mortagg)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n    cases_m        cases_f         cases            year           week      \n Min.   :3276   Min.   :2941   Min.   : 6316   Min.   :2010   Min.   : 1.00  \n 1st Qu.:3648   1st Qu.:3464   1st Qu.: 7106   1st Qu.:2012   1st Qu.:14.00  \n Median :3839   Median :3684   Median : 7510   Median :2015   Median :27.00  \n Mean   :3969   Mean   :3819   Mean   : 7788   Mean   :2015   Mean   :26.55  \n 3rd Qu.:4194   3rd Qu.:4047   3rd Qu.: 8217   3rd Qu.:2017   3rd Qu.:40.00  \n Max.   :5597   Max.   :5877   Max.   :11471   Max.   :2019   Max.   :53.00  \n      pop               pop_f              pop_m         \n Min.   :46418884   Min.   :23504349   Min.   :22806445  \n 1st Qu.:46486621   1st Qu.:23612439   1st Qu.:22831107  \n Median :46497393   Median :23621034   Median :22889600  \n Mean   :46608292   Mean   :23669979   Mean   :22938313  \n 3rd Qu.:46712650   3rd Qu.:23719207   3rd Qu.:23016783  \n Max.   :46918951   Max.   :23902168   Max.   :23099009  \n```\n\n\n:::\n\n```{.r .cell-code}\nview(mortagg)\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nskimr::skim(mortagg) \n```\n\n::: {.cell-output-display}\n\nTable: Data summary\n\n|                         |        |\n|:------------------------|:-------|\n|Name                     |mortagg |\n|Number of rows           |521     |\n|Number of columns        |8       |\n|_______________________  |        |\n|Column type frequency:   |        |\n|numeric                  |8       |\n|________________________ |        |\n|Group variables          |None    |\n\n\n**Variable type: numeric**\n\n|skim_variable | n_missing| complete_rate|        mean|        sd|       p0|      p25|      p50|      p75|     p100|hist  |\n|:-------------|---------:|-------------:|-----------:|---------:|--------:|--------:|--------:|--------:|--------:|:-----|\n|cases_m       |         0|             1|     3969.15|    454.44|     3276|     3648|     3839|     4194|     5597|▇▇▃▁▁ |\n|cases_f       |         0|             1|     3818.53|    544.44|     2941|     3464|     3684|     4047|     5877|▆▇▃▁▁ |\n|cases         |         0|             1|     7787.68|    992.14|     6316|     7106|     7510|     8217|    11471|▇▇▃▁▁ |\n|year          |         0|             1|     2014.50|      2.87|     2010|     2012|     2015|     2017|     2019|▇▇▇▇▇ |\n|week          |         0|             1|       26.55|     15.05|        1|       14|       27|       40|       53|▇▇▇▇▇ |\n|pop           |         0|             1| 46608291.50| 163065.99| 46418884| 46486621| 46497393| 46712650| 46918951|▇▁▅▂▂ |\n|pop_f         |         0|             1| 23669978.80| 102454.81| 23504349| 23612439| 23621034| 23719207| 23902168|▂▇▆▂▂ |\n|pop_m         |         0|             1| 22938312.61| 100399.88| 22806445| 22831107| 22889600| 23016783| 23099009|▇▅▁▇▅ |\n\n\n:::\n:::\n\n\nCreate a time series object with `tsibble`, using the total case counts and plot the time series.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmortz <-\n  mortagg %>%\n  mutate(date_index = make_yearweek(year = year, week = week)) %>%\n  as_tsibble(index = date_index)\n\n\nggplot(data = mortz) +\n  geom_line(mapping = aes(x = date_index, y = cases)) +\n  scale_x_yearweek(date_labels = \"%Y-%W\", date_breaks = \"1 year\") +\n  labs(x = \"Year Week\", y = \"Number of Deaths\", title = \"Spain: number of deaths per week\") +\n  tsa_theme\n```\n\n::: {.cell-output-display}\n![](04-practical_files/figure-html/task-4-1-mort-aggr-week-plot-tidy-1.png){width=100%}\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Adjusting y-axis scale\nggplot(data = mortz) +\n  geom_line(mapping = aes(x = date_index, y = cases)) +\n  scale_x_yearweek(date_labels = \"%Y-%W\", date_breaks = \"1 year\") +\n  scale_y_continuous(limits = c(0, NA)) +\n  labs(x = \"Date\", y = \"Number of Deaths\", title = \"Spain: number of deaths per week\") +\n  tsa_theme\n```\n\n::: {.cell-output-display}\n![](04-practical_files/figure-html/task-4-1-mort-aggr-week-plot2-tidy-1.png){width=100%}\n:::\n:::\n\n\nCreate a similar plot for men and women.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Men and Women in wide format\n\ncolors <- c(\"cases_m\"=\"green\", \"cases_f\"=\"black\")\n\nggplot(data = mortz, aes(x = date_index)) +\n  geom_line(mapping = aes(y = cases_m, colour = \"cases_m\"), lwd=1) +\n  geom_line(mapping = aes(y = cases_f, colour = \"cases_f\"), lwd=1) + \n  scale_x_yearweek(date_labels = \"%Y-%W\", date_breaks = \"1 year\") +\n  scale_y_continuous(limits = c(0, NA)) +\n  labs(x = \"Week\", y = \"Number of Deaths\", title = \"Spain: number of deaths per week and by sex\", \n         colour = \"Legend\") +\n  scale_color_manual(values = colors, name=\"\", labels = c(\"Men\", \"Women\")) +\n  tsa_theme\n```\n\n::: {.cell-output-display}\n![](04-practical_files/figure-html/task-opt-4-1-mort-sex-aggr-week-plots-tidy-1.png){width=100%}\n:::\n:::\n\n\n## Task 4.2 {#task-4-2 .unnumbered .unnumbered}\n\nAssess visually the existence of a long-term trend and periodicity in the `mortaagg` dataset by using smoothing techniques.\n\nConsider: where would you centre the smoothing window and why? What is the effect of using different smoothing window centring options? Test!\n\nOf all the methods applied here (moving average with different windows, loess with different spans), which one do you think is the best for eliminating seasonality? Where would you centre the smoothing window and why? What would happen if you used an even greater window? Test!\n\n## Help for Task 4.2 {#solution-4-2 .unnumbered}\n\nAccording to the `slider` package description, `slider` is a package for rolling windows analysis. It means that a given function is repeatedly applied to different “windows” of your data as you step through it. Typical examples of applications of rolling window functions include moving averages or cumulative sums. An introduction vignette for slider can be found by running the following command: `vignette(\"slider\")`\n\nFor each record, create the following various types of moving average.\n\n-   `MA5a`: the 5-week moving average, centered on cases.\n\n-   `MA5b`: the 5-week moving average of cases and the 4 previous weeks.\n\n-   `MA5c`: the 5-week moving average of the 5 previous weeks.\n\nCompare results.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmortzma <-\n  mortz %>%\n  mutate(\n    MA5a = slide_index_dbl(\n      .x = cases,\n      .i = date_index,\n      .f = mean,\n      na.rm = TRUE,\n      .before = 2,\n      .after = 2,\n      .complete = TRUE\n    ),\n    MA5b = slide_index_dbl(\n      .x = cases,\n      .i = date_index,\n      .f = mean,\n      na.rm = TRUE,\n      .before = 4,\n      .complete = TRUE\n    ),\n    MA5c = slide_index_dbl(\n      .x = cases,\n      .i = date_index,\n      .f = function(x) mean(x[-6], na.rm = TRUE),\n      .before = 5,\n      .complete = TRUE\n    )\n  )\n\n# view first 10 lines of data\nhead(mortzma, 10)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tsibble: 10 x 12 [1W]\n   cases_m cases_f cases  year  week    pop  pop_f  pop_m date_index  MA5a  MA5b\n     <dbl>   <dbl> <dbl> <dbl> <dbl>  <dbl>  <dbl>  <dbl>     <week> <dbl> <dbl>\n 1    4207    4019  8226  2010     1 4.65e7 2.35e7 2.30e7   2010 W01   NA    NA \n 2    4409    4264  8673  2010     2 4.65e7 2.35e7 2.30e7   2010 W02   NA    NA \n 3    4229    4122  8351  2010     3 4.65e7 2.35e7 2.30e7   2010 W03 8302.   NA \n 4    4252    3837  8089  2010     4 4.65e7 2.35e7 2.30e7   2010 W04 8253.   NA \n 5    4196    3976  8172  2010     5 4.65e7 2.35e7 2.30e7   2010 W05 8183  8302.\n 6    4127    3854  7981  2010     6 4.65e7 2.35e7 2.30e7   2010 W06 8131. 8253.\n 7    4294    4028  8322  2010     7 4.65e7 2.35e7 2.30e7   2010 W07 8015  8183 \n 8    4121    3968  8089  2010     8 4.65e7 2.35e7 2.30e7   2010 W08 7887. 8131.\n 9    3824    3687  7511  2010     9 4.65e7 2.35e7 2.30e7   2010 W09 7853. 8015 \n10    3921    3612  7533  2010    10 4.65e7 2.35e7 2.30e7   2010 W10 7710. 7887.\n# ℹ 1 more variable: MA5c <dbl>\n```\n\n\n:::\n:::\n\n\nThe `slide_index_dbl` is a `slider` package function designed to run a pre-specified function on a rolling window of a numeric (`_dbl`) variable, ordered by an index time (date or date-time) variable. A full description of this function can be found by running the following command: `?slide_index_dbl`\n\nThe `.x` argument provides the vector with the numbers that will be used for computation.\n\nThe `.i` argument defines the vector with the time variable that will be used for ordering the data.\n\nThe `.f` argument indicates the function that will be used to perform the intended computations. In this case, an arithmetic mean computation is carried out by using the `mean` function. The `na.rm = TRUE` is a varying argument included as a `...` argument of `slide_index_dbl`. (Run the expression `args(\"slide_index_dbl\")` and take notice on the position/sequence of this function's arguments).\n\nThe `.before` argument defines the number of observations before the central time point of a given time window to use in the rolling window computation. In the example above for a 5 time points centered moving average, in `MA5a`, 2 observations are used before the central point, and 2 observations are used after it, using the `.after` argument.\n\nThe `complete` argument indicates where the computation should be carried in rolling windows that have complete observations.\n\nWe applied a more complicated function to compute `MA5c`, taking a backwards moving window of six values but omitting the latest value (current time point) from the calculation of the average.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## wide format dataset ---\n\ncolors <- c(\"cases\"=\"black\", \"MA5a\"=\"red\", \"MA5b\"=\"blue\", \"MA5c\"=\"brown\")\n\nggplot(data = mortzma, mapping = aes(x = date_index)) +\n  geom_line(mapping = aes(y = cases, colour = \"cases\")) +\n  geom_line(mapping = aes(y = MA5a, colour = \"MA5a\")) +\n  geom_line(mapping = aes(y = MA5b, colour = \"MA5b\")) +\n  geom_line(mapping = aes(y = MA5c, colour = \"MA5c\")) +\n  scale_x_yearweek(date_labels = \"%Y-%W\", \n                   date_breaks = \"1 year\") +\n  scale_y_continuous(limits = c(0, NA)) +\n  labs(x = \"Week\", \n       y = \"Number of deaths\", \n       title = \"Spain: number of deaths - moving averages\",\n       colour=\"Legend\") +\n  scale_color_manual(values = colors, name=\"\") +\n  tsa_theme\n```\n\n::: {.cell-output-display}\n![](04-practical_files/figure-html/task-4-2-mort-MAx-plots-tidy-1.png){width=100%}\n:::\n:::\n\n\nWe observe that the calculation is similar across these various methods, but is not aligned to the series in the same way. `MA5a` is centered in the middle of the period used to calculate the mean. `MA5b` is placed at the end of the period. `MA5c` is placed one step forward (smoothing functions can be used for forecasting the following point). The \"models\" provided are similar for a 5-week window, but the *lag* is different.\n\nMoving average is only one way of smoothing. Other ways of smoothing the data to get a general idea of the trend include, for example, LOESS (locally estimated scatterplot smoothing) smoothing, where the contribution of surrounding observations is weighted, i.e. it is not the arithmetical mean for each set (window) of observations.\n\nWhy do you think we have chosen these windows for the moving average?\n\nTo better observe the general trend, we need to find the length of the moving average that will erase the seasonal component. Various lengths can be tried; here we have used 25, 51 and 103.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmortzma2 <-\n  mortz %>%\n  mutate(\n    MA25 = slide_index_dbl(\n      .x = cases,\n      .i = date_index,\n      .f = mean,\n      na.rm = TRUE,\n      .before = 24,\n      .complete = TRUE\n    ),\n    MA51 = slide_index_dbl(\n      .x = cases,\n      .i = date_index,\n      .f = mean,\n      na.rm = TRUE,\n      .before = 50,\n      .complete = TRUE\n    ),\n    MA103 = slide_index_dbl(\n      .x = cases,\n      .i = date_index,\n      .f = mean,\n      na.rm = TRUE,\n      .before = 102,\n      .complete = TRUE\n    )\n  )\n\n## Visually inspect data\nslice(mortzma2, 20:30)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tsibble: 11 x 12 [1W]\n   cases_m cases_f cases  year  week    pop  pop_f  pop_m date_index  MA25  MA51\n     <dbl>   <dbl> <dbl> <dbl> <dbl>  <dbl>  <dbl>  <dbl>     <week> <dbl> <dbl>\n 1    3867    3436  7303  2010    20 4.65e7 2.35e7 2.30e7   2010 W20   NA     NA\n 2    3758    3446  7204  2010    21 4.65e7 2.35e7 2.30e7   2010 W21   NA     NA\n 3    3605    3595  7200  2010    22 4.65e7 2.35e7 2.30e7   2010 W22   NA     NA\n 4    3440    3076  6516  2010    23 4.65e7 2.35e7 2.30e7   2010 W23   NA     NA\n 5    3407    3124  6531  2010    24 4.65e7 2.35e7 2.30e7   2010 W24   NA     NA\n 6    3632    3201  6833  2010    25 4.65e7 2.35e7 2.30e7   2010 W25 7531.    NA\n 7    3690    3567  7257  2010    26 4.65e7 2.35e7 2.30e7   2010 W26 7492.    NA\n 8    3764    3625  7389  2010    27 4.65e7 2.35e7 2.30e7   2010 W27 7441.    NA\n 9    3697    3638  7335  2010    28 4.65e7 2.35e7 2.30e7   2010 W28 7400.    NA\n10    3570    3349  6919  2010    29 4.65e7 2.35e7 2.30e7   2010 W29 7353.    NA\n11    3476    3209  6685  2010    30 4.65e7 2.35e7 2.30e7   2010 W30 7294.    NA\n# ℹ 1 more variable: MA103 <dbl>\n```\n\n\n:::\n\n```{.r .cell-code}\nslice(mortzma2, 45:55)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tsibble: 11 x 12 [1W]\n   cases_m cases_f cases  year  week    pop  pop_f  pop_m date_index  MA25  MA51\n     <dbl>   <dbl> <dbl> <dbl> <dbl>  <dbl>  <dbl>  <dbl>     <week> <dbl> <dbl>\n 1    3771    3563  7334  2010    45 4.65e7 2.35e7 2.30e7   2010 W45 6891.   NA \n 2    3817    3561  7378  2010    46 4.65e7 2.35e7 2.30e7   2010 W46 6898.   NA \n 3    4049    3516  7565  2010    47 4.65e7 2.35e7 2.30e7   2010 W47 6912.   NA \n 4    4001    3794  7795  2010    48 4.65e7 2.35e7 2.30e7   2010 W48 6963.   NA \n 5    4058    3754  7812  2010    49 4.65e7 2.35e7 2.30e7   2010 W49 7015.   NA \n 6    4034    3668  7702  2010    50 4.65e7 2.35e7 2.30e7   2010 W50 7049.   NA \n 7    4061    3892  7953  2010    51 4.65e7 2.35e7 2.30e7   2010 W51 7077. 7303.\n 8    4484    4056  8540  2010    52 4.65e7 2.35e7 2.30e7   2010 W52 7123. 7309.\n 9    4593    4315  8908  2011     1 4.67e7 2.36e7 2.30e7   2011 W01 7186. 7314.\n10    4276    4194  8470  2011     2 4.67e7 2.36e7 2.30e7   2011 W02 7248. 7316.\n11    4271    4175  8446  2011     3 4.67e7 2.36e7 2.30e7   2011 W03 7319. 7323.\n# ℹ 1 more variable: MA103 <dbl>\n```\n\n\n:::\n\n```{.r .cell-code}\nslice(mortzma2, 95:105)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tsibble: 11 x 12 [1W]\n   cases_m cases_f cases  year  week    pop  pop_f  pop_m date_index  MA25  MA51\n     <dbl>   <dbl> <dbl> <dbl> <dbl>  <dbl>  <dbl>  <dbl>     <week> <dbl> <dbl>\n 1    3824    3513  7337  2011    43 4.67e7 2.36e7 2.30e7   2011 W43 6919. 7420.\n 2    3818    3643  7461  2011    44 4.67e7 2.36e7 2.30e7   2011 W44 6936. 7423.\n 3    3737    3698  7435  2011    45 4.67e7 2.36e7 2.30e7   2011 W45 6958. 7424.\n 4    3789    3644  7433  2011    46 4.67e7 2.36e7 2.30e7   2011 W46 6965. 7421.\n 5    3744    3602  7346  2011    47 4.67e7 2.36e7 2.30e7   2011 W47 6987. 7412.\n 6    3971    3708  7679  2011    48 4.67e7 2.36e7 2.30e7   2011 W48 7025. 7410.\n 7    4025    3824  7849  2011    49 4.67e7 2.36e7 2.30e7   2011 W49 7063. 7413.\n 8    4148    3882  8030  2011    50 4.67e7 2.36e7 2.30e7   2011 W50 7102. 7414.\n 9    4354    4054  8408  2011    51 4.67e7 2.36e7 2.30e7   2011 W51 7141. 7411.\n10    4476    4277  8753  2011    52 4.67e7 2.36e7 2.30e7   2011 W52 7214. 7408.\n11    4425    4304  8729  2012     1 4.68e7 2.37e7 2.31e7   2012 W01 7289. 7413.\n# ℹ 1 more variable: MA103 <dbl>\n```\n\n\n:::\n:::\n\n\nYou can use `View` to examine the first rows of `mortzma2.`\n\n\n::: {.cell}\n\n```{.r .cell-code}\nView(mortzma2)\n```\n:::\n\n\nPlot the times series with the different moving averages.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## wide format dataset ---\n\ncolors <- c(\"cases\"=\"black\", \"MA25\"=\"red\", \"MA51\"=\"blue\", \"MA103\"=\"orange\")\n\nggplot(data = mortzma2, mapping = aes(x = date_index)) +\n  geom_line(mapping = aes(y = cases, colour = \"cases\"), linewidth=1) +\n  geom_line(mapping = aes(y = MA25, colour = \"MA25\"), linewidth=1.2) +\n  geom_line(mapping = aes(y = MA51, colour = \"MA51\"), linewidth=1.2) +\n  geom_line(mapping = aes(y = MA103, colour = \"MA103\"), linewidth=1.2) +\n  scale_x_yearweek(date_labels = \"%Y-%W\", \n                   date_breaks = \"1 year\") +\n  scale_y_continuous(limits = c(0, NA)) +\n  labs(x = \"Year-Week\", \n       y = \"Number of deaths\", \n       title = \"Spain: number of deaths - moving averages with 26, 51 and 103-week windows\",\n       colour=\"Legend\") +\n  scale_color_manual(values = colors, name=\"\", breaks = names(colors)[c(1,2,3,4)]) +\n  tsa_theme\n```\n\n::: {.cell-output-display}\n![](04-practical_files/figure-html/task-4-2-mort-MAx-longer-length-plots-tidy-1.png){width=100%}\n:::\n:::\n\n\nMoving average is only one way of smoothing. Other ways of smoothing the data to get a general idea of the trend include, for example, LOESS (locally estimated scatterplot smoothing) smoothing, where the contribution of surrounding observations is weighted, i.e. it is not the arithmetical mean for each set (window) of observations.\n\nThe `geom_smooth` provides a smoothing curve using a LOESS method.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(mortz, mapping = aes(x = date_index, y = cases)) +\n  geom_point(alpha = 0.5) +\n  geom_smooth(se = TRUE) +\n  scale_x_yearweek(date_labels = \"%Y-%W\", \n                   date_breaks = \"1 year\") +\n  scale_y_continuous(limits = c(0, NA)) +\n  labs(x = \"Date\", \n       y = \"Number of Deaths\", \n       title = \"Loess smoothing\") +\n  tsa_theme\n```\n\n::: {.cell-output-display}\n![](04-practical_files/figure-html/task-4-2-mort-MAx-scatterplot-tidy-1.png){width=100%}\n:::\n:::\n\n\nWe can change the degree of smoothing by adding a `span` option. The `span` controls the amount of smoothing for the default loess smoother; smaller numbers produce wigglier lines, and larger numbers produce smoother lines.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = mortz, mapping = aes(x = date_index, y = cases)) +\n  geom_point(alpha = 0.5) +\n  geom_smooth(se = TRUE, span = 0.1) +\n  scale_x_yearweek(date_labels = \"%Y-%W\", date_breaks = \"1 year\") +\n  scale_y_continuous(limits = c(0, NA)) +\n  labs(x = \"Date\", y = \"Number of Deaths\", title = \"Loess smoothing (span = 0.1)\") +\n  tsa_theme\n```\n\n::: {.cell-output-display}\n![](04-practical_files/figure-html/task-4-2-mort-MAx-scatterplot-span-tidy2-1.png){width=100%}\n:::\n:::\n\n\nIn ggplot(), we can also use `stat_smooth`, which provides a smoothing curve using a LOESS method, and were wee can change the degree of smoothing by adding a `span` option. The `span` controls the amount of smoothing for the default loess smoother; smaller numbers produce wigglier lines, and larger numbers produce smoother lines.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = mortz, mapping = aes(x = date_index, y = cases)) +\n  geom_point(alpha = 0.5) +\n  stat_smooth(se = TRUE, span=0.1) +\n  scale_x_yearweek(date_labels = \"%Y-%W\", date_breaks = \"1 year\") +\n  scale_y_continuous(limits = c(0, NA)) +\n  labs(x = \"Year-Week\", y = \"Number of deaths\", \n    title = \"Spain: number of deaths - loess smoothing (span = 0.1)\") +\n  tsa_theme\n```\n\n::: {.cell-output-display}\n![](04-practical_files/figure-html/task-4-2-mort-MAx-scatterplot-span-tidy-1.png){width=100%}\n:::\n:::\n\n\nTest different values of span. Comment on the lines provided by the different smoothing windows. Which one do you think is the best for eliminating seasonality? What would happen if you used an even greater window?\n\n## Task 4.3 {#task-4-3 .unnumbered .unnumbered}\n\nAssess statistically whether the registered number of deaths has been stable in the years available in your dataset.\n\n## Help for Task 4.3 {#solution-4-3 .unnumbered}\n\nUsing regression methods against the time variable is a simple and familiar way to look at trends and test the slope. The kind of regression and interpretation you will use depends on the nature of your dependent variable (outcome), in this case, the number (count) of registered deaths. Time will be represented by a variable that simply enumerates the observations; in other words, time is a variable with values from 1 (the first observation in time; here week 1, 2010) to `n` (the last observation in time; here week 52, 2019).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmortz <-\n  mortz %>%\n  mutate(index = seq.int(from = 1, to = nrow(.)))\n\nmort_poissontrend <- glm(formula = cases ~ index,\n                          family = \"poisson\",\n                          data = mortz\n)\n```\n:::\n\n\nCheck model results.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(mort_poissontrend)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nglm(formula = cases ~ index, family = \"poisson\", data = mortz)\n\nCoefficients:\n             Estimate Std. Error z value Pr(>|z|)    \n(Intercept) 8.910e+00  1.007e-03 8850.25   <2e-16 ***\nindex       1.895e-04  3.302e-06   57.39   <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for poisson family taken to be 1)\n\n    Null deviance: 62509  on 520  degrees of freedom\nResidual deviance: 59215  on 519  degrees of freedom\nAIC: 64841\n\nNumber of Fisher Scoring iterations: 4\n```\n\n\n:::\n:::\n\n\nThe `glm` function fits a linear regression model to the log of the weekly number of deaths. You can use the `names` function to see the various components of the output of the `glm` function, as above. As mentioned in the previous session, the `str` function is also often useful for looking at the \"structure\" of the output of an R function. Summary provides a quick function for checking the results.\n\nVariables in R models are specified using notation along the lines of `response_variable ~ explanatory_variable_1 + explanatory_variable_2` etc. Check the material from the MVA module. A more detailed explanation of how to build model formulas in R can also be found in the *Details* section of the help page of the `formula` function: `?stats::formula`.\n\n`summary`, when given the results of fitting a regression model, will provide a summary of the fitted parameters (coefficients); in this case the parameter of `index` is the trend.\n\nIdentify and interpret the intercept and the trend. In a Poisson model on the log(y), the coefficient needs to be exponentiated in order to interpret it for the output y (that is, the original y without the log).\n\nPlot the fitted values against the observed ones.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncolors <- c(\"observed\"=\"black\", \"fitted\"=\"blue\")\n\nggplot(data = mortz, mapping = aes(x = date_index)) +\n  geom_point(mapping = aes(y = cases, colour=\"observed\"), alpha = 0.5) +\n  geom_line(mapping = aes(y = fitted(mort_poissontrend), colour = \"fitted\"), linewidth=1.1) +\n  scale_y_continuous(limits = c(0, NA)) +\n  scale_x_yearweek(date_labels = \"%Y-%W\", date_breaks = \"1 year\") +\n  labs(x = \"Year-Week\", y = \"Number of deaths\", title = \"Spain: number of deaths per week with fitted trend\") +\n  scale_color_manual(values = colors, name=\"\") +\n  tsa_theme\n```\n\n::: {.cell-output-display}\n![](04-practical_files/figure-html/task-4-3-regression-glm-plot-tidy-1.png){width=100%}\n:::\n:::\n\n\nThe trend as incidence rate ratio (IRR) provides the average relative change in the number of deaths from one week to the next.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Trend in the original scale of the outcome cases (deaths) wit 95% confidence intervals. \nIRR_trend <- exp(cbind(Estimate=mort_poissontrend$coef, confint(mort_poissontrend)))\n\n(IRR_trend['index', ] - 1) *100\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Estimate      2.5 %     97.5 % \n0.01894927 0.01830203 0.01959652 \n```\n\n\n:::\n:::\n\n\nThe result above indicates that from one week to another, the number of deaths increases in average 0,019% per week, with a 95% confidence interval of \\[0,018%; 0,020%\\].\n\nAnother way in R to obtain the incidence rate ratio (IRR) is:\n\n`{r: task-4-3-IRR-trend} mort_poissontrend %>%    gtsummary::tbl_regression(     exponentiate = T,     estimate_fun = ~style_number(.x, digits = 4)   )`\n\n## Task 4.4 {#task-4-4 .unnumbered .unnumbered}\n\nHow could you take the changing population size of Spain into account in your analyses?\n\n## Help for Task 4.4 {#solution-4-4 .unnumbered}\n\nTo take the population into account, we need to include the population in the model. This is done by adding a term called `offset()`. The parameter beta for the offset, in this case for the population, will be forced to be 1; in other words, the offset will not affect the outcome. The advantage is that we can interpret the IRR of time in terms of mortality rate = cases/population.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmort_poissontrend_pop <- glm(cases ~  index + offset(log(pop)),\n                          data = mortz,\n                          family = \"poisson\"\n                        )\n\nsummary(mort_poissontrend_pop)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nglm(formula = cases ~ index + offset(log(pop)), family = \"poisson\", \n    data = mortz)\n\nCoefficients:\n              Estimate Std. Error  z value Pr(>|z|)    \n(Intercept) -8.746e+00  1.006e-03 -8691.66   <2e-16 ***\nindex        1.863e-04  3.299e-06    56.47   <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for poisson family taken to be 1)\n\n    Null deviance: 62588  on 520  degrees of freedom\nResidual deviance: 59399  on 519  degrees of freedom\nAIC: 65025\n\nNumber of Fisher Scoring iterations: 4\n```\n\n\n:::\n\n```{.r .cell-code}\n# Trend in the original scale of the outcome cases (deaths) with 95% confidence intervals. \nIRR_trend_pop <- exp(cbind(Estimate=mort_poissontrend_pop$coef, confint(mort_poissontrend_pop)))\n\n(IRR_trend_pop['index', ] - 1) *100\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Estimate      2.5 %     97.5 % \n0.01863368 0.01798691 0.01928046 \n```\n\n\n:::\n:::\n\n\nThe summary() function will only provide the coefficients in the original log \nscale of the poisson model. Another way of obtaining the IRR is by using `tbl_regression` with the argument \n`exponentiate = TRUE`:\n\n\n```{r: task-4-4-regression-pois-pop-IRR}\nmort_poissontrend_pop %>% \n  gtsummary::tbl_regression(\n    exponentiate = TRUE,\n    estimate_fun = ~style_number(.x, digits = 4)\n  )\n```\n\nplot the predicted and the original values:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = mortz, mapping = aes(x = date_index)) +\n  geom_point(mapping = aes(y = cases), alpha = 0.5) +\n  geom_line(mapping = aes(y = fitted(mort_poissontrend_pop)), colour = \"blue\", lwd=1.1) +\n  scale_y_continuous(limits = c(0, NA)) +\n  scale_x_yearweek(date_labels = \"%Y-%W\", \n                   date_breaks = \"1 year\") +\n  labs(\n    x = \"Week\", y = \"Mortality rate\",\n    title = \"Spain: Mortality rate per week with fitted trend\"\n  ) +\n  tsa_theme\n```\n\n::: {.cell-output-display}\n![](04-practical_files/figure-html/task-opt-4-4-regression-pois-pop_plot-tidy-1.png){width=100%}\n:::\n:::\n\n\n\nCompare the trend and IRR in the models with and without population.\n\n\nFor communication, it might be better to present the results in terms of \nnumber of deaths per 100.000 inhabitants (population), which would then be \ncalled the mortality rate. We will now plot the same trend but as rate per \n100.000 inhabitants. For this purpose we must adjust both the observed and the \nfitted values by multiplying with 100.000. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nmortz<- mortz %>%\n  mutate(\n    mortality_rate = cases/pop*100000\n  )\n\n\nggplot(data = mortz, mapping = aes(x = date_index)) +\n  geom_point(mapping = aes(y = mortality_rate), alpha = 0.5) +\n  geom_line(mapping = aes(y = fitted(mort_poissontrend_pop)/pop*100000), colour = \"blue\", lwd=1.1) +\n  scale_y_continuous(limits = c(0, NA)) +\n  scale_x_yearweek(date_labels = \"%Y-%W\", \n                   date_breaks = \"1 year\") +\n  labs(\n    x = \"Week\", y = \"Mortality rate (per 100.000 pop)\",\n    title = \"Spain: Mortality rate per 100.000 population per week with fitted trend\"\n  ) +\n  tsa_theme\n```\n\n::: {.cell-output-display}\n![](04-practical_files/figure-html/task-opt-4-3-regression-pois-mortrate-plot-tidy-1.png){width=100%}\n:::\n:::\n\n\nHow do you interpret the IRR in the model for mortality rate?\n\n\n\n## Task 4.5 (Optional) {#task-4-5 .unnumbered}\n\nCarry out the same analysis for men and women. Do you see differences between \nthe two? where? \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Save the mortagg and mortz objects.\n#save(mortagg, mortz, file = here(\"data\", \"mortagg_case_4.RData\"))\n```\n:::\n\n",
    "supporting": [
      "04-practical_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}
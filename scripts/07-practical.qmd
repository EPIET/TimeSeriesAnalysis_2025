# Practical Session 7: Forecasting {.unnumbered}

```{r, knitr-global-chunk-07, cache=FALSE}
rm(list=ls())

# Install pacman if not installed already, and activate it
if (!require("pacman")) install.packages("pacman")

# Install, update and activate libraries
pacman::p_load(
  here, 
  rio, 
  skimr,
  tsibble,
  TSA,
  tidyverse,
  ciTools
)

# Create tsa_theme from previous exercise to be used in ggplot.
tsa_theme <- theme_bw() + 
        theme(
            plot.title = element_text(face = "bold", 
                                      size = 12),
            legend.background = element_rect(fill = "white", 
                                             size = 4, 
                                             colour = "white"),
            # legend.justification = c(0, 1),
            legend.position = "bottom",
            panel.grid.minor = element_blank()
        )
                                             
```

## Expected learning outcomes {#learn-7 .unnumbered}

By the end of this session, participants should be able to: - understand the 
use of forecasting in public health surveillance data - forecast the expected 
number of cases of a disease into the future 

## Task 7.1 {#task-7-1 .unnumbered}

January 2020: Your boss received a phone call from the Ministry of Health. 
She is part of a committee that is responsible for setting the alert levels 
for mortality in Spain for the next year 2020. Before doing so, she gives 
you the task to forecast the total expected number of deaths for 2020 based 
on the historical data up to and including 2019. 

Start by reading the data and re-running the last acceptable model.


```{r, task-7-1-read-data, cache=FALSE}

load(here("data", "mortagg2_case_6.Rdata"))

# Model with trend and seasonality
mort_trendsin2cos2 <- glm(cases ~ index + sin52 + cos52 + sin26 + cos26,
                           family = "poisson",
                           data = mortz)
```

Plot the data to have it 


```{r, task-7-1-explore}
ggplot(data = mortz) +
    geom_line(
        mapping = aes(x = year_week, y = cases),
        colour = "black",
        alpha = 1.2
    ) +
    geom_line(
        mapping = aes(x = year_week, y = mort_trendsin2cos2$fitted),
        colour = "red",
        alpha = 1.4
    ) +
    scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "13 weeks") +
    labs(x = "Year Week", y = "Weekly cases",
        title = "Regression model: trend, sin52, cos52, sin26, cos26 terms") +
    tsa_theme + 
    theme(axis.text.x = element_text(angle = 30, hjust = 1)) 
```

The dataset has records up to 2019-W52, and you would like to project the data (forecast) into 2020.

First, create a new time series object for 2020. Note that 2020 has 53 weeks.

```{r, task-7-1-dataset}
pred.df <-
    tibble(
        year=2020,
        week  = 1:53,  # add 53 weeks
        index = 521:(521+53-1), # continues the numeration of the dataset up to 2019 w52
        year_week = make_yearweek(year = year, week = week),
        sin52 = sin(2 * pi * week / 52),
        cos52 = cos(2 * pi * week / 52),
        sin26 = sin(2 * pi * week / 26),
        cos26 = cos(2 * pi * week / 26),
        pop = 47318050)              # Spanish pop in 2020 (1st Jan)
 

view(pred.df)
```

Calculate the expected values and 95% prediction intervals for each week of 2020 assuming the same Poisson regression model as before.

Predict and plot the expected number of deaths per week for 2020 with prediction intervals:

```{r, task-7-1-prediction-interval}

# apply mort_trendsin2cos2 to new data and predict cases with C.I. using bootstrapping.
# bootstrapping is a statistical method where you draw random samples from your data, 
# and analyze each of this samples.
# https://en.wikipedia.org/wiki/Bootstrapping_(statistics)
# nSims indicates how many random draws should be carried out; more is better, but be aware that it also takes more time. Usually 500 to 1000 is enough.

# set a random seed with set.seed() with any number you choose. Here, use the 
# same number as 12589 to get the same exact results as shown.
 
set.seed(12589) 

pred.mort <- ciTools::add_ci(pred.df, 
                                mort_trendsin2cos2,
                                names=c("lPI", "uPI"),
                                yhatName="pred_cases",
                                response=TRUE,
                                type="boot",
                                nSims=1000)
head(pred.mort, 5)
```

Plot the forecasted values for the weekly deaths in 2020, and include the predictive intervals.

```{r, task-7-1-prediction-interval-plot-tidy}
ggplot(data = pred.mort) +
    geom_line(
        mapping = aes(x = year_week, y = pred_cases),
        colour = "red",
        alpha = 0.7
    ) +
    geom_ribbon(
        mapping = aes(x = year_week, ymin = lPI, ymax = uPI),
        fill = "red",
        alpha = 0.1
    ) +
    scale_y_continuous(limits = c(0, NA)) +
    scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "4 weeks") +
    labs(x = "Year Week", y = "Predicted weekly deaths",
        title = "Regression model: prediction trend, sin52, cos52, sin26, cos26 terms") +
    tsa_theme + 
    theme(axis.text.x = element_text(angle = 30, hjust = 1)) 
    
```

*Calculate the total number of expected deaths in 2020 in Spain, including the 95% prediction interval.*

```{r, task-7-1-prediction-interval-total-tidy}
# Total predicted cases in 2020, with lPI and uPI
pred.mort %>% 
  summarise(
    pred_cases_2020 = sum(pred_cases),
    pred_cases_2020_lPI = sum(lPI),
    pred_cases_2020_uPI = sum(uPI)
  )

```

*Interpret the values.*


## Task 7.2  {#task-7-2 .unnumbered}

The committee assigned to evaluate the effects of the pandemic, wishes to 
know during which periods of 2020 did Spain experience excess deaths (more deaths than what was expected). 

Plot the actual number of deaths and compare with the predictions from the model based on 2010-2019.

```{r, task-7-2-diff-obs-predict-plot-tidy}
# load number of weekly deaths during 2020; the data.frame is mort2020.
load(here("data", "mortagg2020.Rdata"))

# make sure that  mort2020 from week 1 to week 53, same as in pred.mort
mort2020 <- mort2020 %>% arrange(week)

# add actual deaths from 2020 in pred.mort
pred.mort <- pred.mort %>% 
  mutate(cases = mort2020$cases)

ggplot(data = pred.mort) +
    geom_line(
        mapping = aes(x = year_week, y = pred_cases),
        colour = "red",
        alpha = 0.7,
        lwd = 1.2
    ) +
    geom_ribbon(
        mapping = aes(x = year_week, ymin = lPI, ymax = uPI),
        fill = "red",
        alpha = 0.1
    ) +
    geom_line(
        mapping = aes(x = year_week, y = cases),
        colour = "black",
        alpha = 0.7,
        lwd = 1.2
    ) +
    scale_y_continuous(limits = c(0, NA)) +
    scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "4 weeks") +
    labs(x = "Year Week", y = "Predicted weekly cases") +
    tsa_theme + 
    theme(axis.text.x = element_text(angle = 30, hjust = 1)) 
    
```

*During which periods was there an excess when comparing to the upper prediction interval*


*Calculate the total excess number of deaths per week, and plot the accumulated 
number by week.* 

Excess deaths can be calculated as the difference of the actual number of 
fatalities per week and the predicted mean, or the predicted upper 95% PI. We 
use cumsum() to accumulate the number of deaths over the year. 

```{r-task-7-2-excess-deaths-plot-tidy}

pred.mort <- pred.mort %>%
  mutate(
    difference_mean = cases - pred_cases,
    cusum_excess_mean = cumsum(difference_mean),
    difference_uPI = cases - uPI,
    cusum_excess_uPI = cumsum(difference_uPI)
  )


ggplot(data = pred.mort) +
    geom_line(
        mapping = aes(x = year_week, y = cusum_excess_mean),
        colour = "orange",
        alpha = 0.7,
        lwd = 2
    ) +
    geom_line(
        mapping = aes(x = year_week, y = cusum_excess_uPI),
        colour = "blue",
        alpha = 0.7,
        lwd = 2
    ) +   
    #scale_y_continuous(limits = c(-100, NA)) +
    scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "4 weeks") +
    labs(x = "Year", y = "Cumulative excess cases") +
    tsa_theme

```

*Interpret the plot.*


## Task 7.4 (Optional)  {#task-7-4 .unnumbered}

*Plot the entire series of observed data from 2010 to 2023, and the fitted 
number from the model based on 2010-2019. Visually, do you think the mortality pattern has gone back to the same pattern as in 2010-2019?* 

```{r-task-7-3-deaths-plot-2010-2020}

load(here("data", "mortagg2010_2023.Rdata"))
# mort2010_2023

mort_2010_2023 <- mort2010_2023 %>%
                mutate(
                year_week = make_yearweek(year = year, week = week))

# how many weeks in each year:
num_weeks <- table(mort2010_2023$year)
num_weeks

pred.df_2020_2023 <-
    tibble(
        year=c(rep(2020, each=53), rep(2021:2023, each=52)),
        week  = c(1:53, rep(1:52, 3)), 
        index = 521 + (1:sum(num_weeks[c('2020', '2021', '2022','2023')])), # continue numbering from 2019 w52
        year_week = make_yearweek(year = year, week = week),
        sin52 = sin(2 * pi * week / 52),
        cos52 = cos(2 * pi * week / 52),
        sin26 = sin(2 * pi * week / 26),
        cos26 = cos(2 * pi * week / 26)
        )
        

set.seed(12589) 

pred.mort_2020_2023 <- ciTools::add_ci(pred.df_2020_2023, 
                                mort_trendsin2cos2,
                                names=c("lPI", "uPI"),
                                yhatName="pred_cases",
                                response=TRUE,
                                type="boot",
                                nSims=1000)


ggplot(data = mort_2010_2023) +
    geom_line(
        mapping = aes(x = year_week, y = cases),
        colour = "black",
        alpha = 0.7
    ) +
    geom_line(data=mortz,
        mapping = aes(x = year_week, y = fitted(mort_trendsin2cos2)),
        colour = "blue",
        lwd=1.0,
        alpha = 0.7
    ) +

    geom_line(data=pred.mort_2020_2023,
        mapping = aes(x = year_week, y = pred_cases),
        colour = "red",
        lwd=1.0,
        alpha = 0.7
    ) +
    geom_ribbon(data=pred.mort_2020_2023,
        mapping = aes(x = year_week, ymin = lPI, ymax = uPI),
        fill = "red",
        alpha = 0.1
    ) +
    scale_y_continuous(limits = c(0, NA)) +
    scale_x_yearweek(date_labels = "%Y-%W", date_breaks = "26 weeks") +
    labs(x = "Year Week", y = "Fitted and predicted weekly deaths",
        title = "Regression model: prediction trend, sin52, cos52, sin26, cos26 terms") +
    tsa_theme + 
    theme(axis.text.x = element_text(angle = 30, hjust = 1)) 


```




## Task 7.5 (Optional)  {#task-7-5 .unnumbered}

Compare the excess number of deaths in 2020  with those in 2018 and 2019.



## Task 7.6 (Optional)  {#task-7-6 .unnumbered}

Carry out the sam analysis for men and women. What was the total number of 
excess deaths for men and women? 

If you already have the model for each group from a previous practice, use 
that. If you did not do it before, you can assume the same model as here. 


## Save (not necessary)


```{r, task-7-save}

# save(list = ls(pattern = 'mort'), file = here("data", "mortagg2_case_7.RData"))
#load(here("data","mortagg2_case_7.RData"))
```

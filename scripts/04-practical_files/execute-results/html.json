{
  "hash": "5cf410a054d25a1c7d2be4446438ba78",
  "result": {
    "engine": "knitr",
    "markdown": "# Practical Session 4: Smoothing and Trends {.unnumbered}\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Install pacman if not installed already, and activate it\nif (!require(\"pacman\")) install.packages(\"pacman\")\n\n# Install, update and activate libraries\npacman::p_load(\n  here, \n  rio, \n  skimr,\n  tsibble,\n  ISOweek,\n  slider,    # for rolling means\n  gtsummary,\n  imputeTS, \n  pander,\n  tidyverse\n)\n\n# Create tsa_theme\ntsa_theme <- theme_bw() + \n        theme(\n            plot.title = element_text(face = \"bold\", \n                                      size = 12),\n            legend.background = element_rect(fill = \"white\", \n                                             size = 4, \n                                             colour = \"white\"),\n            # legend.justification = c(0, 1),\n            legend.position = \"bottom\",\n            panel.grid.minor = element_blank()\n        )\n```\n:::\n\n\n## Mortality Surveillance data in Spain {#title-4-1 .unnumbered}\n\nThe Spanish daily mortality monitoring system is run by the National Centre for Epidemiology in Madrid and gathers data from a stable number of municipalities around the country with a computerised death register; the system is representative of the population of Spain and was developed in 2004 with the objective of identifying exceedances in mortality during the summer period. Data since 2000 were collected retrospectively.\n\nSessions 4-7 and 11 use data from this mortality surveillance system. Session 10 uses data from the same system, but for only one autonomous community in Spain (Aragón).\n\n## Expected learning outcomes {#learn-4 .unnumbered}\n\nBy the end of the session, participants should be able to:\n\n-   Describe, test and fit a trend in surveillance data (simple smoothing and regression);\n\n-   Assess and interpret the significance of trend in surveillance data.\n\nYou are provided with a dataset in R (`mortagg.Rdata`) which includes variables on week, year, total number of deaths (`cases`), and population, as well as number of deaths and population among males and females separately.\n\n## Task 4.1 {#task-4-1 .unnumbered}\n\nAssess visually how the total registered number of deaths has been behaving in the years with available data. Save any changes to a new dataset named \\``mortagg`.\n\nDiscuss your results with your peers.\n\nHow would you proceed in analysing your data to further understand how mortality behaves?\n\n## Task 4.1.1 (Optional) {#task-4-1-1 .unnumbered}\n\nWould you reach the same conclusions if you were exploring mortality for males and females separately? Discuss with your peers.\n\n### Moving average and direct statistical modelling of trends {#task-4-1-1a .unnumbered}\n\nMoving averages are simple methods to visualise the general trend of a series after removing some of the random day-to-day variation by smoothing the data. This allows you to browse your data for periodicity and observe the general trend. In other words, smoothing the data may remove “noise” from your time series and can facilitate visual interpretation.\n\nMoving averages model a time series by calculating the numerical mean of the values adjacent to it. It is calculated for each observation, moving along the time axis: e.g. at each time $t$ and for a window of 5 time units, one way of calculating the moving average is by using the observations at $t-2$, $t-1$, $t$, $t+1$ and $t+2$.\n\n### Regression {#task-4-1-1b .unnumbered}\n\nUsing regression methods against the time variable is a simple and familiar way to look at trends and test the slope with the Wald test provided in the output. The kind of regression and interpretation you will use depends on the nature of your dependent variable – in this case, the number (count) of registered deaths.\n\n## Task 4.2 {#task-4-2 .unnumbered}\n\nAssess visually the existence of a long-term trend and periodicity in the \\``mortagg` dataset by using smoothing techniques. Where would you centre the smoothing window and why? What is the effect of using different smoothing window centring options?\n\n## Task 4.3 {#task-4-3 .unnumbered}\n\nAssess statistically whether the registered number of deaths has been stable in the years available in your dataset. How well can you model the registered number of deaths by assessing only the long-term trend?\n\n## Task 4.3.1 (Optional) {#task-4-3-1 .unnumbered}\n\nHow could you take the – potentially changing – population of Spain into account in your analyses? Data on population are provided as variables in `mortagg$pop`.\n\n## Task 4.3.2 (Optional) {#task-4-3-2 .unnumbered}\n\nIf you are confident with addressing the tasks above and still have enough time, follow the same procedure with the `dis1` dataset. Which regression models may be relevant in this example?\n\n## Help for Task 4.1 {#solution-4-1 .unnumbered}\n\nImport the `mortality.Rdata` dataset.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmortagg <- import(here(\"data\", \"mortagg.csv\"))\n```\n:::\n\n\nInspect the data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstr(mortagg)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n'data.frame':\t520 obs. of  6 variables:\n $ year   : int  2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 ...\n $ week   : int  1 2 3 4 5 6 7 8 9 10 ...\n $ cases  : int  6090 6398 6271 6023 5552 5065 4821 4732 4509 4496 ...\n $ cases_m: int  3196 3291 3263 3130 2860 2719 2555 2507 2384 2407 ...\n $ cases_f: int  2894 3107 3008 2893 2692 2346 2266 2225 2125 2089 ...\n $ pop    : int  39953520 39953520 39953520 39953520 39953520 39953520 39953520 39953520 39953520 39953520 ...\n```\n\n\n:::\n\n```{.r .cell-code}\nsummary(mortagg)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n      year           week           cases         cases_m        cases_f    \n Min.   :2000   Min.   : 1.00   Min.   :3748   Min.   :1988   Min.   :1696  \n 1st Qu.:2002   1st Qu.:13.75   1st Qu.:4283   1st Qu.:2273   1st Qu.:1997  \n Median :2004   Median :26.50   Median :4516   Median :2389   Median :2137  \n Mean   :2004   Mean   :26.50   Mean   :4657   Mean   :2458   Mean   :2198  \n 3rd Qu.:2007   3rd Qu.:39.25   3rd Qu.:4915   3rd Qu.:2591   3rd Qu.:2328  \n Max.   :2009   Max.   :52.00   Max.   :7343   Max.   :3721   Max.   :3622  \n      pop          \n Min.   :39953520  \n 1st Qu.:41423520  \n Median :43260892  \n Mean   :43273082  \n 3rd Qu.:45236004  \n Max.   :46367550  \n```\n\n\n:::\n\n```{.r .cell-code}\nview(mortagg)\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nskimr::skim(mortagg)\n```\n\n::: {.cell-output-display}\n\nTable: Data summary\n\n|                         |        |\n|:------------------------|:-------|\n|Name                     |mortagg |\n|Number of rows           |520     |\n|Number of columns        |6       |\n|_______________________  |        |\n|Column type frequency:   |        |\n|numeric                  |6       |\n|________________________ |        |\n|Group variables          |None    |\n\n\n**Variable type: numeric**\n\n|skim_variable | n_missing| complete_rate|        mean|         sd|       p0|         p25|        p50|         p75|     p100|hist  |\n|:-------------|---------:|-------------:|-----------:|----------:|--------:|-----------:|----------:|-----------:|--------:|:-----|\n|year          |         0|             1|     2004.50|       2.88|     2000|     2002.00|     2004.5|     2007.00|     2009|▇▇▇▇▇ |\n|week          |         0|             1|       26.50|      15.02|        1|       13.75|       26.5|       39.25|       52|▇▇▇▇▇ |\n|cases         |         0|             1|     4656.57|     555.52|     3748|     4283.00|     4516.5|     4915.00|     7343|▇▇▂▁▁ |\n|cases_m       |         0|             1|     2458.36|     270.83|     1988|     2272.75|     2389.0|     2591.25|     3721|▇▇▃▁▁ |\n|cases_f       |         0|             1|     2198.22|     291.34|     1696|     1997.00|     2137.0|     2328.00|     3622|▇▇▂▁▁ |\n|pop           |         0|             1| 43273082.00| 2112930.23| 39953520| 41423520.00| 43260892.5| 45236004.00| 46367550|▅▅▅▂▇ |\n\n\n:::\n:::\n\n\nCreate a time series object with `tsibble`, using the total case counts and plot it.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmortz <-\n  mortagg %>%\n  mutate(date_index = make_yearweek(year = year, week = week)) %>%\n  as_tsibble(index = date_index)\n\nggplot(data = mortz) +\n  geom_line(mapping = aes(x = date_index, y = cases)) +\n  scale_x_yearweek(date_labels = \"%Y-%W\", date_breaks = \"1 year\") +\n  labs(x = \"Date\", y = \"Number of Deaths\", title = \"Mortality\") +\n  tsa_theme\n```\n\n::: {.cell-output-display}\n![](04-practical_files/figure-html/task-4-1-mort-aggr-week-plot-tidy-1.png){width=100%}\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Adjusting y-axis scale\nggplot(data = mortz) +\n  geom_line(mapping = aes(x = date_index, y = cases)) +\n  scale_x_yearweek(date_labels = \"%Y-%W\", date_breaks = \"1 year\") +\n  scale_y_continuous(limits = c(2000, NA)) +\n  labs(x = \"Date\", y = \"Number of Deaths\", title = \"Mortality\") +\n  tsa_theme\n```\n\n::: {.cell-output-display}\n![](04-practical_files/figure-html/task-4-1-mort-aggr-week-plot2-tidy-1.png){width=100%}\n:::\n:::\n\n\n## Help for Task 4.1.1 {#solution-4-1-1 .unnumbered}\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Men and Women\nggplot(data = mortz) +\n  geom_line(mapping = aes(x = date_index, y = cases_m),\n        colour = \"green\",\n        lwd=1.1) +\n  geom_line(mapping = aes(x = date_index, y = cases_f),\n        colour = \"black\",\n        lwd=1.1) + \n  scale_x_yearweek(date_labels = \"%Y-%W\", date_breaks = \"1 year\") +\n  scale_y_continuous(limits = c(0, NA)) +\n  labs(x = \"Week\", y = \"Number of Deaths\", title = \"Spain: Number of deaths by sex\") +\n  tsa_theme\n```\n\n::: {.cell-output-display}\n![](04-practical_files/figure-html/task-opt-4-1-mort-sex-aggr-week-plots-tidy-1.png){width=100%}\n:::\n:::\n\n\n## Help for Task 4.2 {#solution-4-2 .unnumbered}\n\nAccording to the `slider` package description, `slider` is a package for rolling windows analysis. It means that a given function is repeatedly applied to different “windows” of your data as you step through it. Typical examples of applications of rolling window window functions include moving averages or cumulative sums.\n\nThe `slider` family of functions from the `slider` package contains a collection of functions specifically designed to compute a given operation on a rolling window. An introduction vignette for slider can be found by running the following command: `vignette(\"slider\")`\n\nFor each record, create the following various types of moving average.\n\n-   `MA5a`: the 5-week moving average, centred on cases.\n\n-   `MA5b`: the 5-week moving average of cases and the 4 previous weeks.\n\n-   `MA5c`: the 5-week moving average of the 5 previous weeks.\n\nCompare results.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmortzma <-\n  mortz %>%\n  mutate(\n    MA5a = slide_index_dbl(\n      .x = cases,\n      .i = date_index,\n      .f = mean,\n      na.rm = TRUE,\n      .before = 2,\n      .after = 2,\n      .complete = TRUE\n    ),\n    MA5b = slide_index_dbl(\n      .x = cases,\n      .i = date_index,\n      .f = mean,\n      na.rm = TRUE,\n      .before = 4,\n      .complete = TRUE\n    ),\n    MA5c = slide_index_dbl(\n      .x = cases,\n      .i = date_index,\n      .f = function(x) mean(x[-6], na.rm = TRUE),\n      .before = 5,\n      .complete = TRUE\n    )\n  )\n\n# view first 10 lines of data\nhead(mortzma, 10)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tsibble: 10 x 10 [1W]\n    year  week cases cases_m cases_f      pop date_index  MA5a  MA5b  MA5c\n   <int> <int> <int>   <int>   <int>    <int>     <week> <dbl> <dbl> <dbl>\n 1  2000     1  6090    3196    2894 39953520   2000 W01   NA    NA    NA \n 2  2000     2  6398    3291    3107 39953520   2000 W02   NA    NA    NA \n 3  2000     3  6271    3263    3008 39953520   2000 W03 6067.   NA    NA \n 4  2000     4  6023    3130    2893 39953520   2000 W04 5862.   NA    NA \n 5  2000     5  5552    2860    2692 39953520   2000 W05 5546. 6067.   NA \n 6  2000     6  5065    2719    2346 39953520   2000 W06 5239. 5862. 6067.\n 7  2000     7  4821    2555    2266 39953520   2000 W07 4936. 5546. 5862.\n 8  2000     8  4732    2507    2225 39953520   2000 W08 4725. 5239. 5546.\n 9  2000     9  4509    2384    2125 39953520   2000 W09 4571  4936. 5239.\n10  2000    10  4496    2407    2089 39953520   2000 W10 4465  4725. 4936.\n```\n\n\n:::\n:::\n\n\nThe `slide_index_dbl` is a `slider` package function designed to run a pre-specified function on a rolling window of a numeric (`_dbl`) variable, ordered by an index time (date or date-time) variable. A full description of this function can be found by running the following command: `?slide_index_dbl`\n\nThe `.x` argument provides the vector with the numbers that will be used for computation.\n\nThe `.i` argument defines the vector with the time variable that will be used for ordering the data.\n\nThe `.f` argument indicates the function that will be used to perform the intended computations. In this case, an arithmetic mean computation is carried out by using the `mean` function. The `na.rm = TRUE` is a varying argument included as a `...` argument of `slide_index_dbl`. (Run the expression `args(\"slide_index_dbl\")` and take notice on the position/sequence of this function's arguments).\n\nThe `.before` argument defines the number of observations before the central time point of a given time window to use in the rolling window computation. In the example above for a 5 time points centred moving average, in `MA5a`, 2 observations are used before the central point, and 2 observations are used after it, using the `.after` argument.\n\nThe `complete` argument indicates where the computation should be carried in rolling windows that have complete observations.\n\nWe applied a more complicated function to compute `MA5c`, taking a backwards moving window of six values but omitting the latest value (current time point) from the calculation of the average.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## wide format dataset ---\nggplot(data = mortzma, mapping = aes(x = date_index)) +\n  geom_line(mapping = aes(y = cases), colour = \"black\") +\n  geom_line(mapping = aes(y = MA5a), colour = \"red\") +\n  geom_line(mapping = aes(y = MA5b), colour = \"blue\") +\n  geom_line(mapping = aes(y = MA5c), colour = \"green\") +\n  scale_x_yearweek(date_labels = \"%Y-%W\", \n                   date_breaks = \"1 year\") +\n  labs(x = \"Date\", \n       y = \"Number of Deaths\", \n       title = \"Moving averages\") +\n  tsa_theme\n```\n\n::: {.cell-output-display}\n![](04-practical_files/figure-html/task-4-2-mort-MAx-plots-tidy-1.png){width=100%}\n:::\n:::\n\n\nWe observe that the calculation is similar across these various methods, but is not aligned to the series in the same way. `MA5a` is centred in the middle of the period used to calculate the mean. `MA5b` is placed at the end of the period. `MA5c` is placed one step forward (smoothing functions can be used for forecasting the following point). The \"models\" provided are similar for a 5-week window, but the *lag* is different.\n\nMoving average is only one way of smoothing. Other ways of smoothing the data to get a general idea of the trend include, for example, LOESS (locally estimated scatterplot smoothing) smoothing, where the contribution of surrounding observations is weighted, i.e. it is not the arithmetical mean for each set (window) of observations.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(mortz, mapping = aes(x = date_index, y = cases)) +\n  geom_point(alpha = 0.5) +\n  geom_smooth(se = TRUE) +\n  scale_x_yearweek(date_labels = \"%Y-%W\", \n                   date_breaks = \"1 year\") +\n  scale_y_continuous(limits = c(0, NA)) +\n  labs(x = \"Date\", \n       y = \"Number of Deaths\", \n       title = \"Loess smoothing\") +\n  tsa_theme\n```\n\n::: {.cell-output-display}\n![](04-practical_files/figure-html/task-4-2-mort-MAx-scatterplot-tidy-1.png){width=100%}\n:::\n:::\n\n\nThe `stat_smooth` provides a smoothing curve using a LOESS method. We can change the degree of smoothing by adding a `span` option. The `span` controls the amount of smoothing for the default loess smoother; smaller numbers produce wigglier lines, and larger numbers produce smoother lines.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = mortz, mapping = aes(x = date_index, y = cases)) +\n  geom_point(alpha = 0.5) +\n  geom_smooth(se = TRUE, span = 0.1) +\n  scale_x_yearweek(date_labels = \"%Y-%W\", date_breaks = \"1 year\") +\n  scale_y_continuous(limits = c(0, NA)) +\n  labs(x = \"Date\", y = \"Number of Deaths\", title = \"Loess smoothing (span = 0.1)\") +\n  tsa_theme\n```\n\n::: {.cell-output-display}\n![](04-practical_files/figure-html/task-4-2-mort-MAx-scatterplot-span-tidy-1.png){width=100%}\n:::\n:::\n\n\nTo better observe the general trend, we need to find the length of the moving average that will erase the seasonal component. Various lengths can be tried; here we have used 25, 51 and 103.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmortzma2 <-\n  mortz %>%\n  mutate(\n    MA25 = slide_index_dbl(\n      .x = cases,\n      .i = date_index,\n      .f = mean,\n      na.rm = TRUE,\n      .before = 24,\n      .complete = TRUE\n    ),\n    MA51 = slide_index_dbl(\n      .x = cases,\n      .i = date_index,\n      .f = mean,\n      na.rm = TRUE,\n      .before = 50,\n      .complete = TRUE\n    ),\n    MA103 = slide_index_dbl(\n      .x = cases,\n      .i = date_index,\n      .f = mean,\n      na.rm = TRUE,\n      .before = 102,\n      .complete = TRUE\n    )\n  )\n\n## Visually inspect data\nslice(mortzma2, 20:30)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tsibble: 11 x 10 [1W]\n    year  week cases cases_m cases_f      pop date_index  MA25  MA51 MA103\n   <int> <int> <int>   <int>   <int>    <int>     <week> <dbl> <dbl> <dbl>\n 1  2000    20  4123    2207    1916 39953520   2000 W20   NA     NA    NA\n 2  2000    21  3916    2059    1857 39953520   2000 W21   NA     NA    NA\n 3  2000    22  4295    2273    2022 39953520   2000 W22   NA     NA    NA\n 4  2000    23  4050    2168    1882 39953520   2000 W23   NA     NA    NA\n 5  2000    24  4200    2223    1977 39953520   2000 W24   NA     NA    NA\n 6  2000    25  4018    2191    1827 39953520   2000 W25 4708.    NA    NA\n 7  2000    26  4104    2146    1958 39953520   2000 W26 4628.    NA    NA\n 8  2000    27  4041    2155    1886 39953520   2000 W27 4534.    NA    NA\n 9  2000    28  3896    2096    1800 39953520   2000 W28 4439.    NA    NA\n10  2000    29  4021    2142    1879 39953520   2000 W29 4359.    NA    NA\n11  2000    30  3908    2088    1820 39953520   2000 W30 4293.    NA    NA\n```\n\n\n:::\n\n```{.r .cell-code}\nslice(mortzma2, 45:55)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tsibble: 11 x 10 [1W]\n    year  week cases cases_m cases_f      pop date_index  MA25  MA51 MA103\n   <int> <int> <int>   <int>   <int>    <int>     <week> <dbl> <dbl> <dbl>\n 1  2000    45  4399    2383    2016 39953520   2000 W45 4037.   NA     NA\n 2  2000    46  4456    2446    2010 39953520   2000 W46 4058.   NA     NA\n 3  2000    47  4462    2376    2086 39953520   2000 W47 4065.   NA     NA\n 4  2000    48  4444    2326    2118 39953520   2000 W48 4081.   NA     NA\n 5  2000    49  4271    2315    1956 39953520   2000 W49 4084.   NA     NA\n 6  2000    50  4410    2378    2032 39953520   2000 W50 4099.   NA     NA\n 7  2000    51  4521    2414    2107 39953520   2000 W51 4116  4406.    NA\n 8  2000    52  4732    2539    2193 39953520   2000 W52 4144. 4379.    NA\n 9  2001     1  4897    2635    2262 40688520   2001 W01 4184. 4350.    NA\n10  2001     2  4749    2553    2196 40688520   2001 W02 4213. 4320     NA\n11  2001     3  4668    2515    2153 40688520   2001 W03 4243. 4293.    NA\n```\n\n\n:::\n\n```{.r .cell-code}\nslice(mortzma2, 95:105)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tsibble: 11 x 10 [1W]\n    year  week cases cases_m cases_f      pop date_index  MA25  MA51 MA103\n   <int> <int> <int>   <int>   <int>    <int>     <week> <dbl> <dbl> <dbl>\n 1  2001    43  4263    2296    1967 40688520   2001 W43 4206. 4371.   NA \n 2  2001    44  4223    2265    1958 40688520   2001 W44 4199. 4367.   NA \n 3  2001    45  4286    2313    1973 40688520   2001 W45 4193. 4364.   NA \n 4  2001    46  4717    2483    2234 40688520   2001 W46 4207. 4369.   NA \n 5  2001    47  4642    2496    2146 40688520   2001 W47 4208. 4373.   NA \n 6  2001    48  4816    2546    2270 40688520   2001 W48 4229. 4383.   NA \n 7  2001    49  4723    2502    2221 40688520   2001 W49 4255  4390.   NA \n 8  2001    50  4837    2580    2257 40688520   2001 W50 4279. 4396.   NA \n 9  2001    51  5078    2753    2325 40688520   2001 W51 4303. 4403. 4407.\n10  2001    52  5559    2876    2683 40688520   2001 W52 4353. 4416. 4402.\n11  2002     1  5878    3020    2858 41423520   2002 W01 4423. 4438. 4397.\n```\n\n\n:::\n:::\n\n\nYou can use `View` to examine the first rows of `mortzma2.`\n\n\n::: {.cell}\n\n```{.r .cell-code}\nView(mortzma2)\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(mortzma2, mapping = aes(x = date_index)) +\n  geom_line(mapping = aes(y = cases), colour = \"black\", lwd=0.7) +\n  geom_line(mapping = aes(y = MA25), colour = \"red\", lwd=1.1) +\n  geom_line(mapping = aes(y = MA51), colour = \"blue\", lwd=1.1) +\n  geom_line(mapping = aes(y = MA103), colour = \"orange\", lwd=1.1) +\n  scale_x_yearweek(date_labels = \"%Y-%W\", \n                   date_breaks = \"1 year\") +\n  scale_y_continuous(limits = c(0, NA)) +\n  labs(x = \"Week\", \n       y = \"Number of deaths\", \n       title = \"Moving averages\") +\n  tsa_theme\n```\n\n::: {.cell-output-display}\n![](04-practical_files/figure-html/task-4-2-mort-MAx-longer-length-plots-tidy-1.png){width=100%}\n:::\n:::\n\n\nComment on the lines provided by the different smoothing windows. Which one do you think is the best for eliminating seasonality? What would happen if you used an even greater window?\n\n## Help for Task 4.3 {#solution-4-3 .unnumbered}\n\nUsing regression against time is a very simple way to look at the trends and test the slope with the Wald test provided.\n\nWe will use the standard `glm` function to fit a Poisson regression model.\n\nFor the regression you will need to create a date variable from the year and week (consecutive number of week).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmortz <-\n  mortz %>%\n  ungroup() %>% \n  mutate(index = seq.int(from = 1, to = nrow(.)))\n\nmort_poissontrend <- glm(\n  formula = cases ~ index,\n  family = \"poisson\",\n  data = mortz\n)\n```\n:::\n\n\nCheck model results.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(mort_poissontrend)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nglm(formula = cases ~ index, family = \"poisson\", data = mortz)\n\nCoefficients:\n             Estimate Std. Error z value Pr(>|z|)    \n(Intercept) 8.407e+00  1.300e-03 6469.40   <2e-16 ***\nindex       1.470e-04  4.282e-06   34.34   <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for poisson family taken to be 1)\n\n    Null deviance: 32912  on 519  degrees of freedom\nResidual deviance: 31732  on 518  degrees of freedom\nAIC: 37080\n\nNumber of Fisher Scoring iterations: 4\n```\n\n\n:::\n:::\n\n\nThe `glm` function fits a linear regression model to the log of the number of deaths. You can use the `names` function to see the various components of the output of the `glm` function, as above. As mentioned in the previous session, the `str` function is also often useful for looking at the \"structure\" of the output of an R function.\n\nVariables in R models are specified using notation along the lines of `response_variable ~ explanatory_variable_1 + explanatory_variable_2` etc. Check the material from the MVA module. A more detailed explanation of how to build model formulas in R can be found in the *Details* section of the help page of the `formula` function: `?stats::formula`.\n\n`summary`, when given the results of fitting a linear regression model, will provide a summary of the fitted trend and associated statistics.\n\nIdentify and interpret the intercept and the trend. In a Poisson model on the log(y), the coefficient needs to be exponentiated in order to interpret it for the output y (that is, the original y without the log).\n\nPlot the fitted values against the observed ones.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = mortz, mapping = aes(x = index)) +\n  geom_point(mapping = aes(y = cases), alpha = 0.5) +\n  geom_line(mapping = aes(y = fitted(mort_poissontrend)), colour = \"green\", lwd = 1.1) +\n  scale_y_continuous(limits = c(0, NA)) +\n  labs(x = \"Week\", y = \"Number of deaths\", title = \"Number of deaths per week with fitted trend\") +\n  tsa_theme\n```\n\n::: {.cell-output-display}\n![](04-practical_files/figure-html/task-4-3-regression-lm-plot-tidy-1.png){width=100%}\n:::\n:::\n\n\n## Help for Task 4.3.1 {#solution-4-3-1 .unnumbered}\n\nTo take the population into account, we need to include the population in the model. This is done by adding a term called `offset()`. The parameter beta for the offset, in this case for the population, will be forced to be 1; in other words, the offset will not affect the outcome. The advantage is that we can interpret the IRR of time in terms of mortality rate = cases/population.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmort_poissontrend_pop <- glm(cases ~ index + offset(log(pop)),\n  data = mortz,\n  family = \"poisson\"\n)\n\nsummary(mort_poissontrend_pop)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nglm(formula = cases ~ index + offset(log(pop)), family = \"poisson\", \n    data = mortz)\n\nCoefficients:\n              Estimate Std. Error  z value Pr(>|z|)    \n(Intercept) -9.090e+00  1.300e-03 -6990.58   <2e-16 ***\nindex       -1.764e-04  4.285e-06   -41.17   <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for poisson family taken to be 1)\n\n    Null deviance: 32147  on 519  degrees of freedom\nResidual deviance: 30452  on 518  degrees of freedom\nAIC: 35801\n\nNumber of Fisher Scoring iterations: 4\n```\n\n\n:::\n:::\n\n\nThe summary() function will only provide the coefficients in the original log scale of the poisson model. Using `tbl_regression` with the argument `exponentiate = T` we get the IRR coefficient\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmort_poissontrend_pop %>% \n  gtsummary::tbl_regression(\n    exponentiate = T,\n    estimate_fun = ~style_number(.x, digits = 4)\n  )\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div id=\"rnjnxgwubn\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#rnjnxgwubn table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#rnjnxgwubn thead, #rnjnxgwubn tbody, #rnjnxgwubn tfoot, #rnjnxgwubn tr, #rnjnxgwubn td, #rnjnxgwubn th {\n  border-style: none;\n}\n\n#rnjnxgwubn p {\n  margin: 0;\n  padding: 0;\n}\n\n#rnjnxgwubn .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#rnjnxgwubn .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#rnjnxgwubn .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#rnjnxgwubn .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#rnjnxgwubn .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#rnjnxgwubn .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#rnjnxgwubn .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#rnjnxgwubn .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#rnjnxgwubn .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#rnjnxgwubn .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#rnjnxgwubn .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#rnjnxgwubn .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#rnjnxgwubn .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#rnjnxgwubn .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#rnjnxgwubn .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#rnjnxgwubn .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#rnjnxgwubn .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#rnjnxgwubn .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#rnjnxgwubn .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#rnjnxgwubn .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#rnjnxgwubn .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#rnjnxgwubn .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#rnjnxgwubn .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#rnjnxgwubn .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#rnjnxgwubn .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#rnjnxgwubn .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#rnjnxgwubn .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#rnjnxgwubn .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#rnjnxgwubn .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#rnjnxgwubn .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#rnjnxgwubn .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#rnjnxgwubn .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#rnjnxgwubn .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#rnjnxgwubn .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#rnjnxgwubn .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#rnjnxgwubn .gt_left {\n  text-align: left;\n}\n\n#rnjnxgwubn .gt_center {\n  text-align: center;\n}\n\n#rnjnxgwubn .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#rnjnxgwubn .gt_font_normal {\n  font-weight: normal;\n}\n\n#rnjnxgwubn .gt_font_bold {\n  font-weight: bold;\n}\n\n#rnjnxgwubn .gt_font_italic {\n  font-style: italic;\n}\n\n#rnjnxgwubn .gt_super {\n  font-size: 65%;\n}\n\n#rnjnxgwubn .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#rnjnxgwubn .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#rnjnxgwubn .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#rnjnxgwubn .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#rnjnxgwubn .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#rnjnxgwubn .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#rnjnxgwubn .gt_indent_5 {\n  text-indent: 25px;\n}\n\n#rnjnxgwubn .katex-display {\n  display: inline-flex !important;\n  margin-bottom: 0.75em !important;\n}\n\n#rnjnxgwubn div.Reactable > div.rt-table > div.rt-thead > div.rt-tr.rt-tr-group-header > div.rt-th-group:after {\n  height: 0px !important;\n}\n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n  <thead>\n    <tr class=\"gt_col_headings\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"label\"><span data-qmd-base64=\"KipDaGFyYWN0ZXJpc3RpYyoq\"><span class='gt_from_md'><strong>Characteristic</strong></span></span></th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"estimate\"><span data-qmd-base64=\"KipJUlIqKg==\"><span class='gt_from_md'><strong>IRR</strong></span></span></th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"conf.low\"><span data-qmd-base64=\"Kio5NSUgQ0kqKg==\"><span class='gt_from_md'><strong>95% CI</strong></span></span></th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"p.value\"><span data-qmd-base64=\"KipwLXZhbHVlKio=\"><span class='gt_from_md'><strong>p-value</strong></span></span></th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">index</td>\n<td headers=\"estimate\" class=\"gt_row gt_center\">0.9998</td>\n<td headers=\"conf.low\" class=\"gt_row gt_center\">0.9998, 0.9998</td>\n<td headers=\"p.value\" class=\"gt_row gt_center\"><0.001</td></tr>\n  </tbody>\n  <tfoot>\n    <tr class=\"gt_sourcenotes\">\n      <td class=\"gt_sourcenote\" colspan=\"4\"><span data-qmd-base64=\"QWJicmV2aWF0aW9uczogQ0kgPSBDb25maWRlbmNlIEludGVydmFsLCBJUlIgPSBJbmNpZGVuY2UgUmF0ZSBSYXRpbw==\"><span class='gt_from_md'>Abbreviations: CI = Confidence Interval, IRR = Incidence Rate Ratio</span></span></td>\n    </tr>\n  </tfoot>\n</table>\n</div>\n```\n\n:::\n:::\n\n\nAnd plot the predicted agains the original values\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = mortz, mapping = aes(x = index)) +\n  geom_point(mapping = aes(y = cases), alpha = 0.5) +\n  geom_line(mapping = aes(y = fitted(mort_poissontrend_pop)), colour = \"blue\", lwd = 1.1) +\n  #scale_y_continuous(limits = c(0, NA)) +\n  labs(\n    x = \"Time point\", y = \"Number of Deaths\",\n    title = \"Mortality with fitted trend (Poisson)\"\n  ) +\n  tsa_theme\n```\n\n::: {.cell-output-display}\n![](04-practical_files/figure-html/task-opt-4-3-regression-pois-plot-tidy-1.png){width=100%}\n:::\n:::\n\n\n## Help for Task 4.3.2 {#solution-4-3-2 .unnumbered}\n\nYou can use the salmonellosis example (`dis1`) to see how an exponential trend might fit the data better.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsource(\"src/tidyverse/session_4.R\")\n```\n:::\n\n\nFor the regression you will still need to create a date variable from the year and week (weeknumber).\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndis1 <- import(here(\"data\", \"tsa_practice.xlsx\"), which = \"dis1\")\n\ndis1 <-\n  dis1 %>%\n  mutate(date = seq.int(from = 1, to = nrow(.)))\n```\n:::\n\n\nGenerate a new variable `lcases` as the natural logarithm of cases:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsalmo <- dis1\n\nsalmo <-\n  salmo %>%\n  mutate(lcases = log(cases))\n\nsalmoz2 <-\n  salmo %>%\n  mutate(date_index = make_yearweek(year = year, week = week)) %>%\n  as_tsibble(index = date_index)\n```\n:::\n\n\nPlot the logarithm of the number of cases according to the time:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = salmoz2, mapping = aes(x = date_index)) +\n  geom_line(mapping = aes(y = lcases)) +\n  scale_x_yearweek(date_labels = \"%Y-%W\", date_breaks = \"1 year\") +\n  scale_y_continuous(limits = c(0, NA)) +\n  labs(x = \"Year\", y = \"Cases (natural log scale)\", title = \"Log Salmonella data\") +\n  tsa_theme\n```\n\n::: {.cell-output-display}\n![](04-practical_files/figure-html/task-opt-4-3-2-plot-tidy-1.png){width=100%}\n:::\n:::\n\n\nFit a model of `lcases` against date using linear regression.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlogmodel <- lm(lcases ~ date, data = salmoz2)\nsummary(logmodel)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nlm(formula = lcases ~ date, data = salmoz2)\n\nResiduals:\n     Min       1Q   Median       3Q      Max \n-2.65732 -0.61829  0.08907  0.64319  2.60617 \n\nCoefficients:\n             Estimate Std. Error t value Pr(>|t|)    \n(Intercept) 1.0247934  0.0890767   11.51   <2e-16 ***\ndate        0.0099544  0.0003528   28.22   <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 0.89 on 417 degrees of freedom\n  (12 observations deleted due to missingness)\nMultiple R-squared:  0.6563,\tAdjusted R-squared:  0.6555 \nF-statistic: 796.2 on 1 and 417 DF,  p-value: < 2.2e-16\n```\n\n\n:::\n:::\n\n\nPlot the log data and the model against time. Note that fitted values cannot be created where the number of cases is missing. Stata seems to do linear interpolation of the fitted values to fill in the gaps, so we will do that too.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfitted_pois_df <-\n  enframe(fitted(logmodel), name = \"date\", value = \"ltrend\") %>%\n  mutate(date = as.integer(date))\n\nsalmoz2 <-\n  salmoz2 %>%\n  left_join(\n    x = .,\n    y = fitted_pois_df,\n    by = \"date\"\n  ) %>%\n  mutate(ltrend = imputeTS::na_interpolation(x = ltrend, option = \"linear\"))\n```\n:::\n\n\nWe use `is.na` as above to correctly slot the fitted values back into the time series.\n\nWe then use `na.approx`, mentioned above, to interpolate missing values.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = salmoz2, mapping = aes(x = date)) +\n  geom_line(mapping = aes(y = lcases)) +\n  geom_line(mapping = aes(y = ltrend), colour = \"green\") +\n  scale_x_yearweek(date_labels = \"%Y-%W\", date_breaks = \"1 year\") +\n  scale_y_continuous(limits = c(0, NA)) +\n  labs(\n    x = \"Time point\",\n    y = \"Log Salmonella cases\",\n    title = \"Log Salmonella data with fitted trend\"\n  ) +\n  tsa_theme\n```\n\n::: {.cell-output-display}\n![](04-practical_files/figure-html/task-opt-4-3-2-interpolate-lm-plot-tidy-1.png){width=100%}\n:::\n:::\n\n\nGenerate a new variable (`trend`), the anti-log of the prediction (`ltrend`):\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsalmoz2 <-\n  salmoz2 %>%\n  mutate(trend = exp(ltrend))\n```\n:::\n\n\nPlot the real data (`cases`) and this model (`trend`) according to time:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = salmoz2, mapping = aes(x = date)) +\n  geom_line(mapping = aes(y = cases)) +\n  geom_line(mapping = aes(y = trend), colour = \"green\") +\n  scale_x_yearweek(date_labels = \"%Y-%W\", date_breaks = \"1 year\") +\n  scale_y_continuous(limits = c(0, NA)) +\n  labs(\n    x = \"Time point\",\n    y = \"Salmonella cases\",\n    title = \"Salmonella data with fitted trend\"\n  ) +\n  tsa_theme\n```\n\n::: {.cell-output-display}\n![](04-practical_files/figure-html/task-opt-4-3-2-anti-log-plot-tidy-1.png){width=100%}\n:::\n:::\n\n\nCompare the results with those you would have got if you had used linear regression on the original data.\n\nAlternatively, you can run a Poisson or a negative binomial regression to model the data:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsalmopoismodel <- glm(cases ~ date, data = salmoz2, family = \"poisson\")\nsummary(salmopoismodel)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nglm(formula = cases ~ date, family = \"poisson\", data = salmoz2)\n\nCoefficients:\n             Estimate Std. Error z value Pr(>|z|)    \n(Intercept) 1.310e+00  2.483e-02   52.76   <2e-16 ***\ndate        1.000e-02  7.118e-05  140.55   <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for poisson family taken to be 1)\n\n    Null deviance: 40792  on 418  degrees of freedom\nResidual deviance: 12557  on 417  degrees of freedom\n  (12 observations deleted due to missingness)\nAIC: 14688\n\nNumber of Fisher Scoring iterations: 5\n```\n\n\n:::\n:::\n\n\nThere is more on using Poisson regression later on.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfitted_pois2_df <-\n  enframe(fitted(salmopoismodel), name = \"date\", value = \"trend2\") %>%\n  mutate(date = as.integer(date))\n\nsalmoz2 <-\n  salmoz2 %>%\n  left_join(\n    x = .,\n    y = fitted_pois2_df,\n    by = \"date\"\n  ) %>%\n  mutate(trend2 = imputeTS::na_interpolation(x = trend2, option = \"linear\"))\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = salmoz2, mapping = aes(x = date)) +\n  geom_line(mapping = aes(y = cases)) +\n  geom_line(mapping = aes(y = trend2), colour = \"green\") +\n  scale_x_yearweek(date_labels = \"%Y-%W\", date_breaks = \"1 year\") +\n  scale_y_continuous(limits = c(0, NA)) +\n  labs(\n    x = \"Time point\",\n    y = \"Salmonella cases\",\n    title = \"Salmonella data with fitted trend\"\n  ) +\n  tsa_theme\n```\n\n::: {.cell-output-display}\n![](04-practical_files/figure-html/task-opt-4-3-2-regression-pois-plot-tidy-1.png){width=100%}\n:::\n:::\n\n",
    "supporting": [
      "04-practical_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}
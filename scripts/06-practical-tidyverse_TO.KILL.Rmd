# Practical Session 6 {-}

## Residuals patterns in Surveillance data {-#title-6}


```{r, knitr-global-chunk-06t, include=FALSE, cache=FALSE}
rm(list=ls())

#source("_common.R")
pacman::p_load(
  here, 
  rio, 
  skimr,
  tsibble,
  tidyverse,
  TSA,
  lmtest
)

# Create tsa_theme from previous exercise to be used in ggplot.
tsa_theme <- theme_bw() + 
        theme(
            plot.title = element_text(face = "bold", 
                                      size = 12),
            legend.background = element_rect(fill = "white", 
                                             size = 4, 
                                             colour = "white"),
            # legend.justification = c(0, 1),
            legend.position = "bottom",
            panel.grid.minor = element_blank()
        )

```

## Expected learning outcomes {-#learn-6}

By the end of this session, participants should be able to:

- decide on remaining actions when modelling surveillance data after
you have accounted for trend and periodicity

- detect autocorrelation in the residuals of models on surveillance data




## Task 6.2 {-#task-6-2}

Assuming you are happy with that Poisson regression model from the previous
session, check whether this regression model was appropriate in this
case.

NEED REVISION

## Task 6.3 (Optional) {-#task-6-3}

Consider you have run the same model as above and have forgotten to include
a) long-term trends; b) periodicity parameters in it, even though they were
relevant. 

Discuss with your peers how you could detect this mistake graphically.
(No help provided).


## Help for Task 6.1 {-#solution-6-1}

Required source code.

```{r, task-6-1-source-Rscript}
#source("src/tidyverse/session_6.R")
load(here("data","mortagg2_case_5.RData"))
ls()

```



Plot the residuals from the model in case study 5 that included a trend and 52-week periodicity and 26-week periodicity. 



## Help for Task 6.2 {-#solution-6-2}

Plot the basic model with two sine and two cosine curves from Session 5:


```{r, task-6-2-calculate-residuals}

mortz <-
    mortz %>%
    mutate(res=residuals(mort_trendsin2cos2)
    )
```

```{r, task-6-2-repeat-session-3-tidy}
ggplot(data = mortz) +
    geom_point(
        mapping = aes(x = index, y = res)
    ) +
    labs(
        x = "Week",
        y = "Residuals",
        title = "Regression model with trend plus 2 sine and cosine terms"
    ) +
    tsa_theme
```

Start by examining the residuals against time. Do you see any additional patterns?




To assess whether there is any more periodicity in the data, one can produce a periodogram of the residuals (use code from case study 5).

```{r, task-6-1-periodogram}
mort_residual_period <- TSA::periodogram(mortz$res)

mort_residual_period_recip <-
    tibble(
        freq = mort_residual_period$freq,
        spec = mort_residual_period$spec
    ) %>%
    arrange(desc(spec)) %>% 
    mutate(reciprocal_freq = 1 / freq)  # here in weeks

view(mort_residual_period_recip)

# breaks every 13, equivalent to every 3 months approximately.
ggplot(data = mort_residual_period_recip, aes(x = reciprocal_freq, y = 2*spec)) +
    geom_line() +
    scale_x_continuous(limits = c(0, 160), breaks=seq(0, 160, 13)) +
    labs(x = "Period (weeks)", 
         y = "Spectral density",
         title="Periodogram residuals of model with trend plus 2 sine and cosine terms.") +
    tsa_theme

```

Plot the residuals again, but now using lines. Comment on your findings.


```{r, task-6-2-residuals-lines}
max.index <- max(mortz$index)

ggplot(data = mortz) +
    geom_line(
        mapping = aes(x = index, y = res)
    ) +
    labs(
        x = "Week",
        y = "Residuals",
        title = "Regression model with trend plus 2 sine and cosine terms"
    ) +
    scale_x_continuous(limits = c(0, max.index), breaks=seq(0, max.index, 77)) +
    tsa_theme + 
    theme(axis.text.x = element_text(angle = 30, hjust = 1)) 
    
```

Do you see a patterns that can explain the periodogram?



*Check for autocorrelation* - Note that there are `acf` functions in more than
one package, so to be sure you are using the using the base R function here use
`stats::acf`. Graph the autocorrelation on 50 (week) lags. 

```{r, task-6-2-acf-residuals-plot-tidy}

# THIS IS NOT WORKING, WITH stats:acf() or TSA::acf() /SKB
#mortacf <-
#    mortz %>%
#    fill_gaps() %>%
#    select(res) %>%
#    TSA::acf(res, lag_max = 52, type="correlation", plot=TRUE)


mort_res_acf <- acf(mortz$res, lag.max = 52, type="correlation", plot=TRUE)

mort_res_acf

# not sure necessary and cannot get it to work with TSA::acf() which is already good enough. 
#No need to complicate it.
#mort_res_acf %>%
#    autoplot() +
#    scale_x_continuous(breaks = seq(1, 50, by = 3)) +
#    labs(
#        x = "Lag (week)", y = "Autocorrelation",
#        title = "Autocorrelation of residuals model with trend plus 2 sine and cosine terms"
#    ) +
#    tsa_theme()

```


The `acf` function estimates and plots autocorrelations. The lag zero vertical line
is omitted in this plot because it is always 1, as it shows the correlation of each
observation with itself (lag zero). 
The first vertical line shows the correlation between each observation
and the observation just before it (lag one). The second shows the correlation
between each observation and the observation before last (lag two). And so on. 

The blue dotted line is the 95% confidence interval. Vertical lines which reach
above or below the confidence limits indicate significant autocorrelations, and is based on the number of observations.

If there was no autocorrelation, only the first vertical line would exceed the
confidence interval. 

The pattern shown is of "slow decay" in autocorrelation. There is also possible
evidence of periodicity.

Graph the partial autocorrelation on 50 (week) lags.

```{r, task-6-2-pacf-residuals-plot-tidy}
#mortpacf <-
#    mortz %>%
#    fill_gaps() %>%
#    select(index, cases) %>%
#    feasts::PACF(cases, lag_max = 50)

mortpacf <- stats::pacf(mortz$res, lag.max=50, plot=TRUE)

#
#mortpacf %>%
#    autoplot() +
#    scale_x_continuous(breaks = seq(1, 50, by = 3)) +
#    labs(
#        x = "Lag (week)", y = "Partial autocorrelation",
#        title = "Partial autocorrelation plot of cases"
#    ) +
#    tsa_theme()
```


You can think of partial autocorrelations as autocorrelations adjusted for the
autocorrelations in shorter lags using regression. So the partial autocorrelation
for lag two is the autocorrelation at lag two adjusted for the autocorrelation at lag
one. The partial autocorrelation at lag three is the autocorrelation at lag three
adjusted for the autocorrelations at lag two and lag one.

The main feature of interest in this plot is the positive spike at lag one. 

Test for significant autocorrelations in the residuals.

```{r, task-6-2-Ljung-Box-residuals}
Box.test(mortz$res, type = "Ljung-Box")
```

The Ljung-Box is a portmanteau-type test that examines the null hypothesis of
independence of the residuals  in a time series. A significant $p$ value suggests that there is autocorrelation in the data, that is, they are not independent. A portmanteau-type test are those where the alternative hypothesis is not well defined, but the null hypothesis (here independence) is well defined.


*Check for periodicity remaining in the residuals* - First look at the sample autocorrelations.



NEEDS CHECKING; ADD AUTOCORRELATION TO THE MODEL? CODE IS NEEDED.

```{r, task-6-2-acf-residuals-2-tidy}
#resACF <-
#    left_join(
#        x = res,
#        y = mortz %>% select(Date, date_index),
#        by = c("time_i" = "Date")
#    ) %>%
#    as_tsibble(index = date_index) %>%
#    fill_gaps() %>%
#    acf(residuals, lag_max = 50)
#
#resACF
#
#resACF %>%
#    autoplot() +
#    scale_x_continuous(breaks = seq(1, 50, by = 3)) +
#    labs(
#        x = "Lag", y = "Autocorrelation",
#        title = "Autocorrelation plot of residuals"
#    ) +
#    tsa_theme()
```


Then examine the sample partial autocorrelations.

```{r, task-6-2-pacf-residuals-2-tidy}
#resPACF <-
#    left_join(
#        x = res,
#        y = mortz %>% select(Date, date_index),
#        by = c("time_i" = "Date")
#    ) %>%
#    as_tsibble(index = date_index) %>%
#    fill_gaps() %>%
#    feasts::PACF(residuals, lag_max = 50)
#
#resPACF
#
#resPACF %>%
#    autoplot() +
#    scale_x_continuous(breaks = seq(1, 50, by = 3)) +
#    labs(
#        x = "Lag", y = "Partial autocorrelation",
#        title = "Partial autocorrelation plot of residuals"
#    ) +
#    tsa_theme()
```

What do you see? Is there any interesting pattern in the residuals that we need to account for?



```{r, task-6-save}
#save(list = ls(pattern = 'mort'), file = here("data", "mortagg2_case_6.RData"))

#load(here("data","mortagg2_case_6.RData"))

```
